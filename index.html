<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nexus Transformation Board ‚Äî The Game</title>
<style>
:root {
  --bg: #0f1218;
  --surface: #171c24;
  --surface2: #1e2430;
  --border: #2a3140;
  --text: #e8ecf1;
  --text-muted: #7d8694;
  --accent: #4a90d9;
  --blue: #2c3e6b;
  --blue-light: #3a5a9c;
  --green: #2d9d5e;
  --red: #d94a4a;
  --orange: #e8943a;
  --purple: #7b5ea7;
  --cyan: #38b2a0;
  --gray: #8b949e;
  --pattern-hex: #2c3e6b;
  --anti-hex: #d97a2a;
  --trans-hex: #7b8794;
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }

/* ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ */
.btn { padding:8px 16px; border-radius:8px; border:1px solid var(--border); background:var(--surface2); color:var(--text); font-size:13px; cursor:pointer; transition:all .15s; display:inline-flex; align-items:center; gap:6px; }
.btn:hover { border-color:var(--accent); }
.btn-primary { background:var(--accent); color:#fff; border-color:var(--accent); }
.btn-primary:hover { opacity:.9; }
.btn-sm { padding:5px 10px; font-size:12px; }
.btn-danger { background:var(--red); color:#fff; border-color:var(--red); }

/* ‚ïê‚ïê INTRO SCREEN ‚ïê‚ïê */
.intro-screen { position:fixed; inset:0; background:var(--bg); z-index:300; display:flex; align-items:center; justify-content:center; flex-direction:column; overflow:hidden; transition:opacity .6s ease; }
.intro-screen.hidden { opacity:0; pointer-events:none; }
.intro-bg-canvas { position:absolute; inset:0; z-index:0; }
.intro-content { position:relative; z-index:1; display:flex; flex-direction:column; align-items:center; gap:20px; animation:introFadeIn 1.2s ease-out; }
@keyframes introFadeIn { 0%{opacity:0;transform:translateY(30px)} 100%{opacity:1;transform:translateY(0)} }
.intro-hex-logo { width:100px; height:87px; background:linear-gradient(135deg, var(--blue-light), var(--purple), var(--cyan)); clip-path:polygon(25% 0%,75% 0%,100% 50%,75% 100%,25% 100%,0% 50%); display:flex; align-items:center; justify-content:center; font-size:38px; color:#fff; font-weight:800; letter-spacing:-2px; animation:logoFloat 4s ease-in-out infinite; box-shadow:0 0 40px rgba(74,144,217,.3); position:relative; }
.intro-hex-logo::after { content:''; position:absolute; inset:-3px; clip-path:polygon(25% 0%,75% 0%,100% 50%,75% 100%,25% 100%,0% 50%); background:linear-gradient(135deg, var(--accent), var(--purple), var(--cyan)); z-index:-1; opacity:.5; animation:logoPulse 3s ease-in-out infinite; }
@keyframes logoFloat { 0%,100%{transform:translateY(0) scale(1)} 50%{transform:translateY(-10px) scale(1.02)} }
@keyframes logoPulse { 0%,100%{opacity:.3;transform:scale(1)} 50%{opacity:.6;transform:scale(1.05)} }
.intro-title { font-size:36px; font-weight:800; background:linear-gradient(90deg,var(--accent),var(--purple),var(--cyan),var(--accent)); background-size:200% auto; -webkit-background-clip:text; -webkit-text-fill-color:transparent; text-align:center; animation:titleShimmer 4s linear infinite; letter-spacing:-.5px; }
@keyframes titleShimmer { 0%{background-position:0% center} 100%{background-position:200% center} }
.intro-sub { color:var(--text-muted); font-size:14px; text-align:center; max-width:440px; line-height:1.7; opacity:.8; }
.intro-menu { display:flex; flex-direction:column; gap:12px; width:320px; margin-top:16px; animation:menuSlideUp 1s ease-out .4s both; }
@keyframes menuSlideUp { 0%{opacity:0;transform:translateY(20px)} 100%{opacity:1;transform:translateY(0)} }
.intro-menu-btn { position:relative; padding:16px 24px; border-radius:12px; border:1px solid var(--border); background:var(--surface); color:var(--text); font-size:15px; font-weight:600; cursor:pointer; transition:all .25s ease; display:flex; align-items:center; gap:14px; overflow:hidden; }
.intro-menu-btn::before { content:''; position:absolute; inset:0; background:linear-gradient(90deg,transparent,rgba(74,144,217,.05),transparent); transform:translateX(-100%); transition:transform .5s ease; }
.intro-menu-btn:hover::before { transform:translateX(100%); }
.intro-menu-btn:hover { border-color:var(--accent); transform:translateX(4px); box-shadow:0 4px 20px rgba(74,144,217,.15); }
.intro-menu-btn .imb-icon { width:40px; height:40px; border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:18px; flex-shrink:0; }
.intro-menu-btn .imb-text { display:flex; flex-direction:column; gap:2px; text-align:left; }
.intro-menu-btn .imb-label { font-size:15px; font-weight:600; }
.intro-menu-btn .imb-desc { font-size:11px; color:var(--text-muted); font-weight:400; }
.intro-menu-btn.primary { border-color:var(--accent); background:linear-gradient(135deg,rgba(74,144,217,.12),rgba(123,94,167,.08)); }
.intro-menu-btn.primary:hover { background:linear-gradient(135deg,rgba(74,144,217,.2),rgba(123,94,167,.15)); box-shadow:0 4px 30px rgba(74,144,217,.25); }
.intro-menu-btn.continue { border-color:rgba(56,178,160,.3); background:linear-gradient(135deg,rgba(56,178,160,.08),rgba(45,157,94,.05)); }
.intro-menu-btn.continue:hover { border-color:var(--cyan); background:linear-gradient(135deg,rgba(56,178,160,.15),rgba(45,157,94,.1)); box-shadow:0 4px 30px rgba(56,178,160,.2); }
.intro-footer { margin-top:32px; color:var(--text-muted); font-size:11px; opacity:.4; animation:introFadeIn 1.5s ease-out .8s both; text-align:center; line-height:1.6; }
.intro-footer a { color:var(--accent); text-decoration:none; opacity:.7; }

/* ‚ïê‚ïê GAME SELECT SCREEN ‚ïê‚ïê */
.game-select { position:fixed; inset:0; background:var(--bg); z-index:250; display:none; overflow-y:auto; }
.game-select.show { display:flex; align-items:flex-start; justify-content:center; }
.gs-container { max-width:700px; width:100%; padding:50px 24px; animation:gsFadeIn .5s ease-out; }
@keyframes gsFadeIn { 0%{opacity:0;transform:translateY(15px)} 100%{opacity:1;transform:translateY(0)} }
.gs-header { display:flex; align-items:center; gap:16px; margin-bottom:28px; }
.gs-header h2 { font-size:24px; font-weight:700; flex:1; }
.gs-back { cursor:pointer; color:var(--text-muted); font-size:13px; display:inline-flex; align-items:center; gap:6px; padding:8px 14px; border-radius:8px; border:1px solid var(--border); background:var(--surface); transition:all .2s; }
.gs-back:hover { border-color:var(--accent); color:var(--accent); }
.gs-section-label { font-size:10px; text-transform:uppercase; letter-spacing:1.2px; color:var(--text-muted); margin-bottom:10px; font-weight:600; }
.gs-card { background:var(--surface); border:1px solid var(--border); border-radius:14px; padding:18px 22px; margin-bottom:10px; cursor:pointer; transition:all .2s ease; display:flex; justify-content:space-between; align-items:center; position:relative; overflow:hidden; }
.gs-card::before { content:''; position:absolute; inset:0; background:linear-gradient(90deg,transparent,rgba(74,144,217,.03),transparent); transform:translateX(-100%); transition:transform .4s ease; }
.gs-card:hover::before { transform:translateX(100%); }
.gs-card:hover { border-color:var(--accent); transform:translateY(-2px); box-shadow:0 6px 24px rgba(0,0,0,.3); }
.gs-card .gs-name { font-weight:600; font-size:15px; }
.gs-card .gs-meta { font-size:12px; color:var(--text-muted); margin-top:3px; }
.gs-card .gs-arrow { font-size:18px; color:var(--accent); transition:transform .2s; }
.gs-card:hover .gs-arrow { transform:translateX(4px); }
.gs-card .gs-fitness { display:flex; align-items:center; gap:10px; }
.gs-card .gs-fitness-score { font-size:22px; font-weight:800; color:var(--cyan); }
.gs-card .gs-fitness-label { font-size:9px; color:var(--text-muted); text-transform:uppercase; letter-spacing:.5px; }
.gs-divider { height:1px; background:var(--border); margin:24px 0; }
.gs-form { background:var(--surface); border:1px solid var(--border); border-radius:14px; padding:22px; margin-top:8px; }
.gs-form-title { font-size:13px; font-weight:600; margin-bottom:14px; display:flex; align-items:center; gap:8px; color:var(--text); }
.gs-form input, .gs-form textarea { width:100%; padding:10px 14px; background:var(--surface2); border:1px solid var(--border); border-radius:10px; color:var(--text); font-size:13px; margin-bottom:10px; transition:border-color .2s; }
.gs-form input:focus, .gs-form textarea:focus { outline:none; border-color:var(--accent); box-shadow:0 0 0 3px rgba(74,144,217,.1); }
.gs-form textarea { resize:vertical; min-height:50px; font-family:inherit; }
.gs-form .btn { width:100%; padding:12px; font-size:14px; font-weight:600; border-radius:10px; }
.gs-empty { text-align:center; color:var(--text-muted); padding:40px; font-size:14px; border:1px dashed var(--border); border-radius:14px; }
.gs-org-badge { display:inline-flex; align-items:center; gap:6px; padding:4px 12px; border-radius:8px; background:rgba(74,144,217,.1); border:1px solid rgba(74,144,217,.2); font-size:12px; color:var(--accent); font-weight:500; }

/* ‚ïê‚ïê HEADER ‚ïê‚ïê */
.app-header { background:linear-gradient(135deg,#171c24,#1c2233); border-bottom:1px solid var(--border); padding:10px 20px; display:flex; align-items:center; justify-content:space-between; position:sticky; top:0; z-index:100; }
.logo { display:flex; align-items:center; gap:10px; }
.logo-hex { width:36px; height:31px; background:linear-gradient(135deg,var(--blue-light),var(--purple)); clip-path:polygon(25% 0%,75% 0%,100% 50%,75% 100%,25% 100%,0% 50%); display:flex; align-items:center; justify-content:center; font-size:14px; color:#fff; font-weight:700; }
.logo h1 { font-size:16px; font-weight:600; color:var(--text); }
.logo .sub { font-size:10px; color:var(--text-muted); }
.header-center { display:flex; align-items:center; gap:10px; }
.game-name-tag { background:var(--surface2); border:1px solid var(--border); border-radius:6px; padding:4px 12px; font-size:12px; color:var(--cyan); }
.save-status { font-size:11px; color:var(--text-muted); transition:color .3s; }
.save-status.saving { color:var(--orange); }
.save-status.saved { color:var(--green); }
.header-actions { display:flex; gap:6px; }

/* ‚ïê‚ïê MAIN LAYOUT ‚ïê‚ïê */
.main-layout { display:grid; grid-template-columns:260px 1fr 260px; height:calc(100vh - 53px); }

/* ‚ïê‚ïê LEFT PANEL (TOOLBOX) ‚ïê‚ïê */
.toolbox { background:var(--surface); border-right:1px solid var(--border); overflow-y:auto; padding:14px; }
.toolbox-title { font-size:14px; font-weight:700; margin-bottom:12px; display:flex; align-items:center; gap:8px; }
.toolbox-section { margin-bottom:16px; }
.toolbox-section h3 { font-size:10px; text-transform:uppercase; letter-spacing:.8px; color:var(--text-muted); margin-bottom:8px; }
.search-input { width:100%; padding:7px 10px; background:var(--surface2); border:1px solid var(--border); border-radius:8px; color:var(--text); font-size:12px; margin-bottom:10px; }
.search-input:focus { outline:none; border-color:var(--accent); }
.filter-tabs { display:flex; gap:4px; margin-bottom:10px; }
.filter-tab { flex:1; padding:5px; text-align:center; font-size:9px; text-transform:uppercase; letter-spacing:.4px; border-radius:6px; background:var(--surface2); border:1px solid var(--border); cursor:pointer; color:var(--text-muted); transition:all .15s; }
.filter-tab.active { border-color:var(--accent); color:var(--accent); background:rgba(74,144,217,.08); }

/* ‚îÄ‚îÄ Hex cards in toolbox ‚îÄ‚îÄ */
.hex-list { display:flex; flex-direction:column; gap:5px; }
.hex-card { position:relative; display:flex; align-items:center; gap:10px; padding:8px 10px; background:var(--surface2); border:1px solid var(--border); border-radius:8px; cursor:grab; transition:all .15s; font-size:11px; }
.hex-card:hover { transform:translateY(-1px); box-shadow:0 4px 12px rgba(0,0,0,.3); }
.hex-card:active { cursor:grabbing; }
.hex-card.on-board { opacity:.35; pointer-events:none; }
.hex-mini { width:32px; height:28px; clip-path:polygon(25% 0%,75% 0%,100% 50%,75% 100%,25% 100%,0% 50%); display:flex; align-items:center; justify-content:center; font-size:8px; font-weight:700; color:#fff; flex-shrink:0; }
.hex-mini.pattern { background:var(--pattern-hex); }
.hex-mini.antipattern { background:var(--anti-hex); }
.hex-mini.transition { background:var(--trans-hex); border:1px dashed rgba(255,255,255,.3); }
.hex-card .hex-info { flex:1; min-width:0; }
.hex-card .hex-name { font-weight:600; font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.hex-card .hex-signal { color:var(--text-muted); font-size:10px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.hex-card .hex-domain { display:inline-block; padding:1px 5px; background:rgba(74,144,217,.12); color:var(--accent); border-radius:3px; font-size:8px; margin-top:2px; }

/* ‚ïê‚ïê BOARD AREA ‚ïê‚ïê */
.board-area { position:relative; overflow:auto; display:flex; flex-direction:column; }

/* Domains bar */
.board-domains { display:flex; border-bottom:1px solid var(--border); background:var(--surface); position:sticky; top:0; z-index:10; }
.domain-label { flex:1; text-align:center; padding:8px 6px; font-size:10px; font-weight:600; text-transform:uppercase; letter-spacing:.4px; color:var(--cyan); border-right:1px solid var(--border); cursor:pointer; transition:all .15s; opacity:.55; }
.domain-label:last-child { border-right:none; }
.domain-label:hover { opacity:.8; background:rgba(56,178,160,.04); }
.domain-label.active { opacity:1; background:rgba(56,178,160,.08); border-bottom:2px solid var(--cyan); }

/* Hex grid board */
.board-map { flex:1; position:relative; background:var(--bg); background-image:radial-gradient(circle at 1px 1px, rgba(255,255,255,.03) 1px, transparent 0); background-size:24px 24px; overflow:auto; }
.board-map-inner { display:grid; grid-template-columns:36px 1fr 1fr 1fr; grid-template-rows:auto 1fr 1fr; min-height:100%; position:relative; }

/* Zone column headers */
.zone-col-header { padding:8px 12px; display:flex; justify-content:center; align-items:center; border-bottom:1px solid rgba(255,255,255,.06); border-right:1px solid rgba(255,255,255,.04); }
.zone-col-header:last-child { border-right:none; }
.zone-col-header .zone-tag { font-size:10px; font-weight:600; text-transform:uppercase; letter-spacing:.5px; padding:3px 10px; border-radius:4px; }
.zone-col-header.hdr-current .zone-tag { color:var(--red); background:rgba(217,74,74,.1); }
.zone-col-header.hdr-path .zone-tag { color:var(--orange); background:rgba(232,148,58,.1); }
.zone-col-header.hdr-desired .zone-tag { color:var(--green); background:rgba(45,157,94,.1); }

/* Lane label (vertical text on the left) */
.lane-label-cell { grid-column:1; display:flex; align-items:center; justify-content:center; border-bottom:1px solid rgba(255,255,255,.06); border-right:1px solid rgba(255,255,255,.06); background:var(--surface); }
.lane-label { writing-mode:vertical-lr; transform:rotate(180deg); font-size:9px; font-weight:700; text-transform:uppercase; letter-spacing:1.2px; text-align:center; line-height:36px; white-space:nowrap; }
.lane-label.strategic { color:var(--cyan); }
.lane-label.operational { color:var(--orange); }

/* Empty top-left corner */
.lane-corner { grid-column:1; grid-row:1; border-bottom:1px solid rgba(255,255,255,.06); border-right:1px solid rgba(255,255,255,.06); background:var(--surface); display:flex; align-items:center; justify-content:center; }
.lane-corner span { font-size:7px; text-transform:uppercase; letter-spacing:.5px; color:var(--text-muted); text-align:center; line-height:1.4; }

/* Zone cells */
.board-zone { min-height:160px; position:relative; padding:4px; border-right:1px solid rgba(255,255,255,.04); border-bottom:1px solid rgba(255,255,255,.06); transition:background .2s; }
.board-zone:nth-child(3n+1) { border-right:1px solid rgba(255,255,255,.04); }

/* Gradient overlay to indicate direction */
.board-zone.zone-current { background:linear-gradient(90deg, rgba(217,74,74,.04), transparent); }
.board-zone.zone-desired { background:linear-gradient(270deg, rgba(45,157,94,.04), transparent); }

/* Hex grid inside each zone ‚Äî 4 columns of hex cells */
.zone-items { display:grid; grid-template-columns:repeat(4, 1fr); gap:4px 3px; align-content:start; padding:6px; }
/* Flat-top hexagon: wider than tall, symmetric */
.hex-cell { position:relative; aspect-ratio:1.15/1; min-width:0; }
.hex-cell-bg { position:absolute; inset:1px; clip-path:polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%); background:rgba(255,255,255,.018); border:1px dashed rgba(255,255,255,.04); transition:all .2s; display:flex; align-items:center; justify-content:center; }
.hex-cell.drag-over .hex-cell-bg { background:rgba(74,144,217,.1); border-color:rgba(74,144,217,.3); }
.hex-cell.empty .hex-cell-bg { cursor:default; }
.hex-cell.empty .hex-cell-bg::after { content:'‚¨°'; font-size:16px; color:rgba(255,255,255,.04); }

/* ‚îÄ‚îÄ Board hexagons (inside hex cells) ‚îÄ‚îÄ */
.board-hex { position:absolute; inset:1px; cursor:grab; transition:all .15s; z-index:1; }
.board-hex:hover { transform:scale(1.06); z-index:2; }
.board-hex.domain-dimmed { opacity:.15; }

.board-hex-shape { clip-path:polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%); padding:0; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; overflow:hidden; text-align:center; position:relative; }
.board-hex.pattern .board-hex-shape { background:var(--pattern-hex); }
.board-hex.antipattern .board-hex-shape { background:var(--anti-hex); }
.board-hex.transition .board-hex-shape { background:var(--trans-hex); }

/* All content centered symmetrically inside the hex safe zone */
.bh-text { display:flex; flex-direction:column; justify-content:center; align-items:center; padding:0 20%; }
.board-hex .bh-type { font-size:8px; text-transform:uppercase; letter-spacing:1px; font-weight:800; color:rgba(255,255,255,.7); }
.board-hex .bh-name { font-size:13px; font-weight:700; color:#fff; margin-top:3px; line-height:1.3; word-break:break-word; text-shadow:0 1px 3px rgba(0,0,0,.4); }
.board-hex .bh-signal { font-size:10px; color:rgba(255,255,255,.6); margin-top:3px; line-height:1.25; }
/* Icons row below text */
.bh-bottom { display:flex; gap:4px; justify-content:center; align-items:center; margin-top:4px; flex-shrink:0; }
.board-hex .remove-hex { position:absolute; top:5px; right:22%; background:none; border:none; color:rgba(255,255,255,.4); cursor:pointer; font-size:12px; z-index:2; opacity:0; transition:opacity .15s; }
.board-hex:hover .remove-hex { opacity:1; }

/* Agent badges */
.agent-badge { width:20px; height:20px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:10px; cursor:pointer; transition:opacity .15s; }
.agent-badge:hover { opacity:.7; }
.agent-badge.human { background:rgba(255,255,255,.2); }
.agent-badge.systemic { background:rgba(123,94,167,.5); }
.agent-badge.ai { background:rgba(74,144,217,.4); }

/* Axis labels */
.axis-label-left, .axis-label-right { position:absolute; top:50%; writing-mode:vertical-rl; font-size:10px; font-weight:600; letter-spacing:1px; text-transform:uppercase; z-index:5; pointer-events:none; }
.axis-label-left { left:4px; transform:translateY(-50%) rotate(180deg); color:var(--red); opacity:.5; }
.axis-label-right { right:4px; transform:translateY(-50%); color:var(--green); opacity:.5; }

/* Drivers bar */
.board-drivers { border-top:1px solid var(--border); background:var(--surface); padding:8px 14px; display:flex; align-items:center; gap:6px; flex-wrap:wrap; position:sticky; bottom:0; z-index:10; }
.driver-label { font-size:9px; text-transform:uppercase; letter-spacing:.5px; color:var(--text-muted); margin-right:4px; display:flex; align-items:center; gap:4px; }
.driver-label .bolt { color:var(--orange); font-size:14px; }
.driver-chip { padding:4px 12px; background:rgba(74,144,217,.08); border:1px solid rgba(74,144,217,.25); border-radius:16px; font-size:10px; color:var(--accent); cursor:pointer; transition:all .15s; user-select:none; }
.driver-chip:hover { background:rgba(74,144,217,.15); }
.driver-chip.selected { background:var(--orange); color:#fff; border-color:var(--orange); box-shadow:0 0 10px rgba(232,148,58,.3); }
.driver-chip.used { background:rgba(232,148,58,.1); border-color:var(--orange); color:var(--orange); }
.driver-status { font-size:10px; color:var(--orange); margin-left:6px; animation:pulse 1.5s ease-in-out infinite; }
/* Driver badges on hexes */
.bh-drivers { display:flex; flex-wrap:wrap; gap:3px; margin-top:4px; justify-content:center; }
.driver-badge { display:inline-flex; align-items:center; gap:2px; padding:2px 7px; border-radius:8px; background:rgba(0,0,0,.4); border:1px solid rgba(255,255,255,.2); font-size:8px; font-weight:600; color:#fff; cursor:pointer; white-space:nowrap; max-width:100%; overflow:hidden; text-overflow:ellipsis; }
.driver-badge:hover { background:rgba(0,0,0,.6); border-color:rgba(255,255,255,.4); }
.driver-badge .db-bolt { font-size:9px; color:var(--orange); }
/* ‚ïê‚ïê ZONE GUIDANCE (highlight correct zones during drag) ‚ïê‚ïê */
.board-zone.guide-best { box-shadow:inset 0 0 30px rgba(45,200,94,.25); border-color:rgba(45,200,94,.4); }
.board-zone.guide-best .hex-cell.empty .hex-cell-bg { background:rgba(45,200,94,.12); border-color:rgba(45,200,94,.35); }
.board-zone.guide-yes { box-shadow:inset 0 0 15px rgba(45,157,94,.1); }
.board-zone.guide-yes .hex-cell.empty .hex-cell-bg { background:rgba(45,157,94,.05); border-color:rgba(45,157,94,.15); }
.board-zone.guide-no { opacity:.35; }
/* Toast notification */
.board-toast { position:absolute; top:50px; left:50%; transform:translateX(-50%); z-index:50; padding:8px 18px; border-radius:8px; font-size:11px; font-weight:500; pointer-events:none; opacity:0; transition:opacity .3s, top .3s; white-space:nowrap; }
.board-toast.show { opacity:1; top:40px; }
.board-toast.warning { background:rgba(232,148,58,.9); color:#fff; }
.board-toast.hint { background:rgba(74,144,217,.9); color:#fff; }
/* Agent assignment hint glow on transitions */
.board-hex.agent-hint { outline:2px solid var(--purple); outline-offset:1px; animation:agentPulse 1s ease-in-out infinite; }
@keyframes agentPulse { 0%,100%{outline-color:rgba(123,94,167,.3)} 50%{outline-color:rgba(123,94,167,.7)} }

.axis-bottom { text-align:center; padding:4px; font-size:9px; color:var(--text-muted); letter-spacing:.5px; border-top:1px solid var(--border); background:var(--surface); }

/* ‚ïê‚ïê RIGHT PANEL ‚ïê‚ïê */
.dashboard { background:var(--surface); border-left:1px solid var(--border); overflow-y:auto; padding:14px; }
.dash-title { font-size:13px; font-weight:600; color:var(--text-muted); text-transform:uppercase; letter-spacing:.6px; margin-bottom:12px; }
.dash-section { margin-bottom:18px; }
.dash-section h3 { font-size:10px; text-transform:uppercase; letter-spacing:.6px; color:var(--text-muted); margin-bottom:8px; }

/* Fitness */
.fitness-score { font-size:40px; font-weight:700; text-align:center; margin:6px 0; }
.fitness-gauge { width:100%; height:16px; background:var(--surface2); border-radius:8px; overflow:hidden; margin:6px 0; }
.fitness-fill { height:100%; border-radius:8px; transition:width .5s; background:linear-gradient(90deg,var(--red),var(--orange),var(--green),var(--cyan)); }
.fitness-label { text-align:center; font-size:11px; color:var(--text-muted); }

/* Stats */
.stat-grid { display:grid; grid-template-columns:1fr 1fr; gap:6px; }
.stat-card { background:var(--surface2); border:1px solid var(--border); border-radius:8px; padding:8px; text-align:center; }
.stat-val { font-size:20px; font-weight:700; }
.stat-lbl { font-size:9px; color:var(--text-muted); text-transform:uppercase; }

/* Cycle */
.cycle-step { display:flex; align-items:center; gap:8px; padding:8px 10px; border-radius:8px; margin-bottom:4px; background:var(--surface2); border:1px solid var(--border); cursor:pointer; transition:all .15s; }
.cycle-step:hover { border-color:var(--accent); }
.cycle-step.active { border-color:var(--accent); background:rgba(74,144,217,.08); }
.cycle-step.completed { border-color:var(--green); background:rgba(45,157,94,.06); }
.cycle-icon { width:26px; height:26px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:13px; background:var(--surface); border:2px solid var(--border); flex-shrink:0; }
.cycle-step.active .cycle-icon { border-color:var(--accent); }
.cycle-step.completed .cycle-icon { border-color:var(--green); }
.cycle-name { font-size:12px; font-weight:600; }
.cycle-desc { font-size:9px; color:var(--text-muted); }

/* Agent palette */
.agent-palette { display:flex; gap:8px; justify-content:center; }
.agent-pal { display:flex; flex-direction:column; align-items:center; gap:3px; cursor:pointer; transition:all .15s; }
.agent-pal:hover { transform:scale(1.05); }
.agent-circle { width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:18px; border:2px solid var(--border); transition:border-color .15s; }
.agent-pal.selected .agent-circle { border-color:var(--accent); box-shadow:0 0 12px rgba(74,144,217,.3); }
.agent-pal .agent-label { font-size:9px; color:var(--text-muted); }
.agent-circle.human { background:rgba(200,200,200,.1); }
.agent-circle.systemic { background:rgba(123,94,167,.2); }
.agent-circle.ai { background:rgba(74,144,217,.15); }

/* Log */
.log-entry { padding:4px 8px; border-left:2px solid var(--border); margin-bottom:3px; font-size:10px; color:var(--text-muted); }
.log-entry.action { border-left-color:var(--accent); }
.log-entry.success { border-left-color:var(--green); }
.log-entry.warning { border-left-color:var(--orange); }
.log-time { font-size:8px; opacity:.5; }

/* ‚ïê‚ïê MODALS ‚ïê‚ïê */
.modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:400; display:none; align-items:center; justify-content:center; backdrop-filter:blur(4px); }
.modal-overlay.show { display:flex; }
.modal { background:var(--surface); border:1px solid var(--border); border-radius:14px; padding:28px; max-width:560px; width:90%; max-height:80vh; overflow-y:auto; }
.modal h2 { font-size:18px; margin-bottom:14px; }
.modal p { color:var(--text-muted); font-size:13px; line-height:1.6; margin-bottom:10px; }
.modal h3 { color:var(--cyan); margin:14px 0 6px; font-size:13px; }
.modal-actions { display:flex; gap:8px; justify-content:flex-end; margin-top:16px; }
.form-group { margin-bottom:14px; }
.form-group label { display:block; font-size:11px; color:var(--text-muted); margin-bottom:3px; }
.form-group input, .form-group select { width:100%; padding:7px 10px; background:var(--surface2); border:1px solid var(--border); border-radius:8px; color:var(--text); font-size:12px; }
.form-group input:focus, .form-group select:focus { outline:none; border-color:var(--accent); }

/* ‚ïê‚ïê CONNECTION MODE ‚ïê‚ïê */
.connect-toolbar { display:flex; align-items:center; gap:6px; padding:6px 14px; border-bottom:1px solid var(--border); background:var(--surface); }
.connect-toolbar .ct-label { font-size:9px; text-transform:uppercase; letter-spacing:.5px; color:var(--text-muted); margin-right:4px; display:flex; align-items:center; gap:4px; }
.connect-btn { padding:4px 12px; border-radius:16px; border:1px solid var(--border); background:var(--surface2); color:var(--text-muted); font-size:10px; cursor:pointer; transition:all .15s; display:inline-flex; align-items:center; gap:5px; }
.connect-btn:hover { border-color:var(--accent); color:var(--text); }
.connect-btn.active { background:var(--accent); color:#fff; border-color:var(--accent); }
.connect-btn .cb-icon { display:inline-block; width:20px; height:2px; position:relative; }
.connect-btn.path-btn .cb-icon { border-top:2px dashed var(--text-muted); }
.connect-btn.path-btn.active .cb-icon { border-top-color:#fff; }
.connect-btn.nexus-btn .cb-icon { border-top:2px solid var(--cyan); width:14px; height:10px; border-right:2px solid var(--cyan); border-top:none; border-left:none; border-bottom:none; }
.connect-btn.nexus-btn .cb-icon::after { content:''; position:absolute; top:-1px; right:-2px; width:14px; border-top:2px solid var(--cyan); }
.connect-status { font-size:10px; color:var(--orange); margin-left:8px; animation:pulse 1.5s ease-in-out infinite; }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.4} }

/* SVG overlay for connections */
.connections-svg { position:absolute; inset:0; width:100%; height:100%; pointer-events:none; z-index:3; overflow:visible; }
.connections-svg path { pointer-events:stroke; cursor:pointer; stroke-linecap:round; stroke-linejoin:round; }
.connections-svg .conn-path { stroke:rgba(200,200,220,.6); stroke-width:2; stroke-dasharray:8,5; fill:none; transition:stroke .15s; }
.connections-svg g:hover .conn-path { stroke:rgba(200,200,220,.9); stroke-width:2.5; }
.connections-svg .conn-nexus { stroke:var(--cyan); stroke-width:2.5; fill:none; opacity:.7; transition:opacity .15s; }
.connections-svg g:hover .conn-nexus { opacity:1; stroke-width:3; }
.connections-svg .conn-arrow { fill:rgba(200,200,220,.6); }
.connections-svg .conn-arrow-nexus { fill:var(--cyan); }
.connections-svg .conn-delete { fill:var(--red); opacity:0; cursor:pointer; pointer-events:all; transition:opacity .2s; }
.connections-svg g:hover .conn-delete { opacity:1; }
/* Invisible wider hit area for easier hovering */
.connections-svg .conn-hit { stroke:transparent; stroke-width:16; fill:none; pointer-events:stroke; cursor:pointer; }

/* Hex highlight in connect mode */
.board-hex.connect-source { outline:2px solid var(--accent); outline-offset:2px; }
.board-hex.connect-target { outline:2px dashed var(--orange); outline-offset:2px; cursor:crosshair; }
.board-hex.connect-mode { cursor:crosshair; }

/* ‚ïê‚ïê MARKERS (S2F / Capabilities) ‚ïê‚ïê */
.marker-section { margin-top:12px; }
.marker-palette { display:flex; gap:8px; justify-content:center; flex-wrap:wrap; }
.marker-pal { display:flex; flex-direction:column; align-items:center; gap:3px; cursor:pointer; transition:all .15s; }
.marker-pal:hover { transform:scale(1.05); }
.marker-circle { width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:13px; font-weight:700; border:2px solid var(--border); transition:border-color .15s; color:#fff; }
.marker-pal.selected .marker-circle { border-color:var(--accent); box-shadow:0 0 12px rgba(74,144,217,.3); }
.marker-pal .marker-label { font-size:8px; color:var(--text-muted); text-align:center; max-width:55px; }
.marker-circle.s2f { background:#8b8b8b; }
.marker-circle.capability { background:var(--cyan); }
/* Marker badges on board hexes */
.bh-markers { display:flex; gap:4px; margin-top:4px; }
.marker-badge { width:20px; height:20px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:8px; font-weight:700; color:#fff; cursor:pointer; }
.marker-badge.s2f { background:#8b8b8b; }
.marker-badge.capability { background:var(--cyan); color:#1a1a2e; }
.marker-badge:hover { opacity:.7; }

/* Scrollbar */
::-webkit-scrollbar { width:5px; }
::-webkit-scrollbar-track { background:transparent; }
::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }
</style>
</head>
<body>

<!-- ‚ïê‚ïê INTRO ‚ïê‚ïê -->
<div class="intro-screen" id="introScreen">
  <canvas class="intro-bg-canvas" id="introBgCanvas"></canvas>
  <div class="intro-content">
    <div class="intro-hex-logo">N</div>
    <div class="intro-title">Nexus Transformation Board</div>
    <div class="intro-sub">Navigate organizational transformation through strategic sensemaking. Map patterns, replace anti-patterns, and evolve toward adaptive fitness.</div>
    <div class="intro-menu" id="introMenu">
      <button class="intro-menu-btn primary" onclick="showNewGame()">
        <div class="imb-icon" style="background:linear-gradient(135deg,rgba(74,144,217,.2),rgba(123,94,167,.2));">üéØ</div>
        <div class="imb-text"><div class="imb-label">New Game</div><div class="imb-desc">Create organization &amp; start a transformation</div></div>
      </button>
      <button class="intro-menu-btn continue" onclick="showContinueGame()" id="btnContinue">
        <div class="imb-icon" style="background:linear-gradient(135deg,rgba(56,178,160,.2),rgba(45,157,94,.15));">üìÇ</div>
        <div class="imb-text"><div class="imb-label">Continue</div><div class="imb-desc">Load a saved game</div></div>
      </button>
      <button class="intro-menu-btn" onclick="showModal('howToPlayModal')">
        <div class="imb-icon" style="background:rgba(255,255,255,.05);">üìñ</div>
        <div class="imb-text"><div class="imb-label">How to Play</div><div class="imb-desc">Learn the Codex mechanics &amp; rules</div></div>
      </button>
    </div>
    <div class="intro-footer">Based on the Enterprise Transformation Codex<br><a>NTT DATA DS&A USA</a></div>
  </div>
</div>

<!-- ‚ïê‚ïê GAME SELECT ‚ïê‚ïê -->
<div class="game-select" id="gameSelect">
  <div class="gs-container" id="gsContent"></div>
</div>

<!-- ‚ïê‚ïê HOW TO PLAY ‚ïê‚ïê -->
<div class="modal-overlay" id="howToPlayModal">
  <div class="modal" style="max-width:620px;">
    <h2>How to Play the Nexus Game</h2>
    <p>The Nexus Transformation Board is a <strong>strategic sensemaking game</strong> where participants navigate organizational transformation.</p>
    <h3>The Board (Two Lanes)</h3>
    <p>The board has <strong>3 zones √ó 2 layers</strong>:</p>
    <p><strong style="color:var(--red)">Current Reality</strong> ‚Äî Where anti-patterns live. Constraints, inertia, habits.</p>
    <p><strong style="color:var(--orange)">Transformation Path</strong> ‚Äî Transitional space. Experiments and learning.</p>
    <p><strong style="color:var(--green)">Improved Fitness</strong> ‚Äî Enabling patterns and adaptive capacity.</p>
    <p style="margin-top:6px"><strong style="color:var(--cyan)">Top Lane ‚Äî Strategic</strong>: Intent, Meaning, Investment Logic (why leadership cares).</p>
    <p><strong style="color:var(--orange)">Bottom Lane ‚Äî Operational</strong>: Execution, Habits, Daily Decisions (where change happens).</p>
    <h3>The Hexagons</h3>
    <p><span style="color:#6b8fd4">Blue Hexagons</span> ‚Äî Patterns: enabling behaviors.</p>
    <p><span style="color:var(--orange)">Orange Hexagons</span> ‚Äî Anti-Patterns: constraining behaviors.</p>
    <p><span style="color:var(--gray)">Gray Hexagons</span> ‚Äî Transition Patterns: safe bridges.</p>
    <h3>Connections (Links)</h3>
    <p>Use the <strong>üîó Links</strong> toolbar above the board to draw arrows between hexagons:</p>
    <p><strong>Transition Path</strong> (dashed arrow) ‚Äî Shows the transformation journey. Typically Anti-Pattern ‚Üí Transition ‚Üí Pattern.</p>
    <p><strong>Transition Nexus</strong> (solid L-shaped arrow) ‚Äî Shows a nexus point where multiple transitions converge or branch.</p>
    <p style="font-size:11px;color:var(--text-muted)">Click a link type ‚Üí click the source hex ‚Üí click the target hex. Hover a link to see the delete button.</p>
    <h3>Board Markers</h3>
    <p><span style="color:#8b8b8b;font-weight:700">S2F</span> ‚Äî <strong>Safe to Fail Experiment</strong>: Mark a hex as an experimental probe. Small, contained tests with clear hypotheses.</p>
    <p><span style="color:var(--cyan);font-weight:700">C</span> ‚Äî <strong>Capability</strong>: Mark organizational capabilities that need to be developed or leveraged for the transformation.</p>
    <p style="font-size:11px;color:var(--text-muted)">Select a marker from the Dashboard, then click a hex. Click the badge on the hex to remove it.</p>
    <h3>The Mobius Cycle</h3>
    <p><strong>Sense ‚Üí Focus ‚Üí Experiment ‚Üí Stabilize ‚Üí Diffuse</strong>. Each phase guides your actions.</p>
    <h3>Agents of Change</h3>
    <p>üßë <strong>Human</strong> ‚Äî Leaders who legitimize change. &nbsp; üèõ <strong>Systemic</strong> ‚Äî Governance, KPIs. &nbsp; ü§ñ <strong>AI</strong> ‚Äî Automation, analytics.</p>
    <h3>Goal</h3>
    <p>There is no end state. Success = pattern migration + rising fitness score.</p>
    <div class="modal-actions"><button class="btn btn-primary" onclick="closeModal('howToPlayModal')">Got it!</button></div>
  </div>
</div>

<!-- ‚ïê‚ïê ADD PATTERN MODAL ‚ïê‚ïê -->
<div class="modal-overlay" id="addPatternModal">
  <div class="modal">
    <h2>Add Custom Pattern</h2>
    <div class="form-group"><label>Type</label><select id="newType"><option value="pattern">Pattern</option><option value="antipattern">Anti-Pattern</option><option value="transition">Transition</option></select></div>
    <div class="form-group"><label>Name</label><input id="newName" placeholder="e.g., Decentralized Decisions"></div>
    <div class="form-group"><label>Signal</label><input id="newSignal" placeholder="How you recognize it"></div>
    <div class="form-group"><label>Impact</label><input id="newImpact" placeholder="What it enables or blocks"></div>
    <div class="form-group"><label>Domain</label><select id="newDomain"><option>Strategy & Portfolio</option><option>Product & Delivery</option><option>Technology & Architecture</option><option>People, Culture & Governance</option><option>Operations</option></select></div>
    <div class="modal-actions"><button class="btn" onclick="closeModal('addPatternModal')">Cancel</button><button class="btn btn-primary" onclick="addCustomPattern()">Add</button></div>
  </div>
</div>

<!-- ‚ïê‚ïê MAIN APP ‚ïê‚ïê -->
<div id="mainApp" style="display:none">
  <header class="app-header">
    <div class="logo">
      <div class="logo-hex">N</div>
      <div><h1>Nexus Board</h1><div class="sub">Transformation Codex ‚Äî NTT DATA</div></div>
    </div>
    <div class="header-center">
      <span class="game-name-tag" id="gameNameTag">‚Äî</span>
      <span class="save-status" id="saveStatus"></span>
    </div>
    <div class="header-actions">
      <button class="btn btn-sm" onclick="showModal('howToPlayModal')">? Help</button>
      <button class="btn btn-sm" onclick="showModal('addPatternModal')">+ Pattern</button>
      <button class="btn btn-sm" onclick="switchGame()">Switch Game</button>
      <button class="btn btn-sm" onclick="resetBoard()">Reset</button>
      <button class="btn btn-sm" onclick="exportSession()">Export</button>
      <button class="btn btn-sm btn-primary" onclick="advanceCycle()">Next Phase ‚Üí</button>
    </div>
  </header>

  <div class="main-layout">
    <!-- LEFT: Toolbox -->
    <div class="toolbox">
      <div class="toolbox-title"><span style="font-size:18px">‚¨°</span> Nexus Toolbox</div>
      <input type="text" class="search-input" placeholder="Search patterns..." oninput="filterLibrary(this.value)">
      <div class="filter-tabs">
        <div class="filter-tab active" onclick="setFilter('all',this)">All</div>
        <div class="filter-tab" onclick="setFilter('pattern',this)">Patterns</div>
        <div class="filter-tab" onclick="setFilter('antipattern',this)">Anti</div>
        <div class="filter-tab" onclick="setFilter('transition',this)">Trans</div>
      </div>
      <div class="hex-list" id="libraryList"></div>
    </div>

    <!-- CENTER: Board -->
    <div class="board-area">
      <div class="board-domains" id="boardDomains"></div>
      <div class="connect-toolbar">
        <span class="ct-label">üîó Links:</span>
        <button class="connect-btn path-btn" onclick="toggleConnectMode('path')"><span class="cb-icon"></span> Transition Path</button>
        <button class="connect-btn nexus-btn" onclick="toggleConnectMode('nexus')"><span class="cb-icon"></span> Transition Nexus</button>
        <span class="connect-status" id="connectStatus" style="display:none"></span>
      </div>
      <div class="board-toast" id="boardToast"></div>
      <div class="board-map" id="boardMap">
        <div class="axis-label-left">Current Reality ¬∑ Constraints ¬∑ Inertia</div>
        <div class="axis-label-right">Improved Fitness ¬∑ Adaptive Capacity</div>
        <svg class="connections-svg" id="connectionsSvg"><defs><marker id="arrowPath" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" class="conn-arrow"/></marker><marker id="arrowNexus" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" class="conn-arrow-nexus"/></marker></defs></svg>
        <div class="board-map-inner">
          <!-- Row 0: corner + column headers -->
          <div class="lane-corner"><span>Layer /<br>Zone</span></div>
          <div class="zone-col-header hdr-current"><span class="zone-tag">‚óÄ Current Reality</span></div>
          <div class="zone-col-header hdr-path"><span class="zone-tag">‚ü∑ Transformation Path</span></div>
          <div class="zone-col-header hdr-desired"><span class="zone-tag">Improved Fitness ‚ñ∂</span></div>
          <!-- Row 1: Strategic Lane -->
          <div class="lane-label-cell"><div class="lane-label strategic">Strategic</div></div>
          <div class="board-zone zone-current"><div class="zone-items" id="zone-current_strategic-items"></div></div>
          <div class="board-zone zone-path"><div class="zone-items" id="zone-path_strategic-items"></div></div>
          <div class="board-zone zone-desired"><div class="zone-items" id="zone-desired_strategic-items"></div></div>
          <!-- Row 2: Operational Lane -->
          <div class="lane-label-cell"><div class="lane-label operational">Operational</div></div>
          <div class="board-zone zone-current"><div class="zone-items" id="zone-current_operational-items"></div></div>
          <div class="board-zone zone-path"><div class="zone-items" id="zone-path_operational-items"></div></div>
          <div class="board-zone zone-desired"><div class="zone-items" id="zone-desired_operational-items"></div></div>
        </div>
      </div>
      <div class="board-drivers" id="boardDrivers"><span class="driver-label"><span class="bolt">‚ö°</span> Drivers:</span></div>
      <div class="axis-bottom">Axis A ‚Äî Horizontal: <strong>Evolution of Capability</strong> &nbsp;‚îÇ&nbsp; Axis B ‚Äî Vertical: <strong>Strategic Intent Gradient</strong></div>
    </div>

    <!-- RIGHT: Dashboard -->
    <div class="dashboard">
      <div class="dash-title">Dashboard</div>
      <div class="dash-section">
        <h3>Organizational Fitness</h3>
        <div class="fitness-score" id="fitnessScore" style="color:var(--red)">0</div>
        <div class="fitness-gauge"><div class="fitness-fill" id="fitnessGauge" style="width:0%"></div></div>
        <div class="fitness-label" id="fitnessLabel">Fragile</div>
      </div>
      <div class="dash-section">
        <h3>Board Stats</h3>
        <div class="stat-grid">
          <div class="stat-card"><div class="stat-val" id="sP" style="color:#6b8fd4">0</div><div class="stat-lbl">Patterns</div></div>
          <div class="stat-card"><div class="stat-val" id="sA" style="color:var(--orange)">0</div><div class="stat-lbl">Anti-Patterns</div></div>
          <div class="stat-card"><div class="stat-val" id="sT" style="color:var(--gray)">0</div><div class="stat-lbl">Transitions</div></div>
          <div class="stat-card"><div class="stat-val" id="sAg" style="color:var(--purple)">0</div><div class="stat-lbl">Agents</div></div>
        </div>
      </div>
      <div class="dash-section">
        <h3>Mobius Cycle ‚Äî <span id="cycleCount">Cycle 1</span></h3>
        <div id="cycleSteps"></div>
      </div>
      <div class="dash-section">
        <h3>Agents of Change</h3>
        <p style="font-size:10px;color:var(--text-muted);margin-bottom:6px;text-align:center;">Select an agent, then click a hex on the board.</p>
        <div class="agent-palette">
          <div class="agent-pal" data-agent="human" onclick="selectAgent('human')"><div class="agent-circle human">üßë</div><div class="agent-label">Human</div></div>
          <div class="agent-pal" data-agent="systemic" onclick="selectAgent('systemic')"><div class="agent-circle systemic">üèõ</div><div class="agent-label">Systemic</div></div>
          <div class="agent-pal" data-agent="ai" onclick="selectAgent('ai')"><div class="agent-circle ai">ü§ñ</div><div class="agent-label">AI</div></div>
        </div>
      </div>
      <div class="dash-section marker-section">
        <h3>Board Markers</h3>
        <p style="font-size:10px;color:var(--text-muted);margin-bottom:6px;text-align:center;">Select a marker, then click a hex on the board.</p>
        <div class="marker-palette">
          <div class="marker-pal" data-marker="s2f" onclick="selectMarker('s2f')"><div class="marker-circle s2f">S2F</div><div class="marker-label">Safe to Fail Experiment</div></div>
          <div class="marker-pal" data-marker="capability" onclick="selectMarker('capability')"><div class="marker-circle capability">C</div><div class="marker-label">Capability</div></div>
        </div>
      </div>
      <div class="dash-section">
        <h3>Activity Log</h3>
        <div id="activityLog" style="max-height:180px;overflow-y:auto;"></div>
      </div>
    </div>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const PATTERNS = [
  {id:'p1',type:'pattern',name:'Focus on User Needs',signal:'Decisions start from user outcomes',impact:'Aligns investment with value',domain:'Strategy & Portfolio'},
  {id:'p2',type:'pattern',name:'Strategy is Iterative',signal:'Strategy reviews in short cycles',impact:'Faster course correction',domain:'Strategy & Portfolio'},
  {id:'p3',type:'pattern',name:'Use Common Language',signal:'Shared vocabulary across teams',impact:'Reduces misalignment',domain:'Strategy & Portfolio'},
  {id:'p4',type:'pattern',name:'Challenge Assumptions',signal:'Safe space to question decisions',impact:'Prevents blind spots',domain:'Strategy & Portfolio'},
  {id:'p5',type:'pattern',name:'Context Determines Pattern',signal:'No universal best practice',impact:'Right-fit solutions',domain:'Strategy & Portfolio'},
  {id:'p6',type:'pattern',name:'Portfolio as Value Flow',signal:'Prioritized by value, not project',impact:'Better capital allocation',domain:'Strategy & Portfolio'},
  {id:'p7',type:'pattern',name:'Think Small',signal:'Small batches, fast iterations',impact:'Reduces risk and waste',domain:'Product & Delivery'},
  {id:'p8',type:'pattern',name:'Optimize Flow',signal:'WIP limits, queue management',impact:'Faster delivery',domain:'Product & Delivery'},
  {id:'p9',type:'pattern',name:'Move Fast',signal:'Short cycle times, quick decisions',impact:'Competitive responsiveness',domain:'Product & Delivery'},
  {id:'p10',type:'pattern',name:'Effectiveness over Efficiency',signal:'Focus on outcomes, not output',impact:'Real value delivered',domain:'Product & Delivery'},
  {id:'p11',type:'pattern',name:'Manage Failure',signal:'Failures treated as learning',impact:'Psychological safety',domain:'Product & Delivery'},
  {id:'p12',type:'pattern',name:'Stable Teams',signal:'Teams persist across initiatives',impact:'Trust and deep expertise',domain:'Product & Delivery'},
  {id:'p13',type:'pattern',name:'Feedback Loops',signal:'Regular retrospectives with action',impact:'Continuous improvement',domain:'Product & Delivery'},
  {id:'p14',type:'pattern',name:'Use Appropriate Methods',signal:'Tools match problem complexity',impact:'Less over-engineering',domain:'Technology & Architecture'},
  {id:'p15',type:'pattern',name:'Design for Evolution',signal:'Architecture supports change',impact:'Long-term adaptability',domain:'Technology & Architecture'},
  {id:'p16',type:'pattern',name:'Set Exceptional Standards',signal:'Quality gates enforced',impact:'Reliability and trust',domain:'Technology & Architecture'},
  {id:'p17',type:'pattern',name:'Bias Towards Action',signal:'Experiment over analysis paralysis',impact:'Faster learning',domain:'Technology & Architecture'},
  {id:'p18',type:'pattern',name:'Distribute Power',signal:'Local decision authority',impact:'Speed and ownership',domain:'People, Culture & Governance'},
  {id:'p19',type:'pattern',name:'Provide Purpose & Autonomy',signal:'Teams understand the "why"',impact:'Intrinsic motivation',domain:'People, Culture & Governance'},
  {id:'p20',type:'pattern',name:'Be Transparent',signal:'Open information flow',impact:'Trust and alignment',domain:'People, Culture & Governance'},
  {id:'p21',type:'pattern',name:'No One Culture',signal:'Diverse subcultures accepted',impact:'Contextual adaptation',domain:'People, Culture & Governance'},
  {id:'p22',type:'pattern',name:'Be Humble',signal:'Leaders admit uncertainty',impact:'Psychological safety',domain:'People, Culture & Governance'},
  {id:'p23',type:'pattern',name:'Learning as a Habit',signal:'Continuous learning embedded',impact:'Organizational intelligence',domain:'People, Culture & Governance'},
  {id:'p24',type:'pattern',name:'Meaning Drives Adoption',signal:'Change connected to purpose',impact:'Genuine commitment',domain:'People, Culture & Governance'},
  {id:'p25',type:'pattern',name:'Transformation = Habit Change',signal:'Focus on behavior, not structure',impact:'Sustainable change',domain:'People, Culture & Governance'},
  {id:'p26',type:'pattern',name:'Stability Enables Change',signal:'Safe zones preserved',impact:'Immune system respected',domain:'Strategy & Portfolio'},
  {id:'p27',type:'pattern',name:'Intensity > Speed',signal:'Few changes at a time',impact:'No overload',domain:'Strategy & Portfolio'},
  {id:'p28',type:'pattern',name:'No End State',signal:'No fixed target declared',impact:'Continuous adaptation',domain:'Strategy & Portfolio'},
  {id:'p29',type:'pattern',name:'Safe-to-Fail Experiments',signal:'Protected pilots running',impact:'Learning without risk',domain:'Product & Delivery'},
  {id:'p30',type:'pattern',name:'Course Correction',signal:'Regular pivots based on evidence',impact:'Avoids sunk cost traps',domain:'Strategy & Portfolio'},
];
const ANTIPATTERNS = [
  {id:'a1',type:'antipattern',name:'Big Bang Change',signal:'Massive restructuring at once',impact:'Immune system overreaction',domain:'Strategy & Portfolio'},
  {id:'a2',type:'antipattern',name:'Ritualistic Agility',signal:'Ceremonies without learning',impact:'Agile theater, no value',domain:'Product & Delivery'},
  {id:'a3',type:'antipattern',name:'Hero Leadership',signal:'Single leader drives all change',impact:'Single point of failure',domain:'People, Culture & Governance'},
  {id:'a4',type:'antipattern',name:'Governance Theater',signal:'Approval gates without value',impact:'Slow decisions, false safety',domain:'People, Culture & Governance'},
  {id:'a5',type:'antipattern',name:'Copy-Paste Transformation',signal:"Importing another company's model",impact:'Context mismatch',domain:'Strategy & Portfolio'},
  {id:'a6',type:'antipattern',name:'Scaling Before Learning',signal:'Rolling out before validating',impact:'Amplified mistakes',domain:'Product & Delivery'},
  {id:'a7',type:'antipattern',name:'Universal Change Mandate',signal:'Everyone must change at once',impact:'Resistance and fatigue',domain:'People, Culture & Governance'},
  {id:'a8',type:'antipattern',name:'Treating Orgs as Machines',signal:'Mechanical restructuring',impact:'Ignores human dynamics',domain:'People, Culture & Governance'},
  {id:'a9',type:'antipattern',name:'Feedback Without Action',signal:'Retros happen, nothing changes',impact:'Cynicism and disengagement',domain:'Product & Delivery'},
  {id:'a10',type:'antipattern',name:'Priority Inflation',signal:'Everything is P1',impact:'Nothing gets focus',domain:'Strategy & Portfolio'},
  {id:'a11',type:'antipattern',name:'Expert Dependency',signal:'Change requires external experts',impact:'No internal capability',domain:'People, Culture & Governance'},
  {id:'a12',type:'antipattern',name:'Ignoring Power Dynamics',signal:'Informal power not addressed',impact:'Hidden blockers',domain:'People, Culture & Governance'},
  {id:'a13',type:'antipattern',name:'Speed Over Intensity',signal:'Measuring speed not absorption',impact:'Change overload',domain:'Strategy & Portfolio'},
  {id:'a14',type:'antipattern',name:'Local Optimization',signal:'Teams optimize in silos',impact:'System-level dysfunction',domain:'Product & Delivery'},
  {id:'a15',type:'antipattern',name:'Declaring End State',signal:'Fixed target announced',impact:'Rigidity, disillusionment',domain:'Strategy & Portfolio'},
  {id:'a16',type:'antipattern',name:'Blame-Driven Accountability',signal:'Failures punished, not studied',impact:'Fear-based culture',domain:'People, Culture & Governance'},
  {id:'a17',type:'antipattern',name:'Cosmetic Empowerment',signal:'Authority without support',impact:'Burnout and confusion',domain:'People, Culture & Governance'},
  {id:'a18',type:'antipattern',name:'Change Without Meaning',signal:'No narrative for why',impact:'Cynicism and resistance',domain:'People, Culture & Governance'},
  {id:'a19',type:'antipattern',name:'Portfolio as Inventory',signal:'Projects listed, not governed',impact:'No strategic alignment',domain:'Strategy & Portfolio'},
  {id:'a20',type:'antipattern',name:'Change Without Anchors',signal:'No stability zones preserved',impact:'Total disorientation',domain:'Strategy & Portfolio'},
  {id:'a21',type:'antipattern',name:'Unstable Teams',signal:'Frequent team reshuffling',impact:'No trust, no knowledge',domain:'Product & Delivery'},
  {id:'a22',type:'antipattern',name:'Ignoring Immune System',signal:'Resistance labeled dysfunction',impact:'Escalating conflict',domain:'People, Culture & Governance'},
  {id:'a23',type:'antipattern',name:'Over-Standardized Teams',signal:'Same structure forced everywhere',impact:'Context ignored',domain:'People, Culture & Governance'},
  {id:'a24',type:'antipattern',name:'Change Without Arch Readiness',signal:'Process change without tech',impact:'Friction and workarounds',domain:'Technology & Architecture'},
  {id:'a25',type:'antipattern',name:'Safety Sacrificed for Speed',signal:'Cutting corners for velocity',impact:'Technical and cultural debt',domain:'Technology & Architecture'},
];
const TRANSITIONS = [
  {id:'t1',type:'transition',name:'Opt-In Participation',signal:'Voluntary involvement',impact:'Reduces resistance',domain:'People, Culture & Governance'},
  {id:'t2',type:'transition',name:'Protected Sandbox',signal:'Isolated safe environment',impact:'Low-risk experimentation',domain:'Product & Delivery'},
  {id:'t3',type:'transition',name:'Visible Wins Broadcasting',signal:'Successes shared widely',impact:'Builds momentum',domain:'People, Culture & Governance'},
  {id:'t4',type:'transition',name:'Hypothesis-Driven Change',signal:'Explicit hypotheses tested',impact:'Evidence-based decisions',domain:'Strategy & Portfolio'},
  {id:'t5',type:'transition',name:'Community of Practice',signal:'Cross-team learning groups',impact:'Organic knowledge spread',domain:'People, Culture & Governance'},
  {id:'t6',type:'transition',name:'Pull-Based Scaling',signal:'Teams request, not imposed',impact:'Demand-driven growth',domain:'Strategy & Portfolio'},
  {id:'t7',type:'transition',name:'Evidence Walls',signal:'Data visible to all',impact:'Transparent progress',domain:'Product & Delivery'},
  {id:'t8',type:'transition',name:'Parallel Run',signal:'Old and new coexist',impact:'Safe migration',domain:'Technology & Architecture'},
  {id:'t9',type:'transition',name:'Shadow Decision Mapping',signal:'Decisions traced to authority',impact:'Power dynamics revealed',domain:'People, Culture & Governance'},
  {id:'t10',type:'transition',name:'Influencer Seeding',signal:'Key people engaged first',impact:'Social legitimacy',domain:'People, Culture & Governance'},
  {id:'t11',type:'transition',name:'Reframing Without Renaming',signal:'Same terms, new meaning',impact:'Less identity threat',domain:'People, Culture & Governance'},
  {id:'t12',type:'transition',name:'Pattern Sampling',signal:'Try before committing',impact:'Lower adoption barrier',domain:'Product & Delivery'},
  {id:'t13',type:'transition',name:'Min Viable Governance',signal:'Lightest governance that works',impact:'Speed with control',domain:'People, Culture & Governance'},
  {id:'t14',type:'transition',name:'Legacy Respect Mapping',signal:'Old system value recognized',impact:'Less defensive reaction',domain:'Strategy & Portfolio'},
  {id:'t15',type:'transition',name:'Story Before Structure',signal:'Narrative leads, not org chart',impact:'Meaningful change',domain:'People, Culture & Governance'},
  {id:'t16',type:'transition',name:'Time-Boxed Exception',signal:'Temporary relaxation of rules',impact:'Safe experimentation window',domain:'People, Culture & Governance'},
  {id:'t17',type:'transition',name:'Capability Seeding',signal:'Small capability investments',impact:'Foundation for future',domain:'Strategy & Portfolio'},
  {id:'t18',type:'transition',name:'Learning Probes',signal:'Small investigative experiments',impact:'Data before commitment',domain:'Product & Delivery'},
  {id:'t19',type:'transition',name:'Role Authority Trials',signal:'Temporary authority shifts',impact:'Test new decision models',domain:'People, Culture & Governance'},
  {id:'t20',type:'transition',name:'Identity Continuity',signal:'Change framed as evolution',impact:'Identity preserved',domain:'People, Culture & Governance'},
];
const DOMAINS = ['Strategy & Portfolio','Product & Delivery','Technology & Architecture','People, Culture & Governance','Operations'];
const DEFAULT_DRIVERS = ['Cost Efficiency','Time-to-Market','Innovation Stagnation','Customer Experience','Decision Latency','Talent Attrition','Regulatory Pressure','Change Fatigue'];
const PHASES = [{n:'Sense',i:'üëÅ',d:'Observe signals, friction, bottlenecks'},{n:'Focus',i:'üéØ',d:'Pick few habit shifts, limit scope'},{n:'Experiment',i:'üß™',d:'Small change blocks, safe-to-fail'},{n:'Stabilize',i:'üîí',d:'Lock gains, codify minimally'},{n:'Diffuse',i:'üåä',d:'Storytelling, peer adoption, pull'}];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let allItems = [...PATTERNS,...ANTIPATTERNS,...TRANSITIONS];
const ZONES = ['current_strategic','current_operational','path_strategic','path_operational','desired_strategic','desired_operational'];
let boardState = {current_strategic:[],current_operational:[],path_strategic:[],path_operational:[],desired_strategic:[],desired_operational:[]};
let driverAssignments = {}; // { hexId: ['Cost Efficiency', ...] }
let selectedDriver = null;
let currentFilter = 'all';
let searchQuery = '';
let cyclePhase = 0, cycleNumber = 1;
let completedPhases = new Set();
let selectedAgent = null;
let agentAssignments = {};
let logEntries = [];
let draggedId = null, dragSource = null;
let activeDomain = null;
// Connections: [{id, from, to, type:'path'|'nexus'}]
let connections = [];
let connectMode = null; // null | 'path' | 'nexus'
let connectFrom = null; // hex id being connected from
// Board markers: [{id, hexId, type:'s2f'|'capability', label}]
let boardMarkers = [];
// DB state
let currentGameId = null, currentCompanyId = null;
let autoSaveTimer = null;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// API LAYER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function api(method, path, body) {
  const opts = {method, headers:{'Content-Type':'application/json'}};
  if (body) opts.body = JSON.stringify(body);
  const r = await fetch('/api' + path, opts);
  if (!r.ok) { const e = await r.json().catch(()=>({})); throw new Error(e.error || r.statusText); }
  return r.json();
}
async function saveGame() {
  if (!currentGameId) return;
  showSave('saving');
  try {
    await api('PUT', `/games/${currentGameId}`, {
      board_state: boardState,
      agent_assignments: agentAssignments,
      active_drivers: driverAssignments,
      cycle_number: cycleNumber,
      cycle_phase: cyclePhase,
      completed_phases: [...completedPhases],
      log_entries: logEntries.slice(0,50),
      custom_items: allItems.filter(i=>i.id.startsWith('custom_')),
      fitness_score: parseInt(document.getElementById('fitnessScore').textContent)||0,
      connections: connections,
      board_markers: boardMarkers
    });
    showSave('saved');
  } catch(e) { showSave('error'); console.error('Save failed:',e); }
}
function scheduleAutoSave() {
  if (autoSaveTimer) clearTimeout(autoSaveTimer);
  autoSaveTimer = setTimeout(saveGame, 1500);
}
function showSave(s) {
  const el = document.getElementById('saveStatus');
  if (s==='saving') { el.textContent='Saving...'; el.className='save-status saving'; }
  else if (s==='saved') { el.textContent='Saved'; el.className='save-status saved'; setTimeout(()=>{el.textContent='';},2000); }
  else if (s==='error') { el.textContent='Save failed'; el.className='save-status'; }
}
async function loadGame(gameId) {
  const g = await api('GET', `/games/${gameId}`);
  currentGameId = g.id;
  currentCompanyId = g.company_id;
  // Migrate old 3-zone format to new 6-zone format
  const bs = g.board_state || {};
  if ('current' in bs && !('current_strategic' in bs)) {
    boardState = {current_strategic:bs.current||[],current_operational:[],path_strategic:bs.path||[],path_operational:[],desired_strategic:bs.desired||[],desired_operational:[]};
  } else {
    boardState = Object.assign(emptyBoard(), bs);
  }
  agentAssignments = g.agent_assignments || {};
  connections = g.connections || [];
  boardMarkers = g.board_markers || [];
  // Migrate old array format to new object format
  const ad = g.active_drivers || {};
  if (Array.isArray(ad)) { driverAssignments = {}; } else { driverAssignments = ad; }
  cycleNumber = g.cycle_number || 1;
  cyclePhase = g.cycle_phase || 0;
  completedPhases = new Set(g.completed_phases || []);
  logEntries = g.log_entries || [];
  (g.custom_items||[]).forEach(ci => { if (!allItems.find(i=>i.id===ci.id)) allItems.push(ci); });
  document.getElementById('gameNameTag').textContent = g.name;
  renderAll();
  addLog('Game loaded: ' + g.name, 'success');
}
function renderAll() {
  renderDomains(); renderDrivers(); renderLibrary(); renderCycleSteps(); ZONES.forEach(renderZone); updateStats(); renderLog();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GAME SELECT SCREEN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ Intro Menu: "New Game" vs "Continue" ‚îÄ‚îÄ
function showNewGame() {
  document.getElementById('introScreen').classList.add('hidden');
  document.getElementById('mainApp').style.display='none';
  document.getElementById('gameSelect').classList.add('show');
  renderNewGameFlow();
}
function showContinueGame() {
  document.getElementById('introScreen').classList.add('hidden');
  document.getElementById('mainApp').style.display='none';
  document.getElementById('gameSelect').classList.add('show');
  renderContinueFlow();
}
function showGameSelect() {
  document.getElementById('introScreen').classList.add('hidden');
  document.getElementById('mainApp').style.display='none';
  document.getElementById('gameSelect').classList.add('show');
  renderContinueFlow();
}
function switchGame() {
  document.getElementById('mainApp').style.display='none';
  document.getElementById('gameSelect').classList.add('show');
  renderContinueFlow();
}
function backToIntro() {
  document.getElementById('gameSelect').classList.remove('show');
  document.getElementById('introScreen').classList.remove('hidden');
}

// ‚îÄ‚îÄ "New Game" flow: pick or create org ‚Üí create game ‚îÄ‚îÄ
async function renderNewGameFlow() {
  const c = document.getElementById('gsContent');
  let companies = [];
  try { companies = await api('GET','/companies'); } catch(e) { console.error(e); }
  c.innerHTML = `
    <div class="gs-header">
      <div class="gs-back" onclick="backToIntro()">‚Üê Back</div>
      <h2>üéØ New Game</h2>
    </div>
    ${companies.length ? `
      <div class="gs-section-label">Select an existing organization</div>
      ${companies.map(co=>`
        <div class="gs-card" onclick="newGameForCompany('${co.id}','${co.name.replace(/'/g,"\\'")}')">
          <div><div class="gs-name">${co.name}</div><div class="gs-meta">${co.game_count} game${co.game_count!==1?'s':''} created</div></div>
          <div class="gs-arrow">‚Üí</div>
        </div>
      `).join('')}
      <div class="gs-divider"></div>
    ` : ''}
    <div class="gs-section-label">Or create a new organization</div>
    <div class="gs-form">
      <div class="gs-form-title">üè¢ New Organization</div>
      <input id="newCompName" placeholder="Organization name (e.g., NTT DATA DS&A)" autofocus>
      <input id="newCompSlug" placeholder="Slug (e.g., ntt-data-dsa)" oninput="this.value=this.value.toLowerCase().replace(/[^a-z0-9-]/g,'')">
      <button class="btn btn-primary" onclick="createCompAndGame()">Create &amp; Continue ‚Üí</button>
    </div>
  `;
}
async function newGameForCompany(id, name) {
  currentCompanyId = id;
  const c = document.getElementById('gsContent');
  c.innerHTML = `
    <div class="gs-header">
      <div class="gs-back" onclick="renderNewGameFlow()">‚Üê Back</div>
      <h2>New Game</h2>
    </div>
    <div class="gs-org-badge">üè¢ ${name}</div>
    <div style="margin-top:20px"></div>
    <div class="gs-form">
      <div class="gs-form-title">üéÆ Create Game</div>
      <input id="newGameName" placeholder="Game name (e.g., Q1 2026 Transformation Sprint)" autofocus>
      <textarea id="newGameDesc" placeholder="Description ‚Äî what transformation are you exploring? (optional)"></textarea>
      <button class="btn btn-primary" onclick="createGame('${id}')">Start Game ‚Üí</button>
    </div>
  `;
}
async function createCompAndGame() {
  const name = document.getElementById('newCompName').value.trim();
  const slug = document.getElementById('newCompSlug').value.trim();
  if (!name||!slug) { showToast('Fill in both name and slug','warning'); return; }
  try {
    const co = await api('POST','/companies',{name,slug});
    newGameForCompany(co.id, co.name);
  } catch(e) { alert(e.message); }
}

// ‚îÄ‚îÄ "Continue" flow: browse orgs ‚Üí games ‚Üí load ‚îÄ‚îÄ
async function renderContinueFlow() {
  const c = document.getElementById('gsContent');
  let companies = [];
  try { companies = await api('GET','/companies'); } catch(e) { console.error(e); }

  // Fetch all games across all companies for a unified view
  let allGames = [];
  for (const co of companies) {
    try {
      const games = await api('GET',`/companies/${co.id}/games`);
      games.forEach(g => { g._companyName = co.name; g._companyId = co.id; });
      allGames.push(...games);
    } catch(e) { /* skip */ }
  }
  allGames.sort((a,b) => new Date(b.updated_at) - new Date(a.updated_at));

  c.innerHTML = `
    <div class="gs-header">
      <div class="gs-back" onclick="backToIntro()">‚Üê Back</div>
      <h2>üìÇ Saved Games</h2>
    </div>
    ${allGames.length ? allGames.map(g => {
      const d = new Date(g.updated_at);
      const ago = timeAgo(d);
      return `<div class="gs-card" onclick="enterGame('${g.id}')">
        <div>
          <div class="gs-name">${g.name}</div>
          <div class="gs-meta">üè¢ ${g._companyName} ¬∑ Cycle ${g.cycle_number} ¬∑ ${PHASES[g.cycle_phase]?.n||'‚Äî'} ¬∑ ${ago}</div>
        </div>
        <div class="gs-fitness">
          <div><div class="gs-fitness-score">${g.fitness_score}</div><div class="gs-fitness-label">fitness</div></div>
          <div class="gs-arrow">‚Üí</div>
        </div>
      </div>`;
    }).join('') : '<div class="gs-empty">No saved games yet.<br>Start a new game from the main menu!</div>'}
  `;
}
async function createGame(companyId) {
  const name = document.getElementById('newGameName').value.trim();
  const desc = document.getElementById('newGameDesc').value.trim();
  if (!name) { showToast('Enter a game name','warning'); return; }
  try {
    const g = await api('POST',`/companies/${companyId}/games`,{name,description:desc||null});
    enterGame(g.id);
  } catch(e) { alert(e.message); }
}
async function enterGame(gameId) {
  document.getElementById('gameSelect').classList.remove('show');
  document.getElementById('mainApp').style.display='';
  // Reset state
  allItems = [...PATTERNS,...ANTIPATTERNS,...TRANSITIONS];
  boardState = emptyBoard();
  cellMap = {};
  agentAssignments = {};
  driverAssignments = {};
  connections = [];
  cyclePhase=0; cycleNumber=1; completedPhases.clear(); logEntries=[];
  await loadGame(gameId);
}
function timeAgo(date) {
  const s = Math.floor((Date.now()-date)/1000);
  if (s<60) return 'just now';
  if (s<3600) return Math.floor(s/60)+'m ago';
  if (s<86400) return Math.floor(s/3600)+'h ago';
  return Math.floor(s/86400)+'d ago';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LIBRARY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderLibrary() {
  const list = document.getElementById('libraryList');
  list.innerHTML = '';
  const q = searchQuery.toLowerCase();
  allItems.filter(item => {
    if (currentFilter!=='all' && item.type!==currentFilter) return false;
    if (activeDomain && item.domain!==activeDomain) return false;
    if (q) return item.name.toLowerCase().includes(q)||item.signal.toLowerCase().includes(q)||item.domain.toLowerCase().includes(q);
    return true;
  }).forEach(item => {
    const onBoard = isOnBoard(item.id);
    const card = document.createElement('div');
    card.className = `hex-card${onBoard?' on-board':''}`;
    card.draggable = !onBoard;
    card.innerHTML = `
      <div class="hex-mini ${item.type}">${item.type==='pattern'?'P':item.type==='antipattern'?'A':'T'}</div>
      <div class="hex-info">
        <div class="hex-name">${item.name}</div>
        <div class="hex-signal">${item.signal}</div>
        <div class="hex-domain">${item.domain}</div>
      </div>
    `;
    card.addEventListener('dragstart', e=>{draggedId=item.id;dragSource=null;e.dataTransfer.effectAllowed='move';showZoneGuidance(item.type);});
    card.addEventListener('dragend', ()=>clearZoneGuidance());
    list.appendChild(card);
  });
}
function filterLibrary(v){searchQuery=v;renderLibrary();}
function setFilter(f,el){currentFilter=f;document.querySelectorAll('.filter-tab').forEach(t=>t.classList.remove('active'));el.classList.add('active');renderLibrary();}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BOARD ZONES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const HEX_COLS = 4;
const HEX_ROWS = 5;
const HEX_CELLS_PER_ZONE = HEX_COLS * HEX_ROWS; // 20 cells per zone

// boardState[zone] is an array of item IDs (sequential).
// cellMap[zone] maps cellIndex ‚Üí itemId for free positioning.
let cellMap = {};
function buildCellMap(zone) {
  if (!cellMap[zone]) cellMap[zone] = {};
  // Place items sequentially into first available cells if not mapped
  const items = boardState[zone];
  const mapped = new Set(Object.values(cellMap[zone]));
  items.forEach(id => {
    if (!mapped.has(id)) {
      // Find first empty cell
      for (let i = 0; i < 999; i++) {
        if (!cellMap[zone][i]) { cellMap[zone][i] = id; break; }
      }
    }
  });
  // Clean stale entries (items no longer in zone)
  for (const idx in cellMap[zone]) {
    if (!items.includes(cellMap[zone][idx])) delete cellMap[zone][idx];
  }
}

function renderZone(zone) {
  buildCellMap(zone);
  const c = document.getElementById(`zone-${zone}-items`);
  c.innerHTML='';
  const items = boardState[zone];
  const totalCells = Math.max(HEX_CELLS_PER_ZONE, Object.keys(cellMap[zone]).reduce((mx,k)=>Math.max(mx,+k),0) + HEX_COLS + 1);
  for (let i = 0; i < totalCells; i++) {
    const id = cellMap[zone][i] || null;
    const cell = document.createElement('div');
    cell.className = `hex-cell${id?'':' empty'}`;
    // Drop target on each cell
    cell.addEventListener('dragover', e => { e.preventDefault(); e.dataTransfer.dropEffect='move'; cell.classList.add('drag-over'); });
    cell.addEventListener('dragleave', () => cell.classList.remove('drag-over'));
    cell.addEventListener('drop', e => {
      e.preventDefault(); e.stopPropagation(); cell.classList.remove('drag-over');
      clearZoneGuidance();
      if (!draggedId) return;
      // Check placement rules
      const itemObj = allItems.find(x=>x.id===draggedId);
      const guide = itemObj ? GUIDANCE[itemObj.type] : null;
      if (guide) {
        const allOk = [...guide.best, ...guide.ok];
        if (!allOk.includes(zone)) {
          showToast(`‚ö†Ô∏è ${guide.tip}`,'warning');
        }
      }
      // Remove from previous position
      if (dragSource) {
        boardState[dragSource] = boardState[dragSource].filter(x=>x!==draggedId);
        // Remove from cellMap
        for (const k in cellMap[dragSource]) { if (cellMap[dragSource][k]===draggedId) { delete cellMap[dragSource][k]; break; } }
      }
      // Remove if already in this zone (repositioning)
      boardState[zone] = boardState[zone].filter(x=>x!==draggedId);
      for (const k in cellMap[zone]) { if (cellMap[zone][k]===draggedId) { delete cellMap[zone][k]; break; } }
      // Place at this specific cell
      boardState[zone].push(draggedId);
      cellMap[zone][i] = draggedId;
      addLog(`${dragSource&&dragSource!==zone?'Moved':'Placed'} "${itemObj?.name}" ‚Üí ${zonePrettyName(zone)}`,'action');
      draggedId=null; dragSource=null;
      renderAllZones(); scheduleAutoSave();
    });
    // Background hex shape
    const bg = document.createElement('div');
    bg.className = 'hex-cell-bg';
    cell.appendChild(bg);
    if (id) {
      const item = allItems.find(x=>x.id===id);
      if (!item) { c.appendChild(cell); continue; }
      const dim = activeDomain && item.domain!==activeDomain ? ' domain-dimmed':'';
      const cm = connectMode ? ' connect-mode' : '';
      const cs = connectFrom===id ? ' connect-source' : '';
      const el = document.createElement('div');
      el.className = `board-hex ${item.type}${dim}${cm}${cs}`;
      el.draggable = !connectMode;
      el.setAttribute('data-hex-id', id);
      const agents = (agentAssignments[id]||[]).map(a=>`<div class="agent-badge ${a.type}" title="${a.type} agent (click to remove)" onclick="event.stopPropagation();assignAgent('${id}','${a.type}')">${a.type==='human'?'üßë':a.type==='systemic'?'üèõ':'ü§ñ'}</div>`).join('');
      const markers = boardMarkers.filter(m=>m.hexId===id).map(m=>`<div class="marker-badge ${m.type}" title="${m.type==='s2f'?'Safe to Fail Experiment':'Capability'} (click to remove)" onclick="event.stopPropagation();toggleMarker('${id}','${m.type}')">${m.type==='s2f'?'S2F':'C'}</div>`).join('');
      const drvs = (driverAssignments[id]||[]).map(d=>`<div class="driver-badge" title="${d} (click to remove)" onclick="event.stopPropagation();assignDriver('${id}','${d}')"><span class="db-bolt">‚ö°</span>${d}</div>`).join('');
      const icons = agents + markers;
      el.innerHTML = `
        <button class="remove-hex" onclick="event.stopPropagation();removeHex('${id}','${zone}')">√ó</button>
        <div class="board-hex-shape">
          <div class="bh-text">
            <div class="bh-type">${item.type==='pattern'?'PATTERN':item.type==='antipattern'?'ANTI-PATTERN':'TRANSITION'}</div>
            <div class="bh-name" title="${item.name}">${item.name}</div>
            <div class="bh-signal" title="${item.signal}">${item.signal}</div>
            ${drvs?'<div class="bh-drivers">'+drvs+'</div>':''}
          </div>
          ${icons?'<div class="bh-bottom">'+icons+'</div>':''}
        </div>
      `;
      el.addEventListener('click',()=>{
        if(connectMode){ handleConnectClick(id); return; }
        if(selectedDriver){assignDriver(id,selectedDriver);selectedDriver=null;renderDrivers();return;}
        if(selectedMarker){toggleMarker(id,selectedMarker);selectedMarker=null;document.querySelectorAll('.marker-pal').forEach(m=>m.classList.remove('selected'));return;}
        if(selectedAgent){assignAgent(id,selectedAgent);selectedAgent=null;document.querySelectorAll('.agent-pal').forEach(a=>a.classList.remove('selected'));}
      });
      el.addEventListener('dragstart',e=>{if(connectMode){e.preventDefault();return;}draggedId=id;dragSource=zone;e.dataTransfer.effectAllowed='move';showZoneGuidance(item.type);});
      el.addEventListener('dragend',()=>clearZoneGuidance());
      cell.appendChild(el);
    }
    c.appendChild(cell);
  }
  requestAnimationFrame(renderConnections);
}
function renderAllZones(){ZONES.forEach(renderZone);renderLibrary();updateStats();}
function isOnBoard(id){return ZONES.some(z=>boardState[z].includes(id));}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PLACEMENT GUIDANCE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Which zones each type SHOULD go in (Codex rules)
// Codex Core Mechanic (Section 4): Where things go on the map
// 4.1 Anti-Patterns: always LEFT, cluster bottom-left (operational = habits/inertia)
// 4.2 Patterns: center-right (rarely far right). Proven moves, not guarantees
// 4.3 Transitions: diagonally between anti-patterns & patterns. Safe moves
// 4.4 Agents: ON THE PATH, not at the destination. Forces, not owners
const GUIDANCE = {
  antipattern: {
    best: ['current_operational'],
    ok:   ['current_strategic'],
    label: 'Current Reality (bottom-left)',
    tip:   'Anti-Patterns always start left. They cluster near bottom-left ‚Äî habits, inertia, operational constraints.'
  },
  pattern: {
    best: ['path_strategic','desired_strategic'],
    ok:   ['path_operational','desired_operational'],
    label: 'Center-Right (Path ‚Üí Fitness)',
    tip:   'Patterns rarely go directly to the far right. They live center-right as proven directional moves.'
  },
  transition: {
    best: ['path_strategic','path_operational'],
    ok:   ['current_strategic','desired_operational'],
    label: 'Transformation Path (diagonally)',
    tip:   'Transitions sit between anti-patterns and patterns. Place diagonally ‚Äî they are safe bridges.'
  }
};
function showZoneGuidance(itemType) {
  const guide = GUIDANCE[itemType];
  if (!guide) return;
  const allZones = [...guide.best, ...guide.ok];
  document.querySelectorAll('.board-zone').forEach(z => {
    const zoneId = z.querySelector('.zone-items')?.id?.replace('zone-','').replace('-items','');
    if (guide.best.includes(zoneId)) z.classList.add('guide-best');
    else if (guide.ok.includes(zoneId)) z.classList.add('guide-yes');
    else z.classList.add('guide-no');
  });
}
function clearZoneGuidance() {
  document.querySelectorAll('.board-zone').forEach(z => { z.classList.remove('guide-best','guide-yes','guide-no'); });
}
let _toastTimer = null;
function showToast(msg, type='warning') {
  const el = document.getElementById('boardToast');
  el.textContent = msg;
  el.className = `board-toast ${type} show`;
  if (_toastTimer) clearTimeout(_toastTimer);
  _toastTimer = setTimeout(()=>{ el.classList.remove('show'); }, 3500);
}
function checkPlacement(itemId, zone) {
  const item = allItems.find(i=>i.id===itemId);
  if (!item) return;
  const guide = GUIDANCE[item.type];
  if (!guide) return;
  const allOk = [...guide.best, ...guide.ok];
  if (!allOk.includes(zone)) {
    showToast(`üí° ${guide.tip}`,'warning');
  } else if (guide.best.includes(zone)) {
    // Perfect placement ‚Äî no toast needed
  }
}
// 4.4 Agents: highlight hexes ON THE PATH (not destination)
function showAgentHint() {
  document.querySelectorAll('.board-hex.agent-hint').forEach(h=>h.classList.remove('agent-hint'));
  if (!selectedAgent) return;
  // Highlight hexes in path zones (where agents belong)
  ZONES.filter(z=>z.startsWith('path_')).forEach(z=>{
    boardState[z].forEach(id=>{
      const el=document.querySelector(`[data-hex-id="${id}"]`);
      if(el) el.classList.add('agent-hint');
    });
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DRAG & DROP (cell-level drops handled in renderZone)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function zonePrettyName(z){
  const map={current_strategic:'Current Reality (Strategic)',current_operational:'Current Reality (Operational)',path_strategic:'Transformation Path (Strategic)',path_operational:'Transformation Path (Operational)',desired_strategic:'Improved Fitness (Strategic)',desired_operational:'Improved Fitness (Operational)'};
  return map[z]||z;
}
function removeHex(id,zone){
  boardState[zone]=boardState[zone].filter(i=>i!==id);
  // Clean cellMap
  if (cellMap[zone]) { for (const k in cellMap[zone]) { if (cellMap[zone][k]===id) { delete cellMap[zone][k]; break; } } }
  delete agentAssignments[id];
  delete driverAssignments[id];
  boardMarkers=boardMarkers.filter(m=>m.hexId!==id);
  connections=connections.filter(c=>c.from!==id&&c.to!==id);
  const item=allItems.find(i=>i.id===id);
  addLog(`Removed "${item?.name}"`,'warning');
  renderAllZones();scheduleAutoSave();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AGENTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function selectAgent(type){
  if(selectedAgent===type){selectedAgent=null;document.querySelectorAll('.agent-pal').forEach(a=>a.classList.remove('selected'));showAgentHint();return;}
  selectedAgent=type;
  // Deselect markers and drivers when selecting agent
  selectedMarker=null; document.querySelectorAll('.marker-pal').forEach(m=>m.classList.remove('selected'));
  selectedDriver=null; renderDrivers();
  document.querySelectorAll('.agent-pal').forEach(a=>a.classList.remove('selected'));
  document.querySelector(`.agent-pal[data-agent="${type}"]`).classList.add('selected');
  showAgentHint();
  showToast('üí° Agents are placed ON THE PATH ‚Äî they represent who can activate movement, not owners','hint');
}
function assignAgent(hexId,type){
  if(!agentAssignments[hexId])agentAssignments[hexId]=[];
  if(agentAssignments[hexId].some(a=>a.type===type)){
    agentAssignments[hexId]=agentAssignments[hexId].filter(a=>a.type!==type);
    addLog(`Removed ${type} agent from "${allItems.find(i=>i.id===hexId)?.name}"`,'warning');
  } else {
    agentAssignments[hexId].push({type});
    addLog(`Assigned ${type} agent to "${allItems.find(i=>i.id===hexId)?.name}"`,'success');
  }
  showAgentHint();
  renderAllZones();scheduleAutoSave();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONNECTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleConnectMode(type) {
  if (connectMode === type) { connectMode=null; connectFrom=null; } else { connectMode=type; connectFrom=null; }
  document.querySelectorAll('.connect-btn').forEach(b=>b.classList.remove('active'));
  if (connectMode) document.querySelector(`.connect-btn.${connectMode==='path'?'path':'nexus'}-btn`).classList.add('active');
  updateConnectStatus();
  renderAllZones();
}
function updateConnectStatus() {
  const el=document.getElementById('connectStatus');
  if (!connectMode) { el.style.display='none'; return; }
  el.style.display='inline';
  if (!connectFrom) el.textContent=`Click a source hexagon to start a ${connectMode==='path'?'Transition Path':'Transition Nexus'}`;
  else { const item=allItems.find(i=>i.id===connectFrom); el.textContent=`"${item?.name}" selected ‚Äî now click the target hexagon`; }
}
function handleConnectClick(hexId) {
  if (!connectMode) return;
  if (!connectFrom) {
    connectFrom = hexId;
    updateConnectStatus();
    renderAllZones();
    return;
  }
  if (connectFrom === hexId) { connectFrom=null; updateConnectStatus(); renderAllZones(); return; }
  // Check duplicate
  if (connections.some(c=>c.from===connectFrom && c.to===hexId && c.type===connectMode)) {
    connectFrom=null; updateConnectStatus(); renderAllZones(); return;
  }
  connections.push({id:'conn_'+Date.now(), from:connectFrom, to:hexId, type:connectMode});
  const fromItem=allItems.find(i=>i.id===connectFrom);
  const toItem=allItems.find(i=>i.id===hexId);
  addLog(`Connected "${fromItem?.name}" ‚Üí "${toItem?.name}" (${connectMode==='path'?'Transition Path':'Transition Nexus'})`,'success');
  connectFrom=null;
  updateConnectStatus();
  renderAllZones();
  scheduleAutoSave();
}
function deleteConnection(connId) {
  connections = connections.filter(c=>c.id!==connId);
  addLog('Connection removed','warning');
  renderConnections();
  scheduleAutoSave();
}
// ‚îÄ‚îÄ Connection geometry helpers ‚îÄ‚îÄ
// Get hex bounding box relative to .board-map
function getHexRect(hexId) {
  const el = document.querySelector(`[data-hex-id="${hexId}"]`);
  const map = document.getElementById('boardMap');
  if (!el || !map) return null;
  const eR = el.getBoundingClientRect();
  const mR = map.getBoundingClientRect();
  const sx = map.scrollLeft, sy = map.scrollTop;
  return { x:eR.left-mR.left+sx, y:eR.top-mR.top+sy, w:eR.width, h:eR.height, cy:eR.top-mR.top+sy+eR.height/2 };
}
// ‚îÄ‚îÄ Connection routing that goes AROUND all hex cards ‚îÄ‚îÄ
function getAllHexRects(excludeIds) {
  const rects = [];
  document.querySelectorAll('[data-hex-id]').forEach(el => {
    const id = el.getAttribute('data-hex-id');
    if (excludeIds.includes(id)) return;
    const r = getHexRect(id);
    if (r) rects.push(r);
  });
  return rects;
}
function ptInRect(px, py, r, pad) {
  pad = pad === undefined ? 10 : pad;
  return px >= r.x - pad && px <= r.x + r.w + pad && py >= r.y - pad && py <= r.y + r.h + pad;
}
function segHitsAny(ax, ay, bx, by, obs, pad) {
  pad = pad === undefined ? 10 : pad;
  // Sample many points along the segment to catch all collisions
  const dist = Math.hypot(bx - ax, by - ay);
  const steps = Math.max(30, Math.ceil(dist / 5)); // 1 sample per 5px
  for (let i = 1; i < steps; i++) {
    const t = i / steps;
    const px = ax + (bx - ax) * t, py = ay + (by - ay) * t;
    for (const r of obs) { if (ptInRect(px, py, r, pad)) return true; }
  }
  return false;
}
// Anchor: always exit RIGHT edge, enter LEFT edge (consistent direction)
function getAnchor(r, toR) {
  const dx = (toR.x + toR.w / 2) - (r.x + r.w / 2);
  const dy = (toR.y + toR.h / 2) - (r.y + r.h / 2);
  if (Math.abs(dx) > Math.abs(dy) * 0.8) {
    return dx > 0
      ? { x: r.x + r.w + 2, y: r.cy }
      : { x: r.x - 2, y: r.cy };
  } else {
    return dy > 0
      ? { x: r.x + r.w / 2, y: r.y + r.h + 2 }
      : { x: r.x + r.w / 2, y: r.y - 2 };
  }
}

function buildRoute(fromR, toR, obstacles) {
  const s = getAnchor(fromR, toR);
  const e = getAnchor(toR, fromR);
  const GAP = 20; // generous clearance around obstacles

  // 1) Direct line ‚Äî if nothing in the way
  if (!segHitsAny(s.x, s.y, e.x, e.y, obstacles)) {
    return { d: `M${s.x},${s.y} L${e.x},${e.y}`, midPt: { x: (s.x + e.x) / 2, y: (s.y + e.y) / 2 } };
  }

  // 2) Find ALL blocking obstacles
  const blocking = obstacles.filter(r => segHitsAny(s.x, s.y, e.x, e.y, [r]));
  if (blocking.length === 0) {
    return { d: `M${s.x},${s.y} L${e.x},${e.y}`, midPt: { x: (s.x + e.x) / 2, y: (s.y + e.y) / 2 } };
  }

  // 3) Compute bounding box of ALL obstacles (not just blocking) in the corridor
  // This prevents routing into non-blocking hexes
  const corridorMinX = Math.min(s.x, e.x) - GAP;
  const corridorMaxX = Math.max(s.x, e.x) + GAP;
  const corridorObs = obstacles.filter(r =>
    r.x + r.w > corridorMinX && r.x < corridorMaxX
  );

  let minOY = Infinity, maxOY = -Infinity;
  let minOX = Infinity, maxOX = -Infinity;
  blocking.forEach(r => {
    minOX = Math.min(minOX, r.x);
    minOY = Math.min(minOY, r.y);
    maxOX = Math.max(maxOX, r.x + r.w);
    maxOY = Math.max(maxOY, r.y + r.h);
  });

  // 4) Try detour strategies: above and below all blockers
  const candidates = [
    // Go ABOVE: exit right ‚Üí go up ‚Üí travel horizontally above ‚Üí go down ‚Üí enter left
    [{ x: s.x, y: minOY - GAP }, { x: e.x, y: minOY - GAP }],
    // Go BELOW: exit right ‚Üí go down ‚Üí travel horizontally below ‚Üí go up ‚Üí enter left
    [{ x: s.x, y: maxOY + GAP }, { x: e.x, y: maxOY + GAP }],
  ];

  let bestPath = null, bestLen = Infinity;
  for (const [wp1, wp2] of candidates) {
    const segs = [[s, wp1], [wp1, wp2], [wp2, e]];
    let clear = true;
    for (const [a, b] of segs) {
      if (segHitsAny(a.x, a.y, b.x, b.y, corridorObs)) { clear = false; break; }
    }
    if (clear) {
      const len = Math.hypot(wp1.x - s.x, wp1.y - s.y) + Math.hypot(wp2.x - wp1.x, wp2.y - wp1.y) + Math.hypot(e.x - wp2.x, e.y - wp2.y);
      if (len < bestLen) { bestLen = len; bestPath = [s, wp1, wp2, e]; }
    }
  }

  // 5) Fallback: try wider gaps
  if (!bestPath) {
    const WIDE = GAP * 3;
    const wideCands = [
      [{ x: s.x, y: minOY - WIDE }, { x: e.x, y: minOY - WIDE }],
      [{ x: s.x, y: maxOY + WIDE }, { x: e.x, y: maxOY + WIDE }],
    ];
    for (const [wp1, wp2] of wideCands) {
      const segs = [[s, wp1], [wp1, wp2], [wp2, e]];
      let clear = true;
      for (const [a, b] of segs) {
        if (segHitsAny(a.x, a.y, b.x, b.y, obstacles)) { clear = false; break; }
      }
      if (clear) {
        const len = Math.hypot(wp1.x - s.x, wp1.y - s.y) + Math.hypot(wp2.x - wp1.x, wp2.y - wp1.y) + Math.hypot(e.x - wp2.x, e.y - wp2.y);
        if (len < bestLen) { bestLen = len; bestPath = [s, wp1, wp2, e]; }
      }
    }
  }

  // 6) Ultimate fallback ‚Äî just go direct (shouldn't happen)
  if (!bestPath) bestPath = [s, e];

  let d = `M${bestPath[0].x},${bestPath[0].y}`;
  for (let i = 1; i < bestPath.length; i++) d += ` L${bestPath[i].x},${bestPath[i].y}`;
  const mid = bestPath[Math.floor(bestPath.length / 2)];
  return { d, midPt: { x: mid.x, y: mid.y } };
}

function renderConnections() {
  const svg = document.getElementById('connectionsSvg');
  const defs = svg.querySelector('defs');
  svg.innerHTML = '';
  svg.appendChild(defs);
  const inner = document.querySelector('.board-map-inner');
  if (inner) {
    svg.setAttribute('width', inner.scrollWidth);
    svg.setAttribute('height', inner.scrollHeight);
    svg.style.width = inner.scrollWidth + 'px';
    svg.style.height = inner.scrollHeight + 'px';
  }
  connections.forEach(conn => {
    const fromR = getHexRect(conn.from);
    const toR = getHexRect(conn.to);
    if (!fromR || !toR) return;
    const obstacles = getAllHexRects([conn.from, conn.to]);
    const route = buildRoute(fromR, toR, obstacles);
    const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
    // Wider invisible hit area
    const hit = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    hit.setAttribute('d', route.d);
    hit.setAttribute('class', 'conn-hit');
    g.appendChild(hit);
    // Visible path
    const p = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    p.setAttribute('d', route.d);
    p.setAttribute('class', conn.type === 'path' ? 'conn-path' : 'conn-nexus');
    p.setAttribute('marker-end', conn.type === 'path' ? 'url(#arrowPath)' : 'url(#arrowNexus)');
    g.appendChild(p);
    // Delete button at midpoint
    const mp = route.midPt;
    const del = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    del.setAttribute('cx', mp.x); del.setAttribute('cy', mp.y);
    del.setAttribute('r', '7'); del.setAttribute('class', 'conn-delete');
    del.addEventListener('click', () => deleteConnection(conn.id));
    g.appendChild(del);
    const delX = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    delX.setAttribute('x', mp.x); delX.setAttribute('y', mp.y + 3);
    delX.setAttribute('text-anchor', 'middle'); delX.setAttribute('font-size', '9');
    delX.setAttribute('fill', '#fff'); delX.setAttribute('class', 'conn-delete');
    delX.setAttribute('style', 'pointer-events:none');
    delX.textContent = '√ó';
    g.appendChild(delX);
    svg.appendChild(g);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MARKERS (S2F / Capabilities)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let selectedMarker = null;
function selectMarker(type) {
  if (selectedMarker===type) { selectedMarker=null; document.querySelectorAll('.marker-pal').forEach(m=>m.classList.remove('selected')); return; }
  selectedMarker=type;
  // Deselect agents and drivers when selecting marker
  selectedAgent=null; document.querySelectorAll('.agent-pal').forEach(a=>a.classList.remove('selected'));
  selectedDriver=null; renderDrivers();
  document.querySelectorAll('.marker-pal').forEach(m=>m.classList.remove('selected'));
  document.querySelector(`.marker-pal[data-marker="${type}"]`).classList.add('selected');
}
function toggleMarker(hexId, type) {
  const idx = boardMarkers.findIndex(m=>m.hexId===hexId && m.type===type);
  if (idx>=0) {
    boardMarkers.splice(idx,1);
    addLog(`Removed ${type==='s2f'?'S2F Experiment':'Capability'} from "${allItems.find(i=>i.id===hexId)?.name}"`,'warning');
  } else {
    boardMarkers.push({id:'mk_'+Date.now(), hexId, type});
    addLog(`Added ${type==='s2f'?'S2F Experiment':'Capability'} to "${allItems.find(i=>i.id===hexId)?.name}"`,'success');
  }
  renderAllZones(); scheduleAutoSave();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DOMAINS & DRIVERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderDomains(){
  const c=document.getElementById('boardDomains');c.innerHTML='';
  DOMAINS.forEach(d=>{
    const el=document.createElement('div');
    el.className=`domain-label${activeDomain===d?' active':''}`;
    el.textContent=d;
    el.onclick=()=>{activeDomain=activeDomain===d?null:d;renderDomains();renderAllZones();};
    c.appendChild(el);
  });
}
function getUsedDrivers(){
  const s=new Set();
  Object.values(driverAssignments).forEach(arr=>arr.forEach(d=>s.add(d)));
  return s;
}
function renderDrivers(){
  const c=document.getElementById('boardDrivers');
  const used=getUsedDrivers();
  c.innerHTML='<span class="driver-label"><span class="bolt">‚ö°</span> Drivers:</span>';
  DEFAULT_DRIVERS.forEach(d=>{
    const ch=document.createElement('div');
    const sel=selectedDriver===d;
    const inUse=used.has(d);
    ch.className=`driver-chip${sel?' selected':''}${!sel&&inUse?' used':''}`;
    ch.textContent=d;
    ch.onclick=()=>{
      selectedDriver=selectedDriver===d?null:d;
      // Deselect agents/markers
      selectedAgent=null;document.querySelectorAll('.agent-pal').forEach(a=>a.classList.remove('selected'));
      selectedMarker=null;document.querySelectorAll('.marker-pal').forEach(m=>m.classList.remove('selected'));
      renderDrivers();updateDriverStatus();
    };
    c.appendChild(ch);
  });
  const st=document.getElementById('driverStatus');
  if(st) updateDriverStatus();
}
function updateDriverStatus(){
  let st=document.getElementById('driverStatus');
  if(!st){const c=document.getElementById('boardDrivers');st=document.createElement('span');st.id='driverStatus';st.className='driver-status';c.appendChild(st);}
  if(selectedDriver){st.style.display='inline';st.textContent=`"${selectedDriver}" selected ‚Äî click a hex to link`;}
  else{st.style.display='none';}
}
function assignDriver(hexId,driver){
  if(!driverAssignments[hexId])driverAssignments[hexId]=[];
  const idx=driverAssignments[hexId].indexOf(driver);
  if(idx>=0){
    driverAssignments[hexId].splice(idx,1);
    if(!driverAssignments[hexId].length)delete driverAssignments[hexId];
    addLog(`Unlinked "${driver}" from "${allItems.find(i=>i.id===hexId)?.name}"`,'warning');
  } else {
    driverAssignments[hexId].push(driver);
    addLog(`Linked driver "${driver}" ‚Üí "${allItems.find(i=>i.id===hexId)?.name}"`,'success');
  }
  renderAllZones();renderDrivers();scheduleAutoSave();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MOBIUS CYCLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderCycleSteps(){
  document.getElementById('cycleCount').textContent=`Cycle ${cycleNumber}`;
  document.getElementById('cycleSteps').innerHTML=PHASES.map((p,i)=>{
    let cls='cycle-step';if(i===cyclePhase)cls+=' active';if(completedPhases.has(i))cls+=' completed';
    return `<div class="${cls}" onclick="setCyclePhase(${i})"><div class="cycle-icon">${p.i}</div><div><div class="cycle-name">${p.n}</div><div class="cycle-desc">${p.d}</div></div></div>`;
  }).join('');
}
function setCyclePhase(i){cyclePhase=i;renderCycleSteps();scheduleAutoSave();}
function advanceCycle(){
  completedPhases.add(cyclePhase);
  if(cyclePhase<4){cyclePhase++;addLog(`Entered ${PHASES[cyclePhase].n} phase`,'success');}
  else{cycleNumber++;cyclePhase=0;completedPhases.clear();addLog(`Cycle ${cycleNumber-1} complete! Starting Cycle ${cycleNumber}`,'success');}
  renderCycleSteps();updateStats();scheduleAutoSave();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATS & FITNESS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateStats(){
  const all=ZONES.flatMap(z=>boardState[z]);
  const p=all.filter(id=>allItems.find(i=>i.id===id)?.type==='pattern').length;
  const a=all.filter(id=>allItems.find(i=>i.id===id)?.type==='antipattern').length;
  const t=all.filter(id=>allItems.find(i=>i.id===id)?.type==='transition').length;
  const ag=Object.values(agentAssignments).reduce((s,arr)=>s+arr.length,0);
  document.getElementById('sP').textContent=p;
  document.getElementById('sA').textContent=a;
  document.getElementById('sT').textContent=t;
  document.getElementById('sAg').textContent=ag;
  // Fitness
  let f=0;
  const desired=[...boardState.desired_strategic,...boardState.desired_operational];
  const path=[...boardState.path_strategic,...boardState.path_operational];
  const current=[...boardState.current_strategic,...boardState.current_operational];
  desired.forEach(id=>{const i=allItems.find(x=>x.id===id);if(i?.type==='pattern')f+=3;if(i?.type==='transition')f+=1;if(i?.type==='antipattern')f-=3;});
  path.forEach(id=>{const i=allItems.find(x=>x.id===id);if(i?.type==='pattern')f+=1;if(i?.type==='transition')f+=2;if(i?.type==='antipattern')f-=1;});
  current.forEach(id=>{const i=allItems.find(x=>x.id===id);if(i?.type==='antipattern')f+=.5;if(i?.type==='pattern')f+=.5;});
  const totalDriverLinks=Object.values(driverAssignments).reduce((s,arr)=>s+arr.length,0);
  f+=ag*.5+totalDriverLinks*.5+(cycleNumber-1)*2;
  f=Math.max(0,Math.min(100,Math.round(f)));
  document.getElementById('fitnessScore').textContent=f;
  document.getElementById('fitnessGauge').style.width=f+'%';
  let lbl='Fragile',col='var(--red)';
  if(f>=80){lbl='Antifragile';col='var(--cyan)';}else if(f>=60){lbl='Resilient';col='var(--green)';}else if(f>=40){lbl='Stable';col='var(--orange)';}else if(f>=20){lbl='Emerging';col='var(--orange)';}
  document.getElementById('fitnessLabel').textContent=lbl;
  document.getElementById('fitnessScore').style.color=col;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function addLog(msg,type='action'){
  const t=new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'});
  logEntries.unshift({message:msg,type,time:t});
  if(logEntries.length>50)logEntries.pop();
  renderLog();
}
function renderLog(){
  document.getElementById('activityLog').innerHTML=logEntries.slice(0,15).map(e=>`<div class="log-entry ${e.type}"><span class="log-time">${e.time}</span> ${e.message}</div>`).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CUSTOM PATTERNS, RESET, EXPORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function addCustomPattern(){
  const type=document.getElementById('newType').value;
  const name=document.getElementById('newName').value.trim();
  if(!name)return;
  allItems.push({id:'custom_'+Date.now(),type,name,signal:document.getElementById('newSignal').value.trim()||'Custom',impact:document.getElementById('newImpact').value.trim()||'Custom',domain:document.getElementById('newDomain').value});
  addLog(`Created custom ${type}: "${name}"`,'success');
  renderLibrary();closeModal('addPatternModal');
  document.getElementById('newName').value='';document.getElementById('newSignal').value='';document.getElementById('newImpact').value='';
  scheduleAutoSave();
}
function emptyBoard(){return {current_strategic:[],current_operational:[],path_strategic:[],path_operational:[],desired_strategic:[],desired_operational:[]};}
function resetBoard(){
  if(!confirm('Reset the entire board?'))return;
  boardState=emptyBoard();cellMap={};agentAssignments={};driverAssignments={};connections=[];boardMarkers=[];cyclePhase=0;cycleNumber=1;completedPhases.clear();logEntries=[];
  renderAll();addLog('Board reset','warning');scheduleAutoSave();
}
function exportSession(){
  const data={timestamp:new Date().toISOString(),gameId:currentGameId,boardState,connections,agentAssignments,driverAssignments,cycleNumber,cyclePhase,fitness:document.getElementById('fitnessScore').textContent,log:logEntries.slice(0,30),customItems:allItems.filter(i=>i.id.startsWith('custom_'))};
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`nexus-${new Date().toISOString().slice(0,10)}.json`;a.click();
  addLog('Session exported','success');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODALS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showModal(id){document.getElementById(id).classList.add('show');}
function closeModal(id){document.getElementById(id).classList.remove('show');}
document.querySelectorAll('.modal-overlay').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('show');}));

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INTRO CANVAS ‚Äî Floating hex particles
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(function initIntroCanvas() {
  const canvas = document.getElementById('introBgCanvas');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  let w, h, particles = [];
  const COLORS = ['rgba(74,144,217,.12)','rgba(123,94,167,.1)','rgba(56,178,160,.08)','rgba(232,148,58,.06)'];

  function resize() {
    w = canvas.width = window.innerWidth;
    h = canvas.height = window.innerHeight;
  }
  window.addEventListener('resize', resize);
  resize();

  function hexPath(ctx, x, y, r) {
    ctx.beginPath();
    for (let i = 0; i < 6; i++) {
      const a = Math.PI / 3 * i - Math.PI / 6;
      const px = x + r * Math.cos(a), py = y + r * Math.sin(a);
      i === 0 ? ctx.moveTo(px, py) : ctx.lineTo(px, py);
    }
    ctx.closePath();
  }

  // Create particles
  for (let i = 0; i < 30; i++) {
    particles.push({
      x: Math.random() * w,
      y: Math.random() * h,
      r: 8 + Math.random() * 28,
      vx: (Math.random() - 0.5) * 0.3,
      vy: (Math.random() - 0.5) * 0.2 - 0.1,
      rot: Math.random() * Math.PI,
      vr: (Math.random() - 0.5) * 0.003,
      color: COLORS[Math.floor(Math.random() * COLORS.length)],
      alpha: 0.3 + Math.random() * 0.5
    });
  }

  let animId;
  function draw() {
    ctx.clearRect(0, 0, w, h);
    particles.forEach(p => {
      p.x += p.vx; p.y += p.vy; p.rot += p.vr;
      if (p.x < -50) p.x = w + 50;
      if (p.x > w + 50) p.x = -50;
      if (p.y < -50) p.y = h + 50;
      if (p.y > h + 50) p.y = -50;

      ctx.save();
      ctx.translate(p.x, p.y);
      ctx.rotate(p.rot);
      ctx.globalAlpha = p.alpha;
      hexPath(ctx, 0, 0, p.r);
      ctx.fillStyle = p.color;
      ctx.fill();
      ctx.strokeStyle = p.color.replace(/[\d.]+\)$/, (parseFloat(p.color.match(/[\d.]+\)$/)[0]) * 2) + ')');
      ctx.lineWidth = 0.5;
      ctx.stroke();
      ctx.restore();
    });

    // Draw faint connecting lines between nearby particles
    for (let i = 0; i < particles.length; i++) {
      for (let j = i + 1; j < particles.length; j++) {
        const dx = particles[i].x - particles[j].x;
        const dy = particles[i].y - particles[j].y;
        const dist = Math.sqrt(dx * dx + dy * dy);
        if (dist < 200) {
          ctx.beginPath();
          ctx.moveTo(particles[i].x, particles[i].y);
          ctx.lineTo(particles[j].x, particles[j].y);
          ctx.strokeStyle = `rgba(74,144,217,${0.04 * (1 - dist / 200)})`;
          ctx.lineWidth = 0.5;
          ctx.stroke();
        }
      }
    }
    animId = requestAnimationFrame(draw);
  }
  draw();

  // Stop animation when intro is hidden
  const obs = new MutationObserver(() => {
    if (document.getElementById('introScreen')?.classList.contains('hidden')) {
      cancelAnimationFrame(animId);
      obs.disconnect();
    }
  });
  obs.observe(document.getElementById('introScreen'), { attributes: true, attributeFilter: ['class'] });
})();

// Load saved game count for "Continue" button
(async function initContinueBtn() {
  try {
    const companies = await api('GET','/companies');
    let total = 0;
    companies.forEach(co => total += (co.game_count || 0));
    const btn = document.getElementById('btnContinue');
    if (btn && total > 0) {
      btn.querySelector('.imb-desc').textContent = `${total} saved game${total!==1?'s':''}`;
    } else if (btn && total === 0) {
      btn.style.opacity = '.4';
      btn.style.pointerEvents = 'none';
      btn.querySelector('.imb-desc').textContent = 'No saved games yet';
    }
  } catch(e) { /* offline or no backend */ }
})();
</script>
</body>
</html>
