<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nexus Transformation Board ‚Äî The Game</title>
<style>
:root {
  --bg: #0f1218;
  --surface: #171c24;
  --surface2: #1e2430;
  --border: #2a3140;
  --text: #e8ecf1;
  --text-muted: #7d8694;
  --accent: #4a90d9;
  --blue: #2c3e6b;
  --blue-light: #3a5a9c;
  --green: #2d9d5e;
  --red: #d94a4a;
  --orange: #e8943a;
  --purple: #7b5ea7;
  --cyan: #38b2a0;
  --gray: #8b949e;
  --pattern-hex: #2c3e6b;
  --anti-hex: #d97a2a;
  --trans-hex: #7b8794;
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }

/* ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ */
.btn { padding:8px 16px; border-radius:8px; border:1px solid var(--border); background:var(--surface2); color:var(--text); font-size:13px; cursor:pointer; transition:all .15s; display:inline-flex; align-items:center; gap:6px; }
.btn:hover { border-color:var(--accent); }
.btn-primary { background:var(--accent); color:#fff; border-color:var(--accent); }
.btn-primary:hover { opacity:.9; }
.btn-sm { padding:5px 10px; font-size:12px; }
.btn-danger { background:var(--red); color:#fff; border-color:var(--red); }

/* ‚ïê‚ïê INTRO SCREEN ‚ïê‚ïê */
.intro-screen { position:fixed; inset:0; background:var(--bg); z-index:300; display:flex; align-items:center; justify-content:center; flex-direction:column; overflow:hidden; transition:opacity .6s ease; }
.intro-screen.hidden { opacity:0; pointer-events:none; }
.intro-bg-canvas { position:absolute; inset:0; z-index:0; }
.intro-content { position:relative; z-index:1; display:flex; flex-direction:column; align-items:center; gap:20px; animation:introFadeIn 1.2s ease-out; }
@keyframes introFadeIn { 0%{opacity:0;transform:translateY(30px)} 100%{opacity:1;transform:translateY(0)} }
.intro-hex-logo { width:100px; height:87px; background:linear-gradient(135deg, var(--blue-light), var(--purple), var(--cyan)); clip-path:polygon(25% 0%,75% 0%,100% 50%,75% 100%,25% 100%,0% 50%); display:flex; align-items:center; justify-content:center; font-size:38px; color:#fff; font-weight:800; letter-spacing:-2px; animation:logoFloat 4s ease-in-out infinite; box-shadow:0 0 40px rgba(74,144,217,.3); position:relative; }
.intro-hex-logo::after { content:''; position:absolute; inset:-3px; clip-path:polygon(25% 0%,75% 0%,100% 50%,75% 100%,25% 100%,0% 50%); background:linear-gradient(135deg, var(--accent), var(--purple), var(--cyan)); z-index:-1; opacity:.5; animation:logoPulse 3s ease-in-out infinite; }
@keyframes logoFloat { 0%,100%{transform:translateY(0) scale(1)} 50%{transform:translateY(-10px) scale(1.02)} }
@keyframes logoPulse { 0%,100%{opacity:.3;transform:scale(1)} 50%{opacity:.6;transform:scale(1.05)} }
.intro-title { font-size:36px; font-weight:800; background:linear-gradient(90deg,var(--accent),var(--purple),var(--cyan),var(--accent)); background-size:200% auto; -webkit-background-clip:text; -webkit-text-fill-color:transparent; text-align:center; animation:titleShimmer 4s linear infinite; letter-spacing:-.5px; }
@keyframes titleShimmer { 0%{background-position:0% center} 100%{background-position:200% center} }
.intro-sub { color:var(--text-muted); font-size:14px; text-align:center; max-width:440px; line-height:1.7; opacity:.8; }
.intro-menu { display:flex; flex-direction:column; gap:12px; width:320px; margin-top:16px; animation:menuSlideUp 1s ease-out .4s both; }
@keyframes menuSlideUp { 0%{opacity:0;transform:translateY(20px)} 100%{opacity:1;transform:translateY(0)} }
.intro-menu-btn { position:relative; padding:16px 24px; border-radius:12px; border:1px solid var(--border); background:var(--surface); color:var(--text); font-size:15px; font-weight:600; cursor:pointer; transition:all .25s ease; display:flex; align-items:center; gap:14px; overflow:hidden; }
.intro-menu-btn::before { content:''; position:absolute; inset:0; background:linear-gradient(90deg,transparent,rgba(74,144,217,.05),transparent); transform:translateX(-100%); transition:transform .5s ease; }
.intro-menu-btn:hover::before { transform:translateX(100%); }
.intro-menu-btn:hover { border-color:var(--accent); transform:translateX(4px); box-shadow:0 4px 20px rgba(74,144,217,.15); }
.intro-menu-btn .imb-icon { width:40px; height:40px; border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:18px; flex-shrink:0; }
.intro-menu-btn .imb-text { display:flex; flex-direction:column; gap:2px; text-align:left; }
.intro-menu-btn .imb-label { font-size:15px; font-weight:600; }
.intro-menu-btn .imb-desc { font-size:11px; color:var(--text-muted); font-weight:400; }
.intro-menu-btn.primary { border-color:var(--accent); background:linear-gradient(135deg,rgba(74,144,217,.12),rgba(123,94,167,.08)); }
.intro-menu-btn.primary:hover { background:linear-gradient(135deg,rgba(74,144,217,.2),rgba(123,94,167,.15)); box-shadow:0 4px 30px rgba(74,144,217,.25); }
.intro-menu-btn.continue { border-color:rgba(56,178,160,.3); background:linear-gradient(135deg,rgba(56,178,160,.08),rgba(45,157,94,.05)); }
.intro-menu-btn.continue:hover { border-color:var(--cyan); background:linear-gradient(135deg,rgba(56,178,160,.15),rgba(45,157,94,.1)); box-shadow:0 4px 30px rgba(56,178,160,.2); }
.intro-footer { margin-top:32px; color:var(--text-muted); font-size:11px; opacity:.4; animation:introFadeIn 1.5s ease-out .8s both; text-align:center; line-height:1.6; }
.intro-footer a { color:var(--accent); text-decoration:none; opacity:.7; }

/* ‚ïê‚ïê GAME SELECT SCREEN ‚ïê‚ïê */
.game-select { position:fixed; inset:0; background:var(--bg); z-index:250; display:none; overflow-y:auto; }
.game-select.show { display:flex; align-items:flex-start; justify-content:center; }
.gs-container { max-width:700px; width:100%; padding:50px 24px; animation:gsFadeIn .5s ease-out; }
@keyframes gsFadeIn { 0%{opacity:0;transform:translateY(15px)} 100%{opacity:1;transform:translateY(0)} }
.gs-header { display:flex; align-items:center; gap:16px; margin-bottom:28px; }
.gs-header h2 { font-size:24px; font-weight:700; flex:1; }
.gs-back { cursor:pointer; color:var(--text-muted); font-size:13px; display:inline-flex; align-items:center; gap:6px; padding:8px 14px; border-radius:8px; border:1px solid var(--border); background:var(--surface); transition:all .2s; }
.gs-back:hover { border-color:var(--accent); color:var(--accent); }
.gs-section-label { font-size:10px; text-transform:uppercase; letter-spacing:1.2px; color:var(--text-muted); margin-bottom:10px; font-weight:600; }
.gs-card { background:var(--surface); border:1px solid var(--border); border-radius:14px; padding:18px 22px; margin-bottom:10px; cursor:pointer; transition:all .2s ease; display:flex; justify-content:space-between; align-items:center; position:relative; overflow:hidden; }
.gs-card::before { content:''; position:absolute; inset:0; background:linear-gradient(90deg,transparent,rgba(74,144,217,.03),transparent); transform:translateX(-100%); transition:transform .4s ease; }
.gs-card:hover::before { transform:translateX(100%); }
.gs-card:hover { border-color:var(--accent); transform:translateY(-2px); box-shadow:0 6px 24px rgba(0,0,0,.3); }
.gs-card .gs-name { font-weight:600; font-size:15px; }
.gs-card .gs-meta { font-size:12px; color:var(--text-muted); margin-top:3px; }
.gs-card .gs-arrow { font-size:18px; color:var(--accent); transition:transform .2s; }
.gs-card:hover .gs-arrow { transform:translateX(4px); }
.gs-card .gs-fitness { display:flex; align-items:center; gap:10px; }
.gs-card .gs-fitness-score { font-size:22px; font-weight:800; color:var(--cyan); }
.gs-card .gs-fitness-label { font-size:9px; color:var(--text-muted); text-transform:uppercase; letter-spacing:.5px; }
.gs-divider { height:1px; background:var(--border); margin:24px 0; }
.gs-form { background:var(--surface); border:1px solid var(--border); border-radius:14px; padding:22px; margin-top:8px; }
.gs-form-title { font-size:13px; font-weight:600; margin-bottom:14px; display:flex; align-items:center; gap:8px; color:var(--text); }
.gs-form input, .gs-form textarea { width:100%; padding:10px 14px; background:var(--surface2); border:1px solid var(--border); border-radius:10px; color:var(--text); font-size:13px; margin-bottom:10px; transition:border-color .2s; }
.gs-form input:focus, .gs-form textarea:focus { outline:none; border-color:var(--accent); box-shadow:0 0 0 3px rgba(74,144,217,.1); }
.gs-form textarea { resize:vertical; min-height:50px; font-family:inherit; }
.gs-form .btn { width:100%; padding:12px; font-size:14px; font-weight:600; border-radius:10px; }
.gs-empty { text-align:center; color:var(--text-muted); padding:40px; font-size:14px; border:1px dashed var(--border); border-radius:14px; }
.gs-org-badge { display:inline-flex; align-items:center; gap:6px; padding:4px 12px; border-radius:8px; background:rgba(74,144,217,.1); border:1px solid rgba(74,144,217,.2); font-size:12px; color:var(--accent); font-weight:500; }

/* ‚ïê‚ïê HEADER ‚ïê‚ïê */
.app-header { background:linear-gradient(135deg,#171c24,#1c2233); border-bottom:1px solid var(--border); padding:10px 20px; display:flex; align-items:center; justify-content:space-between; position:sticky; top:0; z-index:100; }
.logo { display:flex; align-items:center; gap:10px; flex-shrink:0; cursor:default; }
.logo-hex { width:36px; height:31px; background:linear-gradient(135deg,var(--blue-light),var(--purple)); clip-path:polygon(25% 0%,75% 0%,100% 50%,75% 100%,25% 100%,0% 50%); display:flex; align-items:center; justify-content:center; font-size:14px; color:#fff; font-weight:700; }
.logo h1 { font-size:16px; font-weight:600; color:var(--text); }
.logo .sub { font-size:10px; color:var(--text-muted); }
.header-center { display:flex; align-items:center; gap:10px; }
.game-name-tag { background:var(--surface2); border:1px solid var(--border); border-radius:6px; padding:4px 12px; font-size:12px; color:var(--cyan); }
.save-status { font-size:11px; color:var(--text-muted); transition:color .3s; }
.save-status.saving { color:var(--orange); }
.save-status.saved { color:var(--green); }
.header-actions { display:flex; gap:6px; flex-wrap:wrap; justify-content:flex-end; }

/* ‚ïê‚ïê MAIN LAYOUT ‚ïê‚ïê */
.main-layout { display:grid; grid-template-columns:260px 1fr 260px; height:calc(100vh - 53px); }

/* ‚ïê‚ïê LEFT PANEL (TOOLBOX) ‚ïê‚ïê */
.toolbox { background:var(--surface); border-right:1px solid var(--border); overflow-y:auto; padding:14px; }
.toolbox-title { font-size:14px; font-weight:700; margin-bottom:12px; display:flex; align-items:center; gap:8px; }
.toolbox-section { margin-bottom:16px; }
.toolbox-section h3 { font-size:10px; text-transform:uppercase; letter-spacing:.8px; color:var(--text-muted); margin-bottom:8px; }
.search-input { width:100%; padding:7px 10px; background:var(--surface2); border:1px solid var(--border); border-radius:8px; color:var(--text); font-size:12px; margin-bottom:10px; }
.search-input:focus { outline:none; border-color:var(--accent); }
.filter-tabs { display:flex; gap:4px; margin-bottom:10px; }
.filter-tab { flex:1; padding:5px; text-align:center; font-size:9px; text-transform:uppercase; letter-spacing:.4px; border-radius:6px; background:var(--surface2); border:1px solid var(--border); cursor:pointer; color:var(--text-muted); transition:all .15s; }
.filter-tab.active { border-color:var(--accent); color:var(--accent); background:rgba(74,144,217,.08); }

/* ‚îÄ‚îÄ Hex cards in toolbox ‚îÄ‚îÄ */
.hex-list { display:flex; flex-direction:column; gap:5px; }
.hex-card { position:relative; display:flex; align-items:center; gap:10px; padding:8px 10px; background:var(--surface2); border:1px solid var(--border); border-radius:8px; cursor:grab; transition:all .15s; font-size:11px; }
.hex-card:hover { transform:translateY(-1px); box-shadow:0 4px 12px rgba(0,0,0,.3); }
.hex-card:active { cursor:grabbing; }
.hex-card.on-board { opacity:.35; pointer-events:none; }
.hex-mini { width:32px; height:28px; clip-path:polygon(25% 0%,75% 0%,100% 50%,75% 100%,25% 100%,0% 50%); display:flex; align-items:center; justify-content:center; font-size:8px; font-weight:700; color:#fff; flex-shrink:0; }
.hex-mini.pattern { background:var(--pattern-hex); }
.hex-mini.antipattern { background:var(--anti-hex); }
.hex-mini.transition { background:var(--trans-hex); border:1px dashed rgba(255,255,255,.3); }
.hex-card .hex-info { flex:1; min-width:0; }
.hex-card .hex-name { font-weight:600; font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.hex-card .hex-signal { color:var(--text-muted); font-size:10px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.hex-card .hex-domain { display:inline-block; padding:1px 5px; background:rgba(74,144,217,.12); color:var(--accent); border-radius:3px; font-size:8px; margin-top:2px; }

/* ‚ïê‚ïê BOARD AREA ‚ïê‚ïê */
.board-area { position:relative; overflow:auto; display:flex; flex-direction:column; }

/* Domains bar */
.board-domains { display:flex; border-bottom:1px solid var(--border); background:var(--surface); position:sticky; top:0; z-index:10; }
.domain-label { flex:1; text-align:center; padding:8px 6px; font-size:10px; font-weight:600; text-transform:uppercase; letter-spacing:.4px; color:var(--cyan); border-right:1px solid var(--border); cursor:pointer; transition:all .15s; opacity:.55; }
.domain-label:last-child { border-right:none; }
.domain-label:hover { opacity:.8; background:rgba(56,178,160,.04); }
.domain-label.active { opacity:1; background:rgba(56,178,160,.08); border-bottom:2px solid var(--cyan); }

/* Hex grid board */
.board-map { flex:1; position:relative; background:var(--bg); display:flex; flex-direction:column; overflow:hidden; }

/* Zone headers bar */
.zone-headers { display:flex; border-bottom:1px solid rgba(255,255,255,.06); background:var(--surface); position:sticky; top:0; z-index:10; }
.zone-headers .zh-spacer { width:36px; flex-shrink:0; border-right:1px solid rgba(255,255,255,.06); }
.zone-col-header { flex:1; padding:6px 12px; display:flex; justify-content:center; align-items:center; border-right:1px solid rgba(255,255,255,.04); }
.zone-col-header:last-child { border-right:none; }
.zone-col-header .zone-tag { font-size:10px; font-weight:600; text-transform:uppercase; letter-spacing:.5px; padding:3px 10px; border-radius:4px; }
.zone-col-header.hdr-current .zone-tag { color:var(--red); background:rgba(217,74,74,.1); }
.zone-col-header.hdr-path .zone-tag { color:var(--orange); background:rgba(232,148,58,.1); }
.zone-col-header.hdr-desired .zone-tag { color:var(--green); background:rgba(45,157,94,.1); }

/* Honeycomb grid container */
.honeycomb-grid { position:relative; min-height:100%; }

/* Zone background overlays */
.zone-bg { position:absolute; pointer-events:none; z-index:0; border-right:1px solid rgba(255,255,255,.04); }
.zone-bg.zb-current { background:linear-gradient(90deg, rgba(217,74,74,.03), transparent); }
.zone-bg.zb-desired { background:linear-gradient(270deg, rgba(45,157,94,.03), transparent); }

/* Lane divider and labels */
.lane-divider { position:absolute; left:36px; right:0; height:1px; background:rgba(255,255,255,.08); z-index:1; pointer-events:none; }
.lane-label-abs { position:absolute; left:0; width:36px; display:flex; align-items:center; justify-content:center; z-index:2; border-right:1px solid rgba(255,255,255,.06); background:var(--surface); }
.lane-label-abs .ll-text { writing-mode:vertical-lr; transform:rotate(180deg); font-size:9px; font-weight:700; text-transform:uppercase; letter-spacing:1.2px; text-align:center; white-space:nowrap; }
.lane-label-abs .ll-sub { display:block; font-size:6px; font-weight:400; opacity:.4; letter-spacing:.5px; text-transform:none; margin-top:6px; }
.lane-label-abs.strategic .ll-text { color:var(--cyan); }
.lane-label-abs.operational .ll-text { color:var(--orange); }

/* Hex cells (absolutely positioned) */
.hex-cell { position:absolute; z-index:1; }
.hex-cell-bg { position:absolute; inset:2px; clip-path:polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%); background:rgba(255,255,255,.015); border:1px dashed rgba(255,255,255,.035); transition:all .2s; display:flex; align-items:center; justify-content:center; }
.hex-cell.drag-over .hex-cell-bg { background:rgba(74,144,217,.1); border-color:rgba(74,144,217,.3); }
.hex-cell.empty .hex-cell-bg { cursor:default; }
.hex-cell.empty .hex-cell-bg::after { content:'‚¨°'; font-size:14px; color:rgba(255,255,255,.04); }
/* Guidance highlighting on individual cells */
.hex-cell.guide-best .hex-cell-bg { background:rgba(45,200,94,.12); border-color:rgba(45,200,94,.35); box-shadow:inset 0 0 8px rgba(45,200,94,.15); }
.hex-cell.guide-yes .hex-cell-bg { background:rgba(45,157,94,.06); border-color:rgba(45,157,94,.18); }
.hex-cell.guide-no { opacity:.25; }

/* ‚îÄ‚îÄ Board hexagons (inside hex cells) ‚îÄ‚îÄ */
.board-hex { position:absolute; inset:1px; cursor:grab; transition:all .15s; z-index:1; }
.board-hex:hover { transform:scale(1.06); z-index:2; }
.board-hex.domain-dimmed { opacity:.15; }

.board-hex-shape { clip-path:polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%); padding:0; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; overflow:hidden; text-align:center; position:relative; }
.board-hex.pattern .board-hex-shape { background:var(--pattern-hex); }
.board-hex.antipattern .board-hex-shape { background:var(--anti-hex); }
.board-hex.transition .board-hex-shape { background:var(--trans-hex); }

/* All content centered symmetrically inside the hex safe zone */
.bh-text { display:flex; flex-direction:column; justify-content:center; align-items:center; padding:0 18%; }
.board-hex .bh-type { font-size:clamp(6px, calc(var(--hex-w, 100px) * 0.05), 9px); text-transform:uppercase; letter-spacing:.8px; font-weight:800; color:rgba(255,255,255,.65); }
.board-hex .bh-name { font-size:clamp(9px, calc(var(--hex-w, 100px) * 0.08), 14px); font-weight:700; color:#fff; margin-top:2px; line-height:1.15; word-break:break-word; text-shadow:0 1px 3px rgba(0,0,0,.4); }
.board-hex .bh-signal { font-size:clamp(7px, calc(var(--hex-w, 100px) * 0.055), 10px); color:rgba(255,255,255,.5); margin-top:2px; line-height:1.15; display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden; }
/* Icons row below text */
.bh-bottom { display:flex; gap:4px; justify-content:center; align-items:center; margin-top:4px; flex-shrink:0; }
.board-hex .remove-hex { position:absolute; top:5px; right:22%; background:none; border:none; color:rgba(255,255,255,.4); cursor:pointer; font-size:12px; z-index:2; opacity:0; transition:opacity .15s; }
.board-hex:hover .remove-hex { opacity:1; }

/* Agent badges */
.agent-badge { width:20px; height:20px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:10px; cursor:pointer; transition:opacity .15s; }
.agent-badge:hover { opacity:.7; }
.agent-badge.human { background:rgba(255,255,255,.2); }
.agent-badge.systemic { background:rgba(123,94,167,.5); }
.agent-badge.ai { background:rgba(74,144,217,.4); }

/* Axis labels ‚Äî subtle vertical cues */
.axis-label-left, .axis-label-right { position:absolute; top:50%; writing-mode:vertical-rl; font-size:8px; font-weight:500; letter-spacing:1.5px; text-transform:uppercase; z-index:5; pointer-events:none; opacity:.25; }
.axis-label-left { left:40px; transform:translateY(-50%) rotate(180deg); color:var(--red); }
.axis-label-right { right:6px; transform:translateY(-50%); color:var(--green); }

/* Drivers bar */
.board-drivers { border-top:1px solid var(--border); background:var(--surface); padding:8px 14px; display:flex; align-items:center; gap:6px; flex-wrap:wrap; position:sticky; bottom:0; z-index:10; }
.driver-label { font-size:9px; text-transform:uppercase; letter-spacing:.5px; color:var(--text-muted); margin-right:4px; display:flex; align-items:center; gap:4px; }
.driver-label .bolt { color:var(--orange); font-size:14px; }
.driver-chip { padding:4px 12px; background:rgba(74,144,217,.08); border:1px solid rgba(74,144,217,.25); border-radius:16px; font-size:10px; color:var(--accent); cursor:pointer; transition:all .15s; user-select:none; }
.driver-chip:hover { background:rgba(74,144,217,.15); }
.driver-chip.selected { background:var(--orange); color:#fff; border-color:var(--orange); box-shadow:0 0 10px rgba(232,148,58,.3); }
.driver-chip.used { background:rgba(232,148,58,.1); border-color:var(--orange); color:var(--orange); }
.driver-status { font-size:10px; color:var(--orange); margin-left:6px; animation:pulse 1.5s ease-in-out infinite; }
/* Driver badges on hexes */
.bh-drivers { display:flex; flex-wrap:wrap; gap:3px; margin-top:4px; justify-content:center; }
.driver-badge { display:inline-flex; align-items:center; gap:2px; padding:2px 7px; border-radius:8px; background:rgba(0,0,0,.4); border:1px solid rgba(255,255,255,.2); font-size:8px; font-weight:600; color:#fff; cursor:pointer; white-space:nowrap; max-width:100%; overflow:hidden; text-overflow:ellipsis; }
.driver-badge:hover { background:rgba(0,0,0,.6); border-color:rgba(255,255,255,.4); }
.driver-badge .db-bolt { font-size:9px; color:var(--orange); }
/* Domain boundary SVG */
.domains-svg { position:absolute; inset:0; width:100%; height:100%; pointer-events:none; z-index:4; overflow:visible; }
/* Domain item in dashboard */
.domain-item { display:flex; align-items:center; gap:8px; padding:6px 10px; border-radius:6px; border:1px solid var(--border); margin-bottom:4px; cursor:pointer; transition:all .15s; font-size:12px; }
.domain-item:hover { border-color:var(--accent); }
.domain-item.selected { background:rgba(74,144,217,.08); border-color:var(--accent); }
.domain-item .di-color { width:12px; height:12px; border-radius:50%; flex-shrink:0; }
.domain-item .di-name { flex:1; font-weight:500; }
.domain-item .di-count { font-size:9px; color:var(--text-muted); }
.domain-item .di-del { background:none; border:none; color:var(--text-muted); cursor:pointer; font-size:14px; padding:0 4px; }
.domain-item .di-del:hover { color:var(--red); }
/* Domain color picker */
.color-swatches { display:flex; gap:6px; flex-wrap:wrap; margin-top:4px; }
.color-swatch { width:28px; height:28px; border-radius:50%; cursor:pointer; border:2px solid transparent; transition:all .15s; }
.color-swatch:hover { transform:scale(1.15); }
.color-swatch.selected { border-color:#fff; box-shadow:0 0 8px rgba(255,255,255,.3); }
/* Hex with domain outline */
.board-hex.has-domain { outline-offset:-1px; }
/* Toast notification */
.board-toast { position:absolute; top:50px; left:50%; transform:translateX(-50%); z-index:50; padding:8px 18px; border-radius:8px; font-size:11px; font-weight:500; pointer-events:none; opacity:0; transition:opacity .3s, top .3s; white-space:nowrap; }
.board-toast.show { opacity:1; top:40px; }
.board-toast.warning { background:rgba(232,148,58,.9); color:#fff; }
.board-toast.hint { background:rgba(74,144,217,.9); color:#fff; }
/* Agent assignment hint glow on transitions */
.board-hex.agent-hint { outline:2px solid var(--purple); outline-offset:1px; animation:agentPulse 1s ease-in-out infinite; }
@keyframes agentPulse { 0%,100%{outline-color:rgba(123,94,167,.3)} 50%{outline-color:rgba(123,94,167,.7)} }

.axis-bottom { text-align:center; padding:4px; font-size:9px; color:var(--text-muted); letter-spacing:.5px; border-top:1px solid var(--border); background:var(--surface); }

/* ‚ïê‚ïê RIGHT PANEL ‚ïê‚ïê */
.dashboard { background:var(--surface); border-left:1px solid var(--border); overflow-y:auto; padding:14px; }
.dash-title { font-size:13px; font-weight:600; color:var(--text-muted); text-transform:uppercase; letter-spacing:.6px; margin-bottom:12px; }
.dash-section { margin-bottom:18px; }
.dash-section h3 { font-size:10px; text-transform:uppercase; letter-spacing:.6px; color:var(--text-muted); margin-bottom:8px; }

/* Fitness */
.fitness-score { font-size:40px; font-weight:700; text-align:center; margin:6px 0; }
.fitness-gauge { width:100%; height:16px; background:var(--surface2); border-radius:8px; overflow:hidden; margin:6px 0; }
.fitness-fill { height:100%; border-radius:8px; transition:width .5s; background:linear-gradient(90deg,var(--red),var(--orange),var(--green),var(--cyan)); }
.fitness-label { text-align:center; font-size:11px; color:var(--text-muted); }

/* Stats */
.stat-grid { display:grid; grid-template-columns:1fr 1fr; gap:6px; }
.stat-card { background:var(--surface2); border:1px solid var(--border); border-radius:8px; padding:8px; text-align:center; }
.stat-val { font-size:20px; font-weight:700; }
.stat-lbl { font-size:9px; color:var(--text-muted); text-transform:uppercase; }

/* Cycle */
.cycle-step { display:flex; align-items:center; gap:8px; padding:8px 10px; border-radius:8px; margin-bottom:4px; background:var(--surface2); border:1px solid var(--border); cursor:pointer; transition:all .15s; }
.cycle-step:hover { border-color:var(--accent); }
.cycle-step.active { border-color:var(--accent); background:rgba(74,144,217,.08); }
.cycle-step.completed { border-color:var(--green); background:rgba(45,157,94,.06); }
.cycle-icon { width:26px; height:26px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:13px; background:var(--surface); border:2px solid var(--border); flex-shrink:0; }
.cycle-step.active .cycle-icon { border-color:var(--accent); }
.cycle-step.completed .cycle-icon { border-color:var(--green); }
.cycle-name { font-size:12px; font-weight:600; }
.cycle-desc { font-size:9px; color:var(--text-muted); }

/* Agent palette */
.agent-palette { display:flex; gap:8px; justify-content:center; }
.agent-pal { display:flex; flex-direction:column; align-items:center; gap:3px; cursor:pointer; transition:all .15s; }
.agent-pal:hover { transform:scale(1.05); }
.agent-circle { width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:18px; border:2px solid var(--border); transition:border-color .15s; }
.agent-pal.selected .agent-circle { border-color:var(--accent); box-shadow:0 0 12px rgba(74,144,217,.3); }
.agent-pal .agent-label { font-size:9px; color:var(--text-muted); }
.agent-circle.human { background:rgba(200,200,200,.1); }
.agent-circle.systemic { background:rgba(123,94,167,.2); }
.agent-circle.ai { background:rgba(74,144,217,.15); }

/* Log */
.log-entry { padding:4px 8px; border-left:2px solid var(--border); margin-bottom:3px; font-size:10px; color:var(--text-muted); }
.log-entry.action { border-left-color:var(--accent); }
.log-entry.success { border-left-color:var(--green); }
.log-entry.warning { border-left-color:var(--orange); }
.log-time { font-size:8px; opacity:.5; }

/* ‚ïê‚ïê MODALS ‚ïê‚ïê */
.modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:400; display:none; align-items:center; justify-content:center; backdrop-filter:blur(4px); }
.modal-overlay.show { display:flex; }
.modal { background:var(--surface); border:1px solid var(--border); border-radius:14px; padding:28px; max-width:560px; width:90%; max-height:80vh; overflow-y:auto; }
.modal h2 { font-size:18px; margin-bottom:14px; }
.modal p { color:var(--text-muted); font-size:13px; line-height:1.6; margin-bottom:10px; }
.modal h3 { color:var(--cyan); margin:14px 0 6px; font-size:13px; }
.modal-actions { display:flex; gap:8px; justify-content:flex-end; margin-top:16px; }
.form-group { margin-bottom:14px; }
.form-group label { display:block; font-size:11px; color:var(--text-muted); margin-bottom:3px; }
.form-group input, .form-group select { width:100%; padding:7px 10px; background:var(--surface2); border:1px solid var(--border); border-radius:8px; color:var(--text); font-size:12px; }
.form-group input:focus, .form-group select:focus { outline:none; border-color:var(--accent); }

/* ‚ïê‚ïê CONNECTION MODE ‚ïê‚ïê */
.connect-toolbar { display:flex; align-items:center; gap:6px; padding:6px 14px; border-bottom:1px solid var(--border); background:var(--surface); }
.connect-toolbar .ct-label { font-size:9px; text-transform:uppercase; letter-spacing:.5px; color:var(--text-muted); margin-right:4px; display:flex; align-items:center; gap:4px; }
.connect-btn { padding:4px 12px; border-radius:16px; border:1px solid var(--border); background:var(--surface2); color:var(--text-muted); font-size:10px; cursor:pointer; transition:all .15s; display:inline-flex; align-items:center; gap:5px; }
.connect-btn:hover { border-color:var(--accent); color:var(--text); }
.connect-btn.active { background:var(--accent); color:#fff; border-color:var(--accent); }
.connect-btn .cb-icon { display:inline-block; width:20px; height:2px; position:relative; }
.connect-btn.path-btn .cb-icon { border-top:2px dashed var(--text-muted); }
.connect-btn.path-btn.active .cb-icon { border-top-color:#fff; }
.connect-btn.nexus-btn .cb-icon { border-top:2px solid var(--cyan); width:14px; height:10px; border-right:2px solid var(--cyan); border-top:none; border-left:none; border-bottom:none; }
.connect-btn.nexus-btn .cb-icon::after { content:''; position:absolute; top:-1px; right:-2px; width:14px; border-top:2px solid var(--cyan); }
.connect-status { font-size:10px; color:var(--orange); margin-left:8px; animation:pulse 1.5s ease-in-out infinite; }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.4} }

/* SVG overlay for connections */
.connections-svg { position:absolute; inset:0; width:100%; height:100%; pointer-events:none; z-index:3; overflow:visible; }
.connections-svg path { pointer-events:stroke; cursor:pointer; stroke-linecap:round; stroke-linejoin:round; }
.connections-svg .conn-path { stroke:rgba(200,200,220,.6); stroke-width:2; stroke-dasharray:8,5; fill:none; transition:stroke .15s; }
.connections-svg g:hover .conn-path { stroke:rgba(200,200,220,.9); stroke-width:2.5; }
.connections-svg .conn-nexus { stroke:var(--cyan); stroke-width:2.5; fill:none; opacity:.7; transition:opacity .15s; }
.connections-svg g:hover .conn-nexus { opacity:1; stroke-width:3; }
.connections-svg .conn-arrow { fill:rgba(200,200,220,.6); }
.connections-svg .conn-arrow-nexus { fill:var(--cyan); }
.connections-svg .conn-delete { fill:var(--red); opacity:0; cursor:pointer; pointer-events:all; transition:opacity .2s; }
.connections-svg g:hover .conn-delete { opacity:1; }
/* Invisible wider hit area for easier hovering */
.connections-svg .conn-hit { stroke:transparent; stroke-width:16; fill:none; pointer-events:stroke; cursor:pointer; }

/* Hex highlight in connect mode */
.board-hex.connect-source { outline:2px solid var(--accent); outline-offset:2px; }
.board-hex.connect-target { outline:2px dashed var(--orange); outline-offset:2px; cursor:crosshair; }
.board-hex.connect-mode { cursor:crosshair; }

/* ‚ïê‚ïê MARKERS (S2F / Capabilities) ‚ïê‚ïê */
.marker-section { margin-top:12px; }
.marker-palette { display:flex; gap:8px; justify-content:center; flex-wrap:wrap; }
.marker-pal { display:flex; flex-direction:column; align-items:center; gap:3px; cursor:pointer; transition:all .15s; }
.marker-pal:hover { transform:scale(1.05); }
.marker-circle { width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:13px; font-weight:700; border:2px solid var(--border); transition:border-color .15s; color:#fff; }
.marker-pal.selected .marker-circle { border-color:var(--accent); box-shadow:0 0 12px rgba(74,144,217,.3); }
.marker-pal .marker-label { font-size:8px; color:var(--text-muted); text-align:center; max-width:55px; }
.marker-circle.s2f { background:#8b8b8b; }
.marker-circle.capability { background:var(--cyan); }
/* Marker badges on board hexes */
.bh-markers { display:flex; gap:4px; margin-top:4px; }
.marker-badge { width:20px; height:20px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:8px; font-weight:700; color:#fff; cursor:pointer; }
.marker-badge.s2f { background:#8b8b8b; }
.marker-badge.capability { background:var(--cyan); color:#1a1a2e; }
.marker-badge:hover { opacity:.7; }

/* Scrollbar */
::-webkit-scrollbar { width:5px; }
::-webkit-scrollbar-track { background:transparent; }
::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }

/* ‚ïê‚ïê FITNESS PANEL (Improved Fitness ‚Äî metrics dashboard) ‚ïê‚ïê */
.fitness-panel { flex:2; background:var(--surface); border-left:1px solid var(--border); overflow-y:auto; display:flex; flex-direction:column; min-width:160px; max-width:320px; }
.fp-body { padding:12px; display:flex; flex-direction:column; gap:0; flex:1; }
.fp-section { margin-bottom:14px; }
.fp-section h3 { font-size:10px; text-transform:uppercase; letter-spacing:.5px; color:var(--text-muted); margin-bottom:7px; }
.fp-empty { font-size:10px; color:var(--text-muted); opacity:.5; font-style:italic; padding:4px 0; }
.fp-item { background:var(--surface2); border:1px solid var(--border); border-radius:7px; padding:7px 9px; margin-bottom:5px; }
.fp-item-name { font-size:11px; font-weight:600; color:var(--text); margin-bottom:4px; line-height:1.3; }
.fp-result-input { width:100%; padding:4px 7px; background:var(--bg); border:1px solid var(--border); border-radius:5px; color:var(--text); font-size:10px; margin-top:2px; }
.fp-result-input:focus { outline:none; border-color:var(--accent); }
.fp-counter { display:flex; align-items:center; gap:6px; margin-top:4px; }
.fp-counter button { width:22px; height:22px; border-radius:50%; border:1px solid var(--border); background:var(--surface); color:var(--text); font-size:14px; cursor:pointer; display:flex; align-items:center; justify-content:center; line-height:1; transition:all .15s; }
.fp-counter button:hover { border-color:var(--accent); color:var(--accent); }
.fp-rep-count { font-size:16px; font-weight:700; color:var(--cyan); min-width:24px; text-align:center; }
.fp-summary { background:var(--surface2); border:1px solid var(--border); border-radius:7px; padding:8px 10px; display:grid; grid-template-columns:1fr 1fr; gap:6px; margin-bottom:12px; }
.fp-sum-item { text-align:center; }
.fp-sum-val { font-size:20px; font-weight:700; }
.fp-sum-lbl { font-size:8px; color:var(--text-muted); text-transform:uppercase; letter-spacing:.4px; }
</style>
</head>
<body>

<!-- ‚ïê‚ïê INTRO ‚ïê‚ïê -->
<div class="intro-screen" id="introScreen">
  <canvas class="intro-bg-canvas" id="introBgCanvas"></canvas>
  <div class="intro-content">
    <div class="intro-hex-logo">N</div>
    <div class="intro-title">Nexus Transformation Board</div>
    <div class="intro-sub">Navigate organizational transformation through strategic sensemaking. Map patterns, replace anti-patterns, and evolve toward adaptive fitness.</div>
    <div class="intro-menu" id="introMenu">
      <button class="intro-menu-btn primary" onclick="showNewGame()">
        <div class="imb-icon" style="background:linear-gradient(135deg,rgba(74,144,217,.2),rgba(123,94,167,.2));">üéØ</div>
        <div class="imb-text"><div class="imb-label">New Game</div><div class="imb-desc">Create organization &amp; start a transformation</div></div>
      </button>
      <button class="intro-menu-btn continue" onclick="showContinueGame()" id="btnContinue">
        <div class="imb-icon" style="background:linear-gradient(135deg,rgba(56,178,160,.2),rgba(45,157,94,.15));">üìÇ</div>
        <div class="imb-text"><div class="imb-label">Continue</div><div class="imb-desc">Load a saved game</div></div>
      </button>
      <button class="intro-menu-btn" onclick="showModal('howToPlayModal')">
        <div class="imb-icon" style="background:rgba(255,255,255,.05);">üìñ</div>
        <div class="imb-text"><div class="imb-label">How to Play</div><div class="imb-desc">Learn the Codex mechanics &amp; rules</div></div>
      </button>
    </div>
    <div class="intro-footer">Based on the Enterprise Transformation Codex<br><a>NTT DATA DS&A USA</a></div>
  </div>
</div>

<!-- ‚ïê‚ïê GAME SELECT ‚ïê‚ïê -->
<div class="game-select" id="gameSelect">
  <div class="gs-container" id="gsContent"></div>
</div>

<!-- ‚ïê‚ïê HOW TO PLAY ‚ïê‚ïê -->
<div class="modal-overlay" id="howToPlayModal">
  <div class="modal" style="max-width:620px;">
    <h2>How to Play the Nexus Game</h2>
    <p>The Nexus Transformation Board is a <strong>strategic sensemaking game</strong> where participants navigate organizational transformation.</p>
    <h3>The Board (Two Lanes)</h3>
    <p>The board has <strong>3 zones √ó 2 layers</strong>:</p>
    <p><strong style="color:var(--red)">Current Reality</strong> ‚Äî Where anti-patterns live. Constraints, inertia, habits.</p>
    <p><strong style="color:var(--orange)">Transformation Path</strong> ‚Äî Transitional space. Experiments and learning.</p>
    <p><strong style="color:var(--green)">Improved Fitness</strong> ‚Äî Enabling patterns and adaptive capacity.</p>
    <p style="margin-top:6px"><strong style="color:var(--cyan)">Top Lane ‚Äî Strategic</strong>: Intent, Meaning, Investment Logic (why leadership cares).</p>
    <p><strong style="color:var(--orange)">Bottom Lane ‚Äî Operational</strong>: Execution, Habits, Daily Decisions (where change happens).</p>
    <h3>The Hexagons</h3>
    <p><span style="color:#6b8fd4">Blue Hexagons</span> ‚Äî Patterns: enabling behaviors.</p>
    <p><span style="color:var(--orange)">Orange Hexagons</span> ‚Äî Anti-Patterns: constraining behaviors.</p>
    <p><span style="color:var(--gray)">Gray Hexagons</span> ‚Äî Transition Patterns: safe bridges.</p>
    <h3>Connections (Links)</h3>
    <p>Use the <strong>üîó Links</strong> toolbar above the board to draw arrows between hexagons:</p>
    <p><strong>Transition Path</strong> (dashed arrow) ‚Äî Shows the transformation journey. Typically Anti-Pattern ‚Üí Transition ‚Üí Pattern.</p>
    <p><strong>Transition Nexus</strong> (solid L-shaped arrow) ‚Äî Shows a nexus point where multiple transitions converge or branch.</p>
    <p style="font-size:11px;color:var(--text-muted)">Click a link type ‚Üí click the source hex ‚Üí click the target hex. Hover a link to see the delete button.</p>
    <h3>Board Markers</h3>
    <p><span style="color:#8b8b8b;font-weight:700">S2F</span> ‚Äî <strong>Safe to Fail Experiment</strong>: Mark a hex as an experimental probe. Small, contained tests with clear hypotheses.</p>
    <p><span style="color:var(--cyan);font-weight:700">C</span> ‚Äî <strong>Capability</strong>: Mark organizational capabilities that need to be developed or leveraged for the transformation.</p>
    <p style="font-size:11px;color:var(--text-muted)">Select a marker from the Dashboard, then click a hex. Click the badge on the hex to remove it.</p>
    <h3>The Mobius Cycle</h3>
    <p><strong>Sense ‚Üí Focus ‚Üí Experiment ‚Üí Stabilize ‚Üí Diffuse</strong>. Each phase guides your actions.</p>
    <h3>Agents of Change</h3>
    <p>üßë <strong>Human</strong> ‚Äî Leaders who legitimize change. &nbsp; üèõ <strong>Systemic</strong> ‚Äî Governance, KPIs. &nbsp; ü§ñ <strong>AI</strong> ‚Äî Automation, analytics.</p>
    <h3>Goal</h3>
    <p>There is no end state. Success = pattern migration + rising fitness score.</p>
    <div class="modal-actions"><button class="btn btn-primary" onclick="closeModal('howToPlayModal')">Got it!</button></div>
  </div>
</div>

<!-- ‚ïê‚ïê ADD PATTERN MODAL ‚ïê‚ïê -->
<div class="modal-overlay" id="addPatternModal">
  <div class="modal">
    <h2>Add Custom Pattern</h2>
    <div class="form-group"><label>Type</label><select id="newType"><option value="pattern">Pattern</option><option value="antipattern">Anti-Pattern</option><option value="transition">Transition</option></select></div>
    <div class="form-group"><label>Name</label><input id="newName" placeholder="e.g., Decentralized Decisions"></div>
    <div class="form-group"><label>Signal</label><input id="newSignal" placeholder="How you recognize it"></div>
    <div class="form-group"><label>Impact</label><input id="newImpact" placeholder="What it enables or blocks"></div>
    <div class="form-group"><label>Domain</label><select id="newDomain"><option>Strategy & Portfolio</option><option>Product & Delivery</option><option>Technology & Architecture</option><option>People, Culture & Governance</option><option>Operations</option></select></div>
    <div class="modal-actions"><button class="btn" onclick="closeModal('addPatternModal')">Cancel</button><button class="btn btn-primary" onclick="addCustomPattern()">Add</button></div>
  </div>
</div>

<!-- ‚ïê‚ïê ADD DOMAIN MODAL ‚ïê‚ïê -->
<div class="modal-overlay" id="addDomainModal">
  <div class="modal">
    <h2>Create Organizational Domain</h2>
    <div class="form-group"><label>Domain Name</label><input id="newDomainName" placeholder="e.g., Technology, People & Culture"></div>
    <div class="form-group"><label>Color</label><div class="color-swatches" id="domainColorPicker"></div></div>
    <div class="modal-actions"><button class="btn" onclick="closeModal('addDomainModal')">Cancel</button><button class="btn btn-primary" onclick="createDomain()">Create</button></div>
  </div>
</div>

<!-- ‚ïê‚ïê MAIN APP ‚ïê‚ïê -->
<div id="mainApp" style="display:none">
  <header class="app-header">
    <div class="logo">
      <div class="logo-hex">N</div>
      <div><h1>Nexus Board</h1><div class="sub">Transformation Codex ‚Äî NTT DATA</div></div>
    </div>
    <div class="header-center">
      <span class="game-name-tag" id="gameNameTag">‚Äî</span>
      <span class="save-status" id="saveStatus"></span>
    </div>
    <div class="header-actions">
      <button class="btn btn-sm" onclick="showModal('howToPlayModal')">? Help</button>
      <button class="btn btn-sm" onclick="showModal('addPatternModal')">+ Pattern</button>
      <button class="btn btn-sm" onclick="switchGame()">Switch Game</button>
      <button class="btn btn-sm" onclick="resetBoard()">Reset</button>
      <button class="btn btn-sm" onclick="exportSession()">Export</button>
      <button class="btn btn-sm btn-primary" onclick="advanceCycle()">Next Phase ‚Üí</button>
    </div>
  </header>

  <div class="main-layout">
    <!-- LEFT: Toolbox -->
    <div class="toolbox">
      <div class="toolbox-title"><span style="font-size:18px">‚¨°</span> Nexus Toolbox</div>
      <input type="text" class="search-input" placeholder="Search patterns..." oninput="filterLibrary(this.value)">
      <div class="filter-tabs">
        <div class="filter-tab active" onclick="setFilter('all',this)">All</div>
        <div class="filter-tab" onclick="setFilter('pattern',this)">Patterns</div>
        <div class="filter-tab" onclick="setFilter('antipattern',this)">Anti</div>
        <div class="filter-tab" onclick="setFilter('transition',this)">Trans</div>
      </div>
      <div class="hex-list" id="libraryList"></div>
    </div>

    <!-- CENTER: Board -->
    <div class="board-area">
      <div class="board-domains" id="boardDomains"></div>
      <div class="connect-toolbar">
        <span class="ct-label">üîó Links:</span>
        <button class="connect-btn path-btn" onclick="toggleConnectMode('path')"><span class="cb-icon"></span> Transition Path</button>
        <button class="connect-btn nexus-btn" onclick="toggleConnectMode('nexus')"><span class="cb-icon"></span> Transition Nexus</button>
        <span class="connect-status" id="connectStatus" style="display:none"></span>
      </div>
      <div class="board-toast" id="boardToast"></div>
      <div class="board-map" id="boardMap">
        <div style="display:flex;flex:1;overflow:hidden;">
          <!-- Hex board: has its own zone header + scrollable content -->
          <div id="hexBoardArea" style="flex:7;display:flex;flex-direction:column;overflow:hidden;">
            <div class="zone-headers">
              <div class="zh-spacer"></div>
              <div class="zone-col-header hdr-current" style="flex:2"><span class="zone-tag">‚óÄ Current Reality</span></div>
              <div class="zone-col-header hdr-path" style="flex:5"><span class="zone-tag">‚ü∑ Transformation Path</span></div>
            </div>
            <div id="hexScrollArea" style="flex:1;overflow:auto;">
              <div style="position:relative;">
                <div class="axis-label-left">Current Reality ¬∑ Constraints</div>
                <svg class="domains-svg" id="domainsSvg"></svg>
                <svg class="connections-svg" id="connectionsSvg"><defs><marker id="arrowPath" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" class="conn-arrow"/></marker><marker id="arrowNexus" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" class="conn-arrow-nexus"/></marker></defs></svg>
                <div class="honeycomb-grid" id="honeycombGrid">
                  <!-- Rendered by JS: renderBoard() -->
                </div>
              </div>
            </div>
          </div>
          <!-- Fitness panel: has its own zone header rendered by JS -->
          <div class="fitness-panel" id="fitnessPanel">
            <!-- Rendered by JS: renderFitnessPanel() -->
          </div>
        </div>
      </div>
      <div class="board-drivers" id="boardDrivers"><span class="driver-label"><span class="bolt">‚ö°</span> Drivers:</span></div>
      <div class="axis-bottom">Axis A ‚Äî Horizontal: <strong>Evolution of Capability</strong> &nbsp;‚îÇ&nbsp; Axis B ‚Äî Vertical: <strong>Strategic Intent Gradient</strong></div>
    </div>

    <!-- RIGHT: Dashboard -->
    <div class="dashboard">
      <div class="dash-title">Dashboard</div>
      <div class="dash-section">
        <h3>Organizational Fitness</h3>
        <div class="fitness-score" id="fitnessScore" style="color:var(--red)">0</div>
        <div class="fitness-gauge"><div class="fitness-fill" id="fitnessGauge" style="width:0%"></div></div>
        <div class="fitness-label" id="fitnessLabel">Fragile</div>
      </div>
      <div class="dash-section">
        <h3>Board Stats</h3>
        <div class="stat-grid">
          <div class="stat-card"><div class="stat-val" id="sP" style="color:#6b8fd4">0</div><div class="stat-lbl">Patterns</div></div>
          <div class="stat-card"><div class="stat-val" id="sA" style="color:var(--orange)">0</div><div class="stat-lbl">Anti-Patterns</div></div>
          <div class="stat-card"><div class="stat-val" id="sT" style="color:var(--gray)">0</div><div class="stat-lbl">Transitions</div></div>
          <div class="stat-card"><div class="stat-val" id="sAg" style="color:var(--purple)">0</div><div class="stat-lbl">Agents</div></div>
        </div>
      </div>
      <div class="dash-section">
        <h3>Mobius Cycle ‚Äî <span id="cycleCount">Cycle 1</span></h3>
        <div id="cycleSteps"></div>
      </div>
      <div class="dash-section">
        <h3>Agents of Change</h3>
        <p style="font-size:10px;color:var(--text-muted);margin-bottom:6px;text-align:center;">Select an agent, then click a hex on the board.</p>
        <div class="agent-palette">
          <div class="agent-pal" data-agent="human" onclick="selectAgent('human')"><div class="agent-circle human">üßë</div><div class="agent-label">Human</div></div>
          <div class="agent-pal" data-agent="systemic" onclick="selectAgent('systemic')"><div class="agent-circle systemic">üèõ</div><div class="agent-label">Systemic</div></div>
          <div class="agent-pal" data-agent="ai" onclick="selectAgent('ai')"><div class="agent-circle ai">ü§ñ</div><div class="agent-label">AI</div></div>
        </div>
      </div>
      <div class="dash-section">
        <h3>Organizational Domains</h3>
        <p style="font-size:10px;color:var(--text-muted);margin-bottom:6px;text-align:center;">Group hexes visually. Select domain, then click hexes.</p>
        <div id="domainList"></div>
        <button class="btn btn-sm" onclick="showModal('addDomainModal')" style="width:100%;margin-top:6px;">+ Add Domain</button>
      </div>
      <div class="dash-section marker-section">
        <h3>Board Markers</h3>
        <p style="font-size:10px;color:var(--text-muted);margin-bottom:6px;text-align:center;">Select a marker, then click a hex on the board.</p>
        <div class="marker-palette">
          <div class="marker-pal" data-marker="s2f" onclick="selectMarker('s2f')"><div class="marker-circle s2f">S2F</div><div class="marker-label">Safe to Fail Experiment</div></div>
          <div class="marker-pal" data-marker="capability" onclick="selectMarker('capability')"><div class="marker-circle capability">C</div><div class="marker-label">Capability</div></div>
        </div>
      </div>
      <div class="dash-section">
        <h3>Activity Log</h3>
        <div id="activityLog" style="max-height:180px;overflow-y:auto;"></div>
      </div>
    </div>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const PATTERNS = [
  {id:'p1',type:'pattern',name:'Focus on User Needs',signal:'Decisions start from user outcomes',impact:'Aligns investment with value',domain:'Strategy & Portfolio'},
  {id:'p2',type:'pattern',name:'Strategy is Iterative',signal:'Strategy reviews in short cycles',impact:'Faster course correction',domain:'Strategy & Portfolio'},
  {id:'p3',type:'pattern',name:'Use Common Language',signal:'Shared vocabulary across teams',impact:'Reduces misalignment',domain:'Strategy & Portfolio'},
  {id:'p4',type:'pattern',name:'Challenge Assumptions',signal:'Safe space to question decisions',impact:'Prevents blind spots',domain:'Strategy & Portfolio'},
  {id:'p5',type:'pattern',name:'Context Determines Pattern',signal:'No universal best practice',impact:'Right-fit solutions',domain:'Strategy & Portfolio'},
  {id:'p6',type:'pattern',name:'Portfolio as Value Flow',signal:'Prioritized by value, not project',impact:'Better capital allocation',domain:'Strategy & Portfolio'},
  {id:'p7',type:'pattern',name:'Think Small',signal:'Small batches, fast iterations',impact:'Reduces risk and waste',domain:'Product & Delivery'},
  {id:'p8',type:'pattern',name:'Optimize Flow',signal:'WIP limits, queue management',impact:'Faster delivery',domain:'Product & Delivery'},
  {id:'p9',type:'pattern',name:'Move Fast',signal:'Short cycle times, quick decisions',impact:'Competitive responsiveness',domain:'Product & Delivery'},
  {id:'p10',type:'pattern',name:'Effectiveness over Efficiency',signal:'Focus on outcomes, not output',impact:'Real value delivered',domain:'Product & Delivery'},
  {id:'p11',type:'pattern',name:'Manage Failure',signal:'Failures treated as learning',impact:'Psychological safety',domain:'Product & Delivery'},
  {id:'p12',type:'pattern',name:'Stable Teams',signal:'Teams persist across initiatives',impact:'Trust and deep expertise',domain:'Product & Delivery'},
  {id:'p13',type:'pattern',name:'Feedback Loops',signal:'Regular retrospectives with action',impact:'Continuous improvement',domain:'Product & Delivery'},
  {id:'p14',type:'pattern',name:'Use Appropriate Methods',signal:'Tools match problem complexity',impact:'Less over-engineering',domain:'Technology & Architecture'},
  {id:'p15',type:'pattern',name:'Design for Evolution',signal:'Architecture supports change',impact:'Long-term adaptability',domain:'Technology & Architecture'},
  {id:'p16',type:'pattern',name:'Set Exceptional Standards',signal:'Quality gates enforced',impact:'Reliability and trust',domain:'Technology & Architecture'},
  {id:'p17',type:'pattern',name:'Bias Towards Action',signal:'Experiment over analysis paralysis',impact:'Faster learning',domain:'Technology & Architecture'},
  {id:'p18',type:'pattern',name:'Distribute Power',signal:'Local decision authority',impact:'Speed and ownership',domain:'People, Culture & Governance'},
  {id:'p19',type:'pattern',name:'Provide Purpose & Autonomy',signal:'Teams understand the "why"',impact:'Intrinsic motivation',domain:'People, Culture & Governance'},
  {id:'p20',type:'pattern',name:'Be Transparent',signal:'Open information flow',impact:'Trust and alignment',domain:'People, Culture & Governance'},
  {id:'p21',type:'pattern',name:'No One Culture',signal:'Diverse subcultures accepted',impact:'Contextual adaptation',domain:'People, Culture & Governance'},
  {id:'p22',type:'pattern',name:'Be Humble',signal:'Leaders admit uncertainty',impact:'Psychological safety',domain:'People, Culture & Governance'},
  {id:'p23',type:'pattern',name:'Learning as a Habit',signal:'Continuous learning embedded',impact:'Organizational intelligence',domain:'People, Culture & Governance'},
  {id:'p24',type:'pattern',name:'Meaning Drives Adoption',signal:'Change connected to purpose',impact:'Genuine commitment',domain:'People, Culture & Governance'},
  {id:'p25',type:'pattern',name:'Transformation = Habit Change',signal:'Focus on behavior, not structure',impact:'Sustainable change',domain:'People, Culture & Governance'},
  {id:'p26',type:'pattern',name:'Stability Enables Change',signal:'Safe zones preserved',impact:'Immune system respected',domain:'Strategy & Portfolio'},
  {id:'p27',type:'pattern',name:'Intensity > Speed',signal:'Few changes at a time',impact:'No overload',domain:'Strategy & Portfolio'},
  {id:'p28',type:'pattern',name:'No End State',signal:'No fixed target declared',impact:'Continuous adaptation',domain:'Strategy & Portfolio'},
  {id:'p29',type:'pattern',name:'Safe-to-Fail Experiments',signal:'Protected pilots running',impact:'Learning without risk',domain:'Product & Delivery'},
  {id:'p30',type:'pattern',name:'Course Correction',signal:'Regular pivots based on evidence',impact:'Avoids sunk cost traps',domain:'Strategy & Portfolio'},
];
const ANTIPATTERNS = [
  {id:'a1',type:'antipattern',name:'Big Bang Change',signal:'Massive restructuring at once',impact:'Immune system overreaction',domain:'Strategy & Portfolio'},
  {id:'a2',type:'antipattern',name:'Ritualistic Agility',signal:'Ceremonies without learning',impact:'Agile theater, no value',domain:'Product & Delivery'},
  {id:'a3',type:'antipattern',name:'Hero Leadership',signal:'Single leader drives all change',impact:'Single point of failure',domain:'People, Culture & Governance'},
  {id:'a4',type:'antipattern',name:'Governance Theater',signal:'Approval gates without value',impact:'Slow decisions, false safety',domain:'People, Culture & Governance'},
  {id:'a5',type:'antipattern',name:'Copy-Paste Transformation',signal:"Importing another company's model",impact:'Context mismatch',domain:'Strategy & Portfolio'},
  {id:'a6',type:'antipattern',name:'Scaling Before Learning',signal:'Rolling out before validating',impact:'Amplified mistakes',domain:'Product & Delivery'},
  {id:'a7',type:'antipattern',name:'Universal Change Mandate',signal:'Everyone must change at once',impact:'Resistance and fatigue',domain:'People, Culture & Governance'},
  {id:'a8',type:'antipattern',name:'Treating Orgs as Machines',signal:'Mechanical restructuring',impact:'Ignores human dynamics',domain:'People, Culture & Governance'},
  {id:'a9',type:'antipattern',name:'Feedback Without Action',signal:'Retros happen, nothing changes',impact:'Cynicism and disengagement',domain:'Product & Delivery'},
  {id:'a10',type:'antipattern',name:'Priority Inflation',signal:'Everything is P1',impact:'Nothing gets focus',domain:'Strategy & Portfolio'},
  {id:'a11',type:'antipattern',name:'Expert Dependency',signal:'Change requires external experts',impact:'No internal capability',domain:'People, Culture & Governance'},
  {id:'a12',type:'antipattern',name:'Ignoring Power Dynamics',signal:'Informal power not addressed',impact:'Hidden blockers',domain:'People, Culture & Governance'},
  {id:'a13',type:'antipattern',name:'Speed Over Intensity',signal:'Measuring speed not absorption',impact:'Change overload',domain:'Strategy & Portfolio'},
  {id:'a14',type:'antipattern',name:'Local Optimization',signal:'Teams optimize in silos',impact:'System-level dysfunction',domain:'Product & Delivery'},
  {id:'a15',type:'antipattern',name:'Declaring End State',signal:'Fixed target announced',impact:'Rigidity, disillusionment',domain:'Strategy & Portfolio'},
  {id:'a16',type:'antipattern',name:'Blame-Driven Accountability',signal:'Failures punished, not studied',impact:'Fear-based culture',domain:'People, Culture & Governance'},
  {id:'a17',type:'antipattern',name:'Cosmetic Empowerment',signal:'Authority without support',impact:'Burnout and confusion',domain:'People, Culture & Governance'},
  {id:'a18',type:'antipattern',name:'Change Without Meaning',signal:'No narrative for why',impact:'Cynicism and resistance',domain:'People, Culture & Governance'},
  {id:'a19',type:'antipattern',name:'Portfolio as Inventory',signal:'Projects listed, not governed',impact:'No strategic alignment',domain:'Strategy & Portfolio'},
  {id:'a20',type:'antipattern',name:'Change Without Anchors',signal:'No stability zones preserved',impact:'Total disorientation',domain:'Strategy & Portfolio'},
  {id:'a21',type:'antipattern',name:'Unstable Teams',signal:'Frequent team reshuffling',impact:'No trust, no knowledge',domain:'Product & Delivery'},
  {id:'a22',type:'antipattern',name:'Ignoring Immune System',signal:'Resistance labeled dysfunction',impact:'Escalating conflict',domain:'People, Culture & Governance'},
  {id:'a23',type:'antipattern',name:'Over-Standardized Teams',signal:'Same structure forced everywhere',impact:'Context ignored',domain:'People, Culture & Governance'},
  {id:'a24',type:'antipattern',name:'Change Without Arch Readiness',signal:'Process change without tech',impact:'Friction and workarounds',domain:'Technology & Architecture'},
  {id:'a25',type:'antipattern',name:'Safety Sacrificed for Speed',signal:'Cutting corners for velocity',impact:'Technical and cultural debt',domain:'Technology & Architecture'},
];
const TRANSITIONS = [
  {id:'t1',type:'transition',name:'Opt-In Participation',signal:'Voluntary involvement',impact:'Reduces resistance',domain:'People, Culture & Governance'},
  {id:'t2',type:'transition',name:'Protected Sandbox',signal:'Isolated safe environment',impact:'Low-risk experimentation',domain:'Product & Delivery'},
  {id:'t3',type:'transition',name:'Visible Wins Broadcasting',signal:'Successes shared widely',impact:'Builds momentum',domain:'People, Culture & Governance'},
  {id:'t4',type:'transition',name:'Hypothesis-Driven Change',signal:'Explicit hypotheses tested',impact:'Evidence-based decisions',domain:'Strategy & Portfolio'},
  {id:'t5',type:'transition',name:'Community of Practice',signal:'Cross-team learning groups',impact:'Organic knowledge spread',domain:'People, Culture & Governance'},
  {id:'t6',type:'transition',name:'Pull-Based Scaling',signal:'Teams request, not imposed',impact:'Demand-driven growth',domain:'Strategy & Portfolio'},
  {id:'t7',type:'transition',name:'Evidence Walls',signal:'Data visible to all',impact:'Transparent progress',domain:'Product & Delivery'},
  {id:'t8',type:'transition',name:'Parallel Run',signal:'Old and new coexist',impact:'Safe migration',domain:'Technology & Architecture'},
  {id:'t9',type:'transition',name:'Shadow Decision Mapping',signal:'Decisions traced to authority',impact:'Power dynamics revealed',domain:'People, Culture & Governance'},
  {id:'t10',type:'transition',name:'Influencer Seeding',signal:'Key people engaged first',impact:'Social legitimacy',domain:'People, Culture & Governance'},
  {id:'t11',type:'transition',name:'Reframing Without Renaming',signal:'Same terms, new meaning',impact:'Less identity threat',domain:'People, Culture & Governance'},
  {id:'t12',type:'transition',name:'Pattern Sampling',signal:'Try before committing',impact:'Lower adoption barrier',domain:'Product & Delivery'},
  {id:'t13',type:'transition',name:'Min Viable Governance',signal:'Lightest governance that works',impact:'Speed with control',domain:'People, Culture & Governance'},
  {id:'t14',type:'transition',name:'Legacy Respect Mapping',signal:'Old system value recognized',impact:'Less defensive reaction',domain:'Strategy & Portfolio'},
  {id:'t15',type:'transition',name:'Story Before Structure',signal:'Narrative leads, not org chart',impact:'Meaningful change',domain:'People, Culture & Governance'},
  {id:'t16',type:'transition',name:'Time-Boxed Exception',signal:'Temporary relaxation of rules',impact:'Safe experimentation window',domain:'People, Culture & Governance'},
  {id:'t17',type:'transition',name:'Capability Seeding',signal:'Small capability investments',impact:'Foundation for future',domain:'Strategy & Portfolio'},
  {id:'t18',type:'transition',name:'Learning Probes',signal:'Small investigative experiments',impact:'Data before commitment',domain:'Product & Delivery'},
  {id:'t19',type:'transition',name:'Role Authority Trials',signal:'Temporary authority shifts',impact:'Test new decision models',domain:'People, Culture & Governance'},
  {id:'t20',type:'transition',name:'Identity Continuity',signal:'Change framed as evolution',impact:'Identity preserved',domain:'People, Culture & Governance'},
];
const DOMAINS = ['Strategy & Portfolio','Product & Delivery','Technology & Architecture','People, Culture & Governance','Operations'];
const DEFAULT_DRIVERS = ['Cost Efficiency','Time-to-Market','Innovation Stagnation','Customer Experience','Decision Latency','Talent Attrition','Regulatory Pressure','Change Fatigue'];
const PHASES = [{n:'Sense',i:'üëÅ',d:'Observe signals, friction, bottlenecks'},{n:'Focus',i:'üéØ',d:'Pick few habit shifts, limit scope'},{n:'Experiment',i:'üß™',d:'Small change blocks, safe-to-fail'},{n:'Stabilize',i:'üîí',d:'Lock gains, codify minimally'},{n:'Diffuse',i:'üåä',d:'Storytelling, peer adoption, pull'}];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let allItems = [...PATTERNS,...ANTIPATTERNS,...TRANSITIONS];
const ZONES = ['current_strategic','current_operational','path_strategic','path_operational'];

// ‚îÄ‚îÄ Honeycomb grid config ‚îÄ‚îÄ
// Layout: Current Reality (2 cols) | Transformation Path (5 cols) | Improved Fitness = metrics panel
const GRID_COLS = 7;  // 2 (current) + 5 (path) ‚Äî Improved Fitness is a separate panel
const GRID_ROWS = 8;  // 4 per lane (strategic, operational)
const GRID_PAD_LEFT = 42;      // space for lane labels
const HEX_GAP = 6;             // gap between hexes

// Dynamic hex dimensions (computed by computeHexLayout)
let HEX_W = 100, HEX_H = 87;
let ROW_H = 93, COL_W = 106, ROW_OFFSET = 53;

// Columns valid per row: even=all 7, odd=skip last of each zone (col 1 and col 6)
function getColsForRow(row) {
  if (row % 2 === 0) return [0,1,2,3,4,5,6];
  return [0,2,3,4,5]; // skip col 1 (last of current=2 cols), col 6 (last of path=5 cols)
}

function computeHexLayout() {
  const scroll = document.getElementById('hexScrollArea');
  const wrapper = scroll || document.getElementById('honeycombGrid')?.parentElement?.parentElement;
  if (!wrapper) return;
  const aw = wrapper.clientWidth || 900;
  const ah = wrapper.clientHeight || 700;
  // Fill width fully
  const hexFromWidth = (aw - GRID_PAD_LEFT - (GRID_COLS - 1) * HEX_GAP) / GRID_COLS;
  // Soft height cap: don't exceed 2x viewport height
  const hexFromHeight = (ah * 2 - GRID_ROWS * HEX_GAP) / (GRID_ROWS + 0.5) / 0.866;
  HEX_W = Math.max(80, Math.floor(Math.min(hexFromWidth, hexFromHeight)));
  HEX_H = Math.round(HEX_W * 0.866);
  COL_W = HEX_W + HEX_GAP;
  ROW_H = HEX_H + HEX_GAP;
  ROW_OFFSET = COL_W / 2;
}

function hexPixelPosition(row, col) {
  return {
    x: GRID_PAD_LEFT + col * COL_W + (row % 2 === 1 ? ROW_OFFSET : 0),
    y: row * ROW_H
  };
}
function getZoneFromCoords(row, col) {
  const zoneCol = col <= 1 ? 'current' : 'path';
  const lane = row <= 3 ? 'strategic' : 'operational';
  return `${zoneCol}_${lane}`;
}

// ‚îÄ‚îÄ State ‚îÄ‚îÄ
let gridState = {}; // {"row,col": hexId} e.g. {"2,5": "p7"}
let driverAssignments = {};
let selectedDriver = null;
let currentFilter = 'all';
let searchQuery = '';
let cyclePhase = 0, cycleNumber = 1;
let completedPhases = new Set();
let selectedAgent = null;
let agentAssignments = {};
let logEntries = [];
let draggedId = null, dragSource = null; // dragSource is now "row,col" string or null
let activeDomain = null;
let connections = [];
let connectMode = null;
let connectFrom = null;
let boardMarkers = [];
// Organizational domains
let domainDefinitions = []; // [{id, name, color, hexIds:[]}]
let selectedDomainId = null;
let selectedDomainColor = null;
// Fitness panel metrics
let experimentResults = {}; // {hexId: {result:string}}
let practiceRepetitions = {}; // {hexId: number}
const DOMAIN_COLORS = ['#4a90d9','#d94a4a','#2d9d5e','#e8943a','#7b5ea7','#38b2a0','#d9a84a','#d94a8a','#5ea7a7','#8b949e'];
// DB state
let currentGameId = null, currentCompanyId = null;
let autoSaveTimer = null;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// API LAYER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function api(method, path, body) {
  const opts = {method, headers:{'Content-Type':'application/json'}};
  if (body) opts.body = JSON.stringify(body);
  const r = await fetch('/api' + path, opts);
  if (!r.ok) { const e = await r.json().catch(()=>({})); throw new Error(e.error || r.statusText); }
  return r.json();
}
async function saveGame() {
  if (!currentGameId) return;
  showSave('saving');
  try {
    await api('PUT', `/games/${currentGameId}`, {
      board_state: gridState,
      agent_assignments: agentAssignments,
      active_drivers: driverAssignments,
      cycle_number: cycleNumber,
      cycle_phase: cyclePhase,
      completed_phases: [...completedPhases],
      log_entries: logEntries.slice(0,50),
      custom_items: allItems.filter(i=>i.id.startsWith('custom_')),
      fitness_score: parseInt(document.getElementById('fitnessScore').textContent)||0,
      connections: connections,
      board_markers: boardMarkers,
      domain_definitions: domainDefinitions,
      experiment_results: experimentResults,
      practice_repetitions: practiceRepetitions
    });
    showSave('saved');
  } catch(e) { showSave('error'); console.error('Save failed:',e); }
}
function scheduleAutoSave() {
  if (autoSaveTimer) clearTimeout(autoSaveTimer);
  autoSaveTimer = setTimeout(saveGame, 1500);
}
function showSave(s) {
  const el = document.getElementById('saveStatus');
  if (s==='saving') { el.textContent='Saving...'; el.className='save-status saving'; }
  else if (s==='saved') { el.textContent='Saved'; el.className='save-status saved'; setTimeout(()=>{el.textContent='';},2000); }
  else if (s==='error') { el.textContent='Save failed'; el.className='save-status'; }
}
async function loadGame(gameId) {
  const g = await api('GET', `/games/${gameId}`);
  currentGameId = g.id;
  currentCompanyId = g.company_id;
  // Migrate old formats to new gridState coordinate map
  const bs = g.board_state || {};
  if ('current_strategic' in bs || 'current' in bs) {
    // Old zone-based format ‚Äî migrate to gridState
    gridState = {};
    let oldZones;
    if ('current' in bs && !('current_strategic' in bs)) {
      oldZones = {current_strategic:bs.current||[],current_operational:[],path_strategic:bs.path||[],path_operational:[],desired_strategic:bs.desired||[],desired_operational:[]};
    } else {
      oldZones = bs;
    }
    // current=cols 0-1, path=cols 2-6, desired‚Üípath tail cols 4-6
    const zoneOffsets = {current_strategic:[0,0],current_operational:[4,0],path_strategic:[0,2],path_operational:[4,2],desired_strategic:[0,4],desired_operational:[4,4]};
    const zoneCols = {current_strategic:2,current_operational:2,path_strategic:5,path_operational:5,desired_strategic:3,desired_operational:3};
    Object.entries(oldZones).forEach(([zone,items])=>{
      if (!Array.isArray(items)) return;
      const [rowOff,colOff] = zoneOffsets[zone]||[0,0];
      const maxCols = zoneCols[zone]||3;
      items.forEach((hexId,idx)=>{
        const r = rowOff + Math.floor(idx/maxCols);
        const c = colOff + (idx%maxCols);
        if (c < GRID_COLS && r < GRID_ROWS) gridState[`${r},${c}`] = hexId;
      });
    });
  } else {
    gridState = bs;
  }
  // Migrate: remove hexes outside new 7-col grid or on invalid odd-row positions (cols 1,6)
  const migrated = {};
  const toDelete = [];
  Object.entries(gridState).forEach(([k,v])=>{
    const [r,c] = k.split(',').map(Number);
    if (c >= GRID_COLS || r >= GRID_ROWS) { toDelete.push(k); return; }
    if (r % 2 === 1 && (c === 1 || c === 6)) {
      toDelete.push(k);
      const newKey = `${r},${c-1}`;
      if (!gridState[newKey] && !migrated[newKey]) migrated[newKey] = v;
      else migrated[`${r-1},${c}`] = v;
    }
  });
  toDelete.forEach(k=>delete gridState[k]);
  Object.assign(gridState, migrated);
  agentAssignments = g.agent_assignments || {};
  connections = g.connections || [];
  boardMarkers = g.board_markers || [];
  domainDefinitions = g.domain_definitions || [];
  experimentResults = g.experiment_results || {};
  practiceRepetitions = g.practice_repetitions || {};
  const ad = g.active_drivers || {};
  if (Array.isArray(ad)) { driverAssignments = {}; } else { driverAssignments = ad; }
  cycleNumber = g.cycle_number || 1;
  cyclePhase = g.cycle_phase || 0;
  completedPhases = new Set(g.completed_phases || []);
  logEntries = g.log_entries || [];
  (g.custom_items||[]).forEach(ci => { if (!allItems.find(i=>i.id===ci.id)) allItems.push(ci); });
  document.getElementById('gameNameTag').textContent = g.name;
  renderAll();
  addLog('Game loaded: ' + g.name, 'success');
}
function renderAll() {
  renderCategories(); renderDrivers(); renderLibrary(); renderCycleSteps(); renderBoard(); renderDomainList(); renderFitnessPanel(); updateStats(); renderLog();
}
let _resizeTimer;
window.addEventListener('resize', ()=>{ clearTimeout(_resizeTimer); _resizeTimer=setTimeout(()=>{ if(document.getElementById('mainApp').style.display!=='none') renderBoard(); },200); });

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FITNESS PANEL (Improved Fitness metrics)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderFitnessPanel() {
  const panel = document.getElementById('fitnessPanel');
  if (!panel) return;
  const allOnBoard = Object.values(gridState);
  // Capabilities = hexes marked with 'capability'
  const capIds = boardMarkers.filter(m=>m.type==='capability').map(m=>m.hexId).filter(id=>allOnBoard.includes(id));
  // Experiments = hexes marked with 's2f'
  const expIds = boardMarkers.filter(m=>m.type==='s2f').map(m=>m.hexId).filter(id=>allOnBoard.includes(id));
  // Practices = transition hexes on board
  const pracIds = allOnBoard.filter(id=>allItems.find(i=>i.id===id)?.type==='transition');

  const totalReps = Object.values(practiceRepetitions).reduce((s,n)=>s+n,0);
  panel.innerHTML =
    `<div class="zone-headers" style="position:sticky;top:0;z-index:10;border-bottom:1px solid rgba(255,255,255,.06);">` +
      `<div class="zone-col-header hdr-desired" style="flex:1;"><span class="zone-tag">Improved Fitness ‚ñ∂</span></div>` +
    `</div>` +
    `<div class="fp-body">` +
      `<div class="fp-summary">` +
        `<div class="fp-sum-item"><div class="fp-sum-val" style="color:var(--cyan)">${capIds.length}</div><div class="fp-sum-lbl">Capabilities</div></div>` +
        `<div class="fp-sum-item"><div class="fp-sum-val" style="color:var(--orange)">${expIds.length}</div><div class="fp-sum-lbl">Experiments</div></div>` +
        `<div class="fp-sum-item"><div class="fp-sum-val" style="color:var(--purple)">${pracIds.length}</div><div class="fp-sum-lbl">Practices</div></div>` +
        `<div class="fp-sum-item"><div class="fp-sum-val" style="color:var(--green)">${totalReps}</div><div class="fp-sum-lbl">Total Reps</div></div>` +
      `</div>` +
      `<div class="fp-section"><h3>Capabilities Being Experimented</h3>` +
        (capIds.length===0 ? `<div class="fp-empty">Mark hexes with C to track capabilities</div>` :
          capIds.map(id=>{const i=allItems.find(x=>x.id===id);return`<div class="fp-item"><div class="fp-item-name">${i?.name||id}</div></div>`;}).join('')) +
      `</div>` +
      `<div class="fp-section"><h3>Experiments (${expIds.length})</h3>` +
        (expIds.length===0 ? `<div class="fp-empty">Mark hexes with S2F to track experiments</div>` :
          expIds.map(id=>{const i=allItems.find(x=>x.id===id);return`<div class="fp-item"><div class="fp-item-name">${i?.name||id}</div><input class="fp-result-input" placeholder="Result..." value="${(experimentResults[id]||{}).result||''}" oninput="setExperimentResult('${id}',this.value)"></div>`;}).join('')) +
      `</div>` +
      `<div class="fp-section"><h3>Repetitions per Practice</h3>` +
        (pracIds.length===0 ? `<div class="fp-empty">Add transitions to track practice repetitions</div>` :
          pracIds.map(id=>{const i=allItems.find(x=>x.id===id);return`<div class="fp-item"><div class="fp-item-name">${i?.name||id}</div><div class="fp-counter"><button onclick="adjustReps('${id}',-1)">‚àí</button><span class="fp-rep-count">${practiceRepetitions[id]||0}</span><button onclick="adjustReps('${id}',1)">+</button></div></div>`;}).join('')) +
      `</div>` +
    `</div>`;
}
function setExperimentResult(hexId, value) {
  if (!experimentResults[hexId]) experimentResults[hexId]={};
  experimentResults[hexId].result = value;
  scheduleAutoSave();
}
function adjustReps(hexId, delta) {
  practiceRepetitions[hexId] = Math.max(0,(practiceRepetitions[hexId]||0)+delta);
  renderFitnessPanel(); scheduleAutoSave();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GAME SELECT SCREEN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ Intro Menu: "New Game" vs "Continue" ‚îÄ‚îÄ
function showNewGame() {
  document.getElementById('introScreen').classList.add('hidden');
  document.getElementById('mainApp').style.display='none';
  document.getElementById('gameSelect').classList.add('show');
  renderNewGameFlow();
}
function showContinueGame() {
  document.getElementById('introScreen').classList.add('hidden');
  document.getElementById('mainApp').style.display='none';
  document.getElementById('gameSelect').classList.add('show');
  renderContinueFlow();
}
function showGameSelect() {
  document.getElementById('introScreen').classList.add('hidden');
  document.getElementById('mainApp').style.display='none';
  document.getElementById('gameSelect').classList.add('show');
  renderContinueFlow();
}
function switchGame() {
  document.getElementById('mainApp').style.display='none';
  document.getElementById('gameSelect').classList.add('show');
  renderContinueFlow();
}
function backToIntro() {
  document.getElementById('gameSelect').classList.remove('show');
  document.getElementById('introScreen').classList.remove('hidden');
}

// ‚îÄ‚îÄ "New Game" flow: pick or create org ‚Üí create game ‚îÄ‚îÄ
async function renderNewGameFlow() {
  const c = document.getElementById('gsContent');
  let companies = [];
  try { companies = await api('GET','/companies'); } catch(e) { console.error(e); }
  c.innerHTML = `
    <div class="gs-header">
      <div class="gs-back" onclick="backToIntro()">‚Üê Back</div>
      <h2>üéØ New Game</h2>
    </div>
    ${companies.length ? `
      <div class="gs-section-label">Select an existing organization</div>
      ${companies.map(co=>`
        <div class="gs-card" onclick="newGameForCompany('${co.id}','${co.name.replace(/'/g,"\\'")}')">
          <div><div class="gs-name">${co.name}</div><div class="gs-meta">${co.game_count} game${co.game_count!==1?'s':''} created</div></div>
          <div class="gs-arrow">‚Üí</div>
        </div>
      `).join('')}
      <div class="gs-divider"></div>
    ` : ''}
    <div class="gs-section-label">Or create a new organization</div>
    <div class="gs-form">
      <div class="gs-form-title">üè¢ New Organization</div>
      <input id="newCompName" placeholder="Organization name (e.g., NTT DATA DS&A)" autofocus>
      <input id="newCompSlug" placeholder="Slug (e.g., ntt-data-dsa)" oninput="this.value=this.value.toLowerCase().replace(/[^a-z0-9-]/g,'')">
      <button class="btn btn-primary" onclick="createCompAndGame()">Create &amp; Continue ‚Üí</button>
    </div>
  `;
}
async function newGameForCompany(id, name) {
  currentCompanyId = id;
  const c = document.getElementById('gsContent');
  c.innerHTML = `
    <div class="gs-header">
      <div class="gs-back" onclick="renderNewGameFlow()">‚Üê Back</div>
      <h2>New Game</h2>
    </div>
    <div class="gs-org-badge">üè¢ ${name}</div>
    <div style="margin-top:20px"></div>
    <div class="gs-form">
      <div class="gs-form-title">üéÆ Create Game</div>
      <input id="newGameName" placeholder="Game name (e.g., Q1 2026 Transformation Sprint)" autofocus>
      <textarea id="newGameDesc" placeholder="Description ‚Äî what transformation are you exploring? (optional)"></textarea>
      <button class="btn btn-primary" onclick="createGame('${id}')">Start Game ‚Üí</button>
    </div>
  `;
}
async function createCompAndGame() {
  const name = document.getElementById('newCompName').value.trim();
  const slug = document.getElementById('newCompSlug').value.trim();
  if (!name||!slug) { showToast('Fill in both name and slug','warning'); return; }
  try {
    const co = await api('POST','/companies',{name,slug});
    newGameForCompany(co.id, co.name);
  } catch(e) { alert(e.message); }
}

// ‚îÄ‚îÄ "Continue" flow: browse orgs ‚Üí games ‚Üí load ‚îÄ‚îÄ
async function renderContinueFlow() {
  const c = document.getElementById('gsContent');
  let companies = [];
  try { companies = await api('GET','/companies'); } catch(e) { console.error(e); }

  // Fetch all games across all companies for a unified view
  let allGames = [];
  for (const co of companies) {
    try {
      const games = await api('GET',`/companies/${co.id}/games`);
      games.forEach(g => { g._companyName = co.name; g._companyId = co.id; });
      allGames.push(...games);
    } catch(e) { /* skip */ }
  }
  allGames.sort((a,b) => new Date(b.updated_at) - new Date(a.updated_at));

  c.innerHTML = `
    <div class="gs-header">
      <div class="gs-back" onclick="backToIntro()">‚Üê Back</div>
      <h2>üìÇ Saved Games</h2>
    </div>
    ${allGames.length ? allGames.map(g => {
      const d = new Date(g.updated_at);
      const ago = timeAgo(d);
      return `<div class="gs-card" onclick="enterGame('${g.id}')">
        <div>
          <div class="gs-name">${g.name}</div>
          <div class="gs-meta">üè¢ ${g._companyName} ¬∑ Cycle ${g.cycle_number} ¬∑ ${PHASES[g.cycle_phase]?.n||'‚Äî'} ¬∑ ${ago}</div>
        </div>
        <div class="gs-fitness">
          <div><div class="gs-fitness-score">${g.fitness_score}</div><div class="gs-fitness-label">fitness</div></div>
          <div class="gs-arrow">‚Üí</div>
        </div>
      </div>`;
    }).join('') : '<div class="gs-empty">No saved games yet.<br>Start a new game from the main menu!</div>'}
  `;
}
async function createGame(companyId) {
  const name = document.getElementById('newGameName').value.trim();
  const desc = document.getElementById('newGameDesc').value.trim();
  if (!name) { showToast('Enter a game name','warning'); return; }
  try {
    const g = await api('POST',`/companies/${companyId}/games`,{name,description:desc||null});
    enterGame(g.id);
  } catch(e) { alert(e.message); }
}
async function enterGame(gameId) {
  document.getElementById('gameSelect').classList.remove('show');
  document.getElementById('mainApp').style.display='';
  // Reset state
  allItems = [...PATTERNS,...ANTIPATTERNS,...TRANSITIONS];
  gridState = {};
  agentAssignments = {};
  driverAssignments = {};
  connections = [];
  boardMarkers = [];
  domainDefinitions = [];
  selectedDomainId = null;
  cyclePhase=0; cycleNumber=1; completedPhases.clear(); logEntries=[];
  await loadGame(gameId);
}
function timeAgo(date) {
  const s = Math.floor((Date.now()-date)/1000);
  if (s<60) return 'just now';
  if (s<3600) return Math.floor(s/60)+'m ago';
  if (s<86400) return Math.floor(s/3600)+'h ago';
  return Math.floor(s/86400)+'d ago';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LIBRARY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderLibrary() {
  const list = document.getElementById('libraryList');
  list.innerHTML = '';
  const q = searchQuery.toLowerCase();
  allItems.filter(item => {
    if (currentFilter!=='all' && item.type!==currentFilter) return false;
    if (activeDomain && item.domain!==activeDomain) return false;
    if (q) return item.name.toLowerCase().includes(q)||item.signal.toLowerCase().includes(q)||item.domain.toLowerCase().includes(q);
    return true;
  }).forEach(item => {
    const onBoard = isOnBoard(item.id);
    const card = document.createElement('div');
    card.className = `hex-card${onBoard?' on-board':''}`;
    card.draggable = !onBoard;
    card.innerHTML = `
      <div class="hex-mini ${item.type}">${item.type==='pattern'?'P':item.type==='antipattern'?'A':'T'}</div>
      <div class="hex-info">
        <div class="hex-name">${item.name}</div>
        <div class="hex-signal">${item.signal}</div>
        <div class="hex-domain">${item.domain}</div>
      </div>
    `;
    card.addEventListener('dragstart', e=>{draggedId=item.id;dragSource=null;e.dataTransfer.effectAllowed='move';showZoneGuidance(item.type);});
    card.addEventListener('dragend', ()=>clearZoneGuidance());
    list.appendChild(card);
  });
}
function filterLibrary(v){searchQuery=v;renderLibrary();}
function setFilter(f,el){currentFilter=f;document.querySelectorAll('.filter-tab').forEach(t=>t.classList.remove('active'));el.classList.add('active');renderLibrary();}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HONEYCOMB BOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function isOnBoard(id){return Object.values(gridState).includes(id);}
function getHexCoords(id){for(const[k,v]of Object.entries(gridState)){if(v===id)return k;}return null;}

function renderBoard() {
  const container = document.getElementById('honeycombGrid');
  container.innerHTML = '';
  computeHexLayout();
  // Set CSS custom properties for text scaling
  container.style.setProperty('--hex-w', HEX_W + 'px');
  // Compute grid size (even rows define width)
  const laneRows = GRID_ROWS / 2;
  const totalW = GRID_PAD_LEFT + (GRID_COLS - 1) * COL_W + HEX_W;
  const strategicH = laneRows * ROW_H;
  const totalH = GRID_ROWS * ROW_H + HEX_H * 0.5;
  container.style.width = totalW + 'px';
  container.style.height = totalH + 'px';
  container.style.position = 'relative';

  // Zone background overlays ‚Äî current (2/7) + path (5/7)
  const gridWidth = totalW - GRID_PAD_LEFT;
  [{cls:'zb-current',left:0,width:gridWidth*2/7},{cls:'',left:gridWidth*2/7,width:gridWidth*5/7}].forEach(z=>{
    [0,1].forEach(li=>{
      const div = document.createElement('div');
      div.className = `zone-bg ${z.cls}`;
      div.style.left = (GRID_PAD_LEFT + z.left) + 'px';
      div.style.top = (li * strategicH) + 'px';
      div.style.width = z.width + 'px';
      div.style.height = (li === 0 ? strategicH : totalH - strategicH) + 'px';
      container.appendChild(div);
    });
  });

  // Lane divider
  const divider = document.createElement('div');
  divider.className = 'lane-divider';
  divider.style.top = Math.round(strategicH) + 'px';
  container.appendChild(divider);

  // Lane labels
  [{cls:'strategic',rows:[0, laneRows-1],text:'Strategic',sub:'Intent ¬∑ Meaning'},{cls:'operational',rows:[laneRows, GRID_ROWS-1],text:'Operational',sub:'Structure ¬∑ Process'}].forEach(l=>{
    const p1y = hexPixelPosition(l.rows[0],0).y;
    const p2y = hexPixelPosition(l.rows[1],0).y + HEX_H;
    const lbl = document.createElement('div');
    lbl.className = `lane-label-abs ${l.cls}`;
    lbl.style.top = p1y + 'px'; lbl.style.height = (p2y - p1y) + 'px';
    lbl.innerHTML = `<div class="ll-text">${l.text}<span class="ll-sub">${l.sub}</span></div>`;
    container.appendChild(lbl);
  });

  // Render hex cells (odd rows: 2 per zone for symmetric honeycomb)
  for (let row = 0; row < GRID_ROWS; row++) {
    const validCols = getColsForRow(row);
    for (const col of validCols) {
      const key = `${row},${col}`;
      const hexId = gridState[key] || null;
      const pos = hexPixelPosition(row, col);
      const cell = document.createElement('div');
      cell.className = `hex-cell${hexId ? '' : ' empty'}`;
      cell.style.left = pos.x + 'px'; cell.style.top = pos.y + 'px';
      cell.style.width = HEX_W + 'px'; cell.style.height = HEX_H + 'px';
      cell.dataset.row = row; cell.dataset.col = col;
      // Drag-drop
      cell.addEventListener('dragover', e=>{e.preventDefault();e.dataTransfer.dropEffect='move';cell.classList.add('drag-over');});
      cell.addEventListener('dragleave', ()=>cell.classList.remove('drag-over'));
      cell.addEventListener('drop', e=>{
        e.preventDefault();e.stopPropagation();cell.classList.remove('drag-over');
        clearZoneGuidance();
        if(!draggedId) return;
        const zone = getZoneFromCoords(row,col);
        const itemObj = allItems.find(x=>x.id===draggedId);
        const guide = itemObj ? GUIDANCE[itemObj.type] : null;
        if(guide && ![...guide.best,...guide.ok].includes(zone)){showToast(`‚ö†Ô∏è ${guide.tip}`,'warning');}
        if(gridState[key] && gridState[key]!==draggedId){showToast('Cell occupied','warning');return;}
        // Remove from old position
        if(dragSource){delete gridState[dragSource];}
        else{for(const[k,v]of Object.entries(gridState)){if(v===draggedId){delete gridState[k];break;}}}
        gridState[key]=draggedId;
        addLog(`${dragSource?'Moved':'Placed'} "${itemObj?.name}" ‚Üí ${zonePrettyName(zone)}`,'action');
        draggedId=null;dragSource=null;
        renderBoard();renderLibrary();updateStats();scheduleAutoSave();
      });
      // Cell background
      const bg = document.createElement('div');
      bg.className = 'hex-cell-bg';
      cell.appendChild(bg);
      // Hex content
      if(hexId){
        const item = allItems.find(x=>x.id===hexId);
        if(!item){container.appendChild(cell);continue;}
        const dim = activeDomain && item.domain!==activeDomain ? ' domain-dimmed':'';
        const cm = connectMode ? ' connect-mode':'';
        const cs = connectFrom===hexId ? ' connect-source':'';
        // Domain outline
        const hexDomain = domainDefinitions.find(d=>d.hexIds.includes(hexId));
        const domCls = hexDomain ? ' has-domain':'';
        const el = document.createElement('div');
        el.className = `board-hex ${item.type}${dim}${cm}${cs}${domCls}`;
        el.draggable = !connectMode;
        el.setAttribute('data-hex-id', hexId);
        const agents = (agentAssignments[hexId]||[]).map(a=>`<div class="agent-badge ${a.type}" title="${a.type} agent" onclick="event.stopPropagation();assignAgent('${hexId}','${a.type}')">${a.type==='human'?'üßë':a.type==='systemic'?'üèõ':'ü§ñ'}</div>`).join('');
        const markers = boardMarkers.filter(m=>m.hexId===hexId).map(m=>`<div class="marker-badge ${m.type}" title="${m.type==='s2f'?'S2F':'Capability'}" onclick="event.stopPropagation();toggleMarker('${hexId}','${m.type}')">${m.type==='s2f'?'S2F':'C'}</div>`).join('');
        const drvs = (driverAssignments[hexId]||[]).map(d=>`<div class="driver-badge" title="${d}" onclick="event.stopPropagation();assignDriver('${hexId}','${d}')"><span class="db-bolt">‚ö°</span>${d}</div>`).join('');
        const icons = agents + markers;
        el.innerHTML = `
          <button class="remove-hex" onclick="event.stopPropagation();removeHex('${hexId}','${key}')">√ó</button>
          <div class="board-hex-shape">
            <div class="bh-text">
              <div class="bh-type">${item.type==='pattern'?'PATTERN':item.type==='antipattern'?'ANTI-PATTERN':'TRANSITION'}</div>
              <div class="bh-name" title="${item.name}">${item.name}</div>
              <div class="bh-signal" title="${item.signal}">${item.signal}</div>
              ${drvs?'<div class="bh-drivers">'+drvs+'</div>':''}
            </div>
            ${icons?'<div class="bh-bottom">'+icons+'</div>':''}
          </div>
        `;
        el.addEventListener('click',()=>{
          if(connectMode){handleConnectClick(hexId);return;}
          if(selectedDomainId){toggleHexDomain(hexId);return;}
          if(selectedDriver){assignDriver(hexId,selectedDriver);selectedDriver=null;renderDrivers();return;}
          if(selectedMarker){toggleMarker(hexId,selectedMarker);selectedMarker=null;document.querySelectorAll('.marker-pal').forEach(m=>m.classList.remove('selected'));return;}
          if(selectedAgent){assignAgent(hexId,selectedAgent);selectedAgent=null;document.querySelectorAll('.agent-pal').forEach(a=>a.classList.remove('selected'));}
        });
        el.addEventListener('dragstart',e=>{
          if(connectMode){e.preventDefault();return;}
          draggedId=hexId;dragSource=key;e.dataTransfer.effectAllowed='move';
          // Clean drag ghost: clone just this hex
          const ghost=el.cloneNode(true);
          ghost.style.position='absolute';ghost.style.left='-9999px';ghost.style.width=HEX_W+'px';ghost.style.height=HEX_H+'px';
          document.body.appendChild(ghost);
          e.dataTransfer.setDragImage(ghost,HEX_W/2,HEX_H/2);
          requestAnimationFrame(()=>ghost.remove());
          showZoneGuidance(item.type);
        });
        el.addEventListener('dragend',()=>clearZoneGuidance());
        cell.appendChild(el);
      }
      container.appendChild(cell);
    }
  }
  requestAnimationFrame(()=>{renderConnections();renderDomainBoundaries();});
}
function renderAllZones(){renderBoard();renderLibrary();updateStats();}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PLACEMENT GUIDANCE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Which zones each type SHOULD go in (Codex rules)
// Codex Core Mechanic (Section 4): Where things go on the map
// 4.1 Anti-Patterns: always LEFT, cluster bottom-left (operational = habits/inertia)
// 4.2 Patterns: center-right (rarely far right). Proven moves, not guarantees
// 4.3 Transitions: diagonally between anti-patterns & patterns. Safe moves
// 4.4 Agents: ON THE PATH, not at the destination. Forces, not owners
const GUIDANCE = {
  antipattern: {
    best: ['current_operational'],
    ok:   ['current_strategic'],
    label: 'Current Reality (bottom-left)',
    tip:   'Anti-Patterns always start left. They cluster near bottom-left ‚Äî habits, inertia, operational constraints.'
  },
  pattern: {
    best: ['path_strategic'],
    ok:   ['path_operational'],
    label: 'Transformation Path',
    tip:   'Patterns live in the Transformation Path as proven directional moves toward improved fitness.'
  },
  transition: {
    best: ['path_strategic','path_operational'],
    ok:   ['current_strategic','desired_operational'],
    label: 'Transformation Path (diagonally)',
    tip:   'Transitions sit between anti-patterns and patterns. Place diagonally ‚Äî they are safe bridges.'
  }
};
function showZoneGuidance(itemType) {
  const guide = GUIDANCE[itemType];
  if (!guide) return;
  document.querySelectorAll('.hex-cell').forEach(cell => {
    const r = parseInt(cell.dataset.row), c = parseInt(cell.dataset.col);
    const zone = getZoneFromCoords(r,c);
    if (guide.best.includes(zone)) cell.classList.add('guide-best');
    else if (guide.ok.includes(zone)) cell.classList.add('guide-yes');
    else cell.classList.add('guide-no');
  });
}
function clearZoneGuidance() {
  document.querySelectorAll('.hex-cell').forEach(c=>c.classList.remove('guide-best','guide-yes','guide-no'));
}
let _toastTimer = null;
function showToast(msg, type='warning') {
  const el = document.getElementById('boardToast');
  el.textContent = msg;
  el.className = `board-toast ${type} show`;
  if (_toastTimer) clearTimeout(_toastTimer);
  _toastTimer = setTimeout(()=>{ el.classList.remove('show'); }, 3500);
}
function checkPlacement(itemId, zone) {
  const item = allItems.find(i=>i.id===itemId);
  if (!item) return;
  const guide = GUIDANCE[item.type];
  if (!guide) return;
  const allOk = [...guide.best, ...guide.ok];
  if (!allOk.includes(zone)) {
    showToast(`üí° ${guide.tip}`,'warning');
  } else if (guide.best.includes(zone)) {
    // Perfect placement ‚Äî no toast needed
  }
}
// 4.4 Agents: highlight hexes ON THE PATH (not destination)
function showAgentHint() {
  document.querySelectorAll('.board-hex.agent-hint').forEach(h=>h.classList.remove('agent-hint'));
  if (!selectedAgent) return;
  for(const[key,hexId]of Object.entries(gridState)){
    const[r,c]=key.split(',').map(Number);
    if(getZoneFromCoords(r,c).startsWith('path_')){
      const el=document.querySelector(`[data-hex-id="${hexId}"]`);
      if(el) el.classList.add('agent-hint');
    }
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DRAG & DROP (cell-level drops handled in renderZone)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function zonePrettyName(z){
  const map={current_strategic:'Current Reality (Strategic)',current_operational:'Current Reality (Operational)',path_strategic:'Transformation Path (Strategic)',path_operational:'Transformation Path (Operational)'};
  return map[z]||z;
}
function removeHex(id,coordKey){
  delete gridState[coordKey];
  delete agentAssignments[id];
  delete driverAssignments[id];
  boardMarkers=boardMarkers.filter(m=>m.hexId!==id);
  connections=connections.filter(c=>c.from!==id&&c.to!==id);
  domainDefinitions.forEach(d=>{d.hexIds=d.hexIds.filter(h=>h!==id);});
  const item=allItems.find(i=>i.id===id);
  addLog(`Removed "${item?.name}"`,'warning');
  renderAllZones();scheduleAutoSave();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AGENTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function selectAgent(type){
  if(selectedAgent===type){selectedAgent=null;document.querySelectorAll('.agent-pal').forEach(a=>a.classList.remove('selected'));showAgentHint();return;}
  selectedAgent=type;
  // Deselect markers and drivers when selecting agent
  selectedMarker=null; document.querySelectorAll('.marker-pal').forEach(m=>m.classList.remove('selected'));
  selectedDriver=null; renderDrivers();
  document.querySelectorAll('.agent-pal').forEach(a=>a.classList.remove('selected'));
  document.querySelector(`.agent-pal[data-agent="${type}"]`).classList.add('selected');
  showAgentHint();
  showToast('üí° Agents are placed ON THE PATH ‚Äî they represent who can activate movement, not owners','hint');
}
function assignAgent(hexId,type){
  if(!agentAssignments[hexId])agentAssignments[hexId]=[];
  if(agentAssignments[hexId].some(a=>a.type===type)){
    agentAssignments[hexId]=agentAssignments[hexId].filter(a=>a.type!==type);
    addLog(`Removed ${type} agent from "${allItems.find(i=>i.id===hexId)?.name}"`,'warning');
  } else {
    agentAssignments[hexId].push({type});
    addLog(`Assigned ${type} agent to "${allItems.find(i=>i.id===hexId)?.name}"`,'success');
  }
  showAgentHint();
  renderAllZones();scheduleAutoSave();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONNECTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleConnectMode(type) {
  if (connectMode === type) { connectMode=null; connectFrom=null; } else { connectMode=type; connectFrom=null; }
  document.querySelectorAll('.connect-btn').forEach(b=>b.classList.remove('active'));
  if (connectMode) document.querySelector(`.connect-btn.${connectMode==='path'?'path':'nexus'}-btn`).classList.add('active');
  updateConnectStatus();
  renderAllZones();
}
function updateConnectStatus() {
  const el=document.getElementById('connectStatus');
  if (!connectMode) { el.style.display='none'; return; }
  el.style.display='inline';
  if (!connectFrom) el.textContent=`Click a source hexagon to start a ${connectMode==='path'?'Transition Path':'Transition Nexus'}`;
  else { const item=allItems.find(i=>i.id===connectFrom); el.textContent=`"${item?.name}" selected ‚Äî now click the target hexagon`; }
}
function handleConnectClick(hexId) {
  if (!connectMode) return;
  if (!connectFrom) {
    connectFrom = hexId;
    updateConnectStatus();
    renderAllZones();
    return;
  }
  if (connectFrom === hexId) { connectFrom=null; updateConnectStatus(); renderAllZones(); return; }
  // Check duplicate
  if (connections.some(c=>c.from===connectFrom && c.to===hexId && c.type===connectMode)) {
    connectFrom=null; updateConnectStatus(); renderAllZones(); return;
  }
  connections.push({id:'conn_'+Date.now(), from:connectFrom, to:hexId, type:connectMode});
  const fromItem=allItems.find(i=>i.id===connectFrom);
  const toItem=allItems.find(i=>i.id===hexId);
  addLog(`Connected "${fromItem?.name}" ‚Üí "${toItem?.name}" (${connectMode==='path'?'Transition Path':'Transition Nexus'})`,'success');
  connectFrom=null;
  updateConnectStatus();
  renderAllZones();
  scheduleAutoSave();
}
function deleteConnection(connId) {
  connections = connections.filter(c=>c.id!==connId);
  addLog('Connection removed','warning');
  renderConnections();
  scheduleAutoSave();
}
// ‚îÄ‚îÄ Connection geometry helpers ‚îÄ‚îÄ
// Get hex bounding box relative to the scrollable hex area
function getHexRect(hexId) {
  const el = document.querySelector(`[data-hex-id="${hexId}"]`);
  const scroll = document.getElementById('hexScrollArea');
  if (!el || !scroll) return null;
  const eR = el.getBoundingClientRect();
  const mR = scroll.getBoundingClientRect();
  const sx = scroll.scrollLeft, sy = scroll.scrollTop;
  return { x:eR.left-mR.left+sx, y:eR.top-mR.top+sy, w:eR.width, h:eR.height, cy:eR.top-mR.top+sy+eR.height/2 };
}
// ‚îÄ‚îÄ Connection routing: ALWAYS curves above or below, never through cards ‚îÄ‚îÄ
function getAllHexRects(excludeIds) {
  const rects = [];
  document.querySelectorAll('[data-hex-id]').forEach(el => {
    const id = el.getAttribute('data-hex-id');
    if (excludeIds.includes(id)) return;
    const r = getHexRect(id);
    if (r) rects.push(r);
  });
  return rects;
}

function buildRoute(fromR, toR, allObstacles) {
  // Find the top-most and bottom-most edges of ALL hexes on the board
  // so we can route cleanly above or below everything
  let boardTop = Infinity, boardBottom = -Infinity;
  // Include source and target in the boundary calculation
  const allRects = [...allObstacles, fromR, toR];
  allRects.forEach(r => {
    boardTop = Math.min(boardTop, r.y);
    boardBottom = Math.max(boardBottom, r.y + r.h);
  });

  const GAP = 25; // clearance above/below all hexes
  const fromCx = fromR.x + fromR.w / 2;
  const fromCy = fromR.cy;
  const toCx = toR.x + toR.w / 2;
  const toCy = toR.cy;

  // Determine if source is left or right of target
  const goingRight = fromCx < toCx;

  // Exit point: bottom or top of source hex
  // Entry point: bottom or top of target hex
  // Route: exit ‚Üí curve down (or up) ‚Üí travel horizontally ‚Üí curve up (or down) ‚Üí enter

  // Decide above vs below:
  // - If both hexes are in the top lane, route below
  // - If both hexes are in the bottom lane, route above
  // - Otherwise, route through the closest edge
  const avgY = (fromCy + toCy) / 2;
  const midBoard = (boardTop + boardBottom) / 2;
  const routeBelow = avgY <= midBoard; // if hexes are in upper half, go below

  const curveY = routeBelow
    ? Math.max(fromR.y + fromR.h, toR.y + toR.h) + GAP
    : Math.min(fromR.y, toR.y) - GAP;

  // Anchor points on hex edges
  const sx = goingRight ? fromR.x + fromR.w : fromR.x;
  const sy = fromCy;
  const ex = goingRight ? toR.x : toR.x + toR.w;
  const ey = toCy;

  // For adjacent hexes (close together), use a gentle curve
  // For distant hexes, use a wider arc
  const dist = Math.abs(toCx - fromCx);
  const cpOffset = Math.max(dist * 0.3, 40);

  // Build SVG cubic bezier: two control points push the curve above/below
  const cp1x = sx + (goingRight ? cpOffset : -cpOffset);
  const cp1y = curveY;
  const cp2x = ex + (goingRight ? -cpOffset : cpOffset);
  const cp2y = curveY;

  const mx = (sx + ex) / 2;
  const my = curveY;

  return {
    d: `M${sx},${sy} C${cp1x},${cp1y} ${cp2x},${cp2y} ${ex},${ey}`,
    midPt: { x: mx, y: my }
  };
}

function renderConnections() {
  const svg = document.getElementById('connectionsSvg');
  const defs = svg.querySelector('defs');
  svg.innerHTML = '';
  svg.appendChild(defs);
  const grid = document.getElementById('honeycombGrid');
  if (grid) {
    svg.setAttribute('width', grid.scrollWidth);
    svg.setAttribute('height', grid.scrollHeight);
    svg.style.width = grid.scrollWidth + 'px';
    svg.style.height = grid.scrollHeight + 'px';
  }
  connections.forEach(conn => {
    const fromR = getHexRect(conn.from);
    const toR = getHexRect(conn.to);
    if (!fromR || !toR) return;
    const obstacles = getAllHexRects([conn.from, conn.to]);
    const route = buildRoute(fromR, toR, obstacles);
    const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
    // Wider invisible hit area
    const hit = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    hit.setAttribute('d', route.d);
    hit.setAttribute('class', 'conn-hit');
    g.appendChild(hit);
    // Visible path
    const p = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    p.setAttribute('d', route.d);
    p.setAttribute('class', conn.type === 'path' ? 'conn-path' : 'conn-nexus');
    p.setAttribute('marker-end', conn.type === 'path' ? 'url(#arrowPath)' : 'url(#arrowNexus)');
    g.appendChild(p);
    // Delete button at midpoint
    const mp = route.midPt;
    const del = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    del.setAttribute('cx', mp.x); del.setAttribute('cy', mp.y);
    del.setAttribute('r', '7'); del.setAttribute('class', 'conn-delete');
    del.addEventListener('click', () => deleteConnection(conn.id));
    g.appendChild(del);
    const delX = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    delX.setAttribute('x', mp.x); delX.setAttribute('y', mp.y + 3);
    delX.setAttribute('text-anchor', 'middle'); delX.setAttribute('font-size', '9');
    delX.setAttribute('fill', '#fff'); delX.setAttribute('class', 'conn-delete');
    delX.setAttribute('style', 'pointer-events:none');
    delX.textContent = '√ó';
    g.appendChild(delX);
    svg.appendChild(g);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MARKERS (S2F / Capabilities)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let selectedMarker = null;
function selectMarker(type) {
  if (selectedMarker===type) { selectedMarker=null; document.querySelectorAll('.marker-pal').forEach(m=>m.classList.remove('selected')); return; }
  selectedMarker=type;
  // Deselect agents and drivers when selecting marker
  selectedAgent=null; document.querySelectorAll('.agent-pal').forEach(a=>a.classList.remove('selected'));
  selectedDriver=null; renderDrivers();
  document.querySelectorAll('.marker-pal').forEach(m=>m.classList.remove('selected'));
  document.querySelector(`.marker-pal[data-marker="${type}"]`).classList.add('selected');
}
function toggleMarker(hexId, type) {
  const idx = boardMarkers.findIndex(m=>m.hexId===hexId && m.type===type);
  if (idx>=0) {
    boardMarkers.splice(idx,1);
    addLog(`Removed ${type==='s2f'?'S2F Experiment':'Capability'} from "${allItems.find(i=>i.id===hexId)?.name}"`,'warning');
  } else {
    boardMarkers.push({id:'mk_'+Date.now(), hexId, type});
    addLog(`Added ${type==='s2f'?'S2F Experiment':'Capability'} to "${allItems.find(i=>i.id===hexId)?.name}"`,'success');
  }
  renderAllZones(); renderFitnessPanel(); scheduleAutoSave();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CATEGORIES & DRIVERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderCategories(){
  const c=document.getElementById('boardDomains');c.innerHTML='';
  DOMAINS.forEach(d=>{
    const el=document.createElement('div');
    el.className=`domain-label${activeDomain===d?' active':''}`;
    el.textContent=d;
    el.onclick=()=>{activeDomain=activeDomain===d?null:d;renderCategories();renderAllZones();};
    c.appendChild(el);
  });
}
function getUsedDrivers(){
  const s=new Set();
  Object.values(driverAssignments).forEach(arr=>arr.forEach(d=>s.add(d)));
  return s;
}
function renderDrivers(){
  const c=document.getElementById('boardDrivers');
  const used=getUsedDrivers();
  c.innerHTML='<span class="driver-label"><span class="bolt">‚ö°</span> Drivers:</span>';
  DEFAULT_DRIVERS.forEach(d=>{
    const ch=document.createElement('div');
    const sel=selectedDriver===d;
    const inUse=used.has(d);
    ch.className=`driver-chip${sel?' selected':''}${!sel&&inUse?' used':''}`;
    ch.textContent=d;
    ch.onclick=()=>{
      selectedDriver=selectedDriver===d?null:d;
      // Deselect agents/markers
      selectedAgent=null;document.querySelectorAll('.agent-pal').forEach(a=>a.classList.remove('selected'));
      selectedMarker=null;document.querySelectorAll('.marker-pal').forEach(m=>m.classList.remove('selected'));
      renderDrivers();updateDriverStatus();
    };
    c.appendChild(ch);
  });
  const st=document.getElementById('driverStatus');
  if(st) updateDriverStatus();
}
function updateDriverStatus(){
  let st=document.getElementById('driverStatus');
  if(!st){const c=document.getElementById('boardDrivers');st=document.createElement('span');st.id='driverStatus';st.className='driver-status';c.appendChild(st);}
  if(selectedDriver){st.style.display='inline';st.textContent=`"${selectedDriver}" selected ‚Äî click a hex to link`;}
  else{st.style.display='none';}
}
function assignDriver(hexId,driver){
  if(!driverAssignments[hexId])driverAssignments[hexId]=[];
  const idx=driverAssignments[hexId].indexOf(driver);
  if(idx>=0){
    driverAssignments[hexId].splice(idx,1);
    if(!driverAssignments[hexId].length)delete driverAssignments[hexId];
    addLog(`Unlinked "${driver}" from "${allItems.find(i=>i.id===hexId)?.name}"`,'warning');
  } else {
    driverAssignments[hexId].push(driver);
    addLog(`Linked driver "${driver}" ‚Üí "${allItems.find(i=>i.id===hexId)?.name}"`,'success');
  }
  renderAllZones();renderDrivers();scheduleAutoSave();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MOBIUS CYCLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderCycleSteps(){
  document.getElementById('cycleCount').textContent=`Cycle ${cycleNumber}`;
  document.getElementById('cycleSteps').innerHTML=PHASES.map((p,i)=>{
    let cls='cycle-step';if(i===cyclePhase)cls+=' active';if(completedPhases.has(i))cls+=' completed';
    return `<div class="${cls}" onclick="setCyclePhase(${i})"><div class="cycle-icon">${p.i}</div><div><div class="cycle-name">${p.n}</div><div class="cycle-desc">${p.d}</div></div></div>`;
  }).join('');
}
function setCyclePhase(i){cyclePhase=i;renderCycleSteps();scheduleAutoSave();}
function advanceCycle(){
  completedPhases.add(cyclePhase);
  if(cyclePhase<4){cyclePhase++;addLog(`Entered ${PHASES[cyclePhase].n} phase`,'success');}
  else{cycleNumber++;cyclePhase=0;completedPhases.clear();addLog(`Cycle ${cycleNumber-1} complete! Starting Cycle ${cycleNumber}`,'success');}
  renderCycleSteps();updateStats();scheduleAutoSave();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATS & FITNESS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateStats(){
  const all=Object.values(gridState);
  const p=all.filter(id=>allItems.find(i=>i.id===id)?.type==='pattern').length;
  const a=all.filter(id=>allItems.find(i=>i.id===id)?.type==='antipattern').length;
  const t=all.filter(id=>allItems.find(i=>i.id===id)?.type==='transition').length;
  const ag=Object.values(agentAssignments).reduce((s,arr)=>s+arr.length,0);
  document.getElementById('sP').textContent=p;
  document.getElementById('sA').textContent=a;
  document.getElementById('sT').textContent=t;
  document.getElementById('sAg').textContent=ag;
  // Derive zone membership from coordinates
  let f=0;
  const path=[],current=[];
  for(const[key,hexId]of Object.entries(gridState)){
    const[r,c]=key.split(',').map(Number);
    const zone=getZoneFromCoords(r,c);
    if(zone.startsWith('path_'))path.push(hexId);
    else current.push(hexId);
  }
  path.forEach(id=>{const i=allItems.find(x=>x.id===id);if(i?.type==='pattern')f+=3;if(i?.type==='transition')f+=2;if(i?.type==='antipattern')f-=1;});
  current.forEach(id=>{const i=allItems.find(x=>x.id===id);if(i?.type==='antipattern')f+=.5;if(i?.type==='pattern')f+=1;});
  // Bonus: practice reps
  f += Object.values(practiceRepetitions).reduce((s,n)=>s+n*0.5,0);
  const totalDriverLinks=Object.values(driverAssignments).reduce((s,arr)=>s+arr.length,0);
  f+=ag*.5+totalDriverLinks*.5+(cycleNumber-1)*2;
  f=Math.max(0,Math.min(100,Math.round(f)));
  document.getElementById('fitnessScore').textContent=f;
  document.getElementById('fitnessGauge').style.width=f+'%';
  let lbl='Fragile',col='var(--red)';
  if(f>=80){lbl='Antifragile';col='var(--cyan)';}else if(f>=60){lbl='Resilient';col='var(--green)';}else if(f>=40){lbl='Stable';col='var(--orange)';}else if(f>=20){lbl='Emerging';col='var(--orange)';}
  document.getElementById('fitnessLabel').textContent=lbl;
  document.getElementById('fitnessScore').style.color=col;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function addLog(msg,type='action'){
  const t=new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'});
  logEntries.unshift({message:msg,type,time:t});
  if(logEntries.length>50)logEntries.pop();
  renderLog();
}
function renderLog(){
  document.getElementById('activityLog').innerHTML=logEntries.slice(0,15).map(e=>`<div class="log-entry ${e.type}"><span class="log-time">${e.time}</span> ${e.message}</div>`).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CUSTOM PATTERNS, RESET, EXPORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function addCustomPattern(){
  const type=document.getElementById('newType').value;
  const name=document.getElementById('newName').value.trim();
  if(!name)return;
  allItems.push({id:'custom_'+Date.now(),type,name,signal:document.getElementById('newSignal').value.trim()||'Custom',impact:document.getElementById('newImpact').value.trim()||'Custom',domain:document.getElementById('newDomain').value});
  addLog(`Created custom ${type}: "${name}"`,'success');
  renderLibrary();closeModal('addPatternModal');
  document.getElementById('newName').value='';document.getElementById('newSignal').value='';document.getElementById('newImpact').value='';
  scheduleAutoSave();
}
function resetBoard(){
  if(!confirm('Reset the entire board?'))return;
  gridState={};agentAssignments={};driverAssignments={};connections=[];boardMarkers=[];domainDefinitions=[];experimentResults={};practiceRepetitions={};selectedDomainId=null;cyclePhase=0;cycleNumber=1;completedPhases.clear();logEntries=[];
  renderAll();addLog('Board reset','warning');scheduleAutoSave();
}
function exportSession(){
  const data={timestamp:new Date().toISOString(),gameId:currentGameId,gridState,connections,agentAssignments,driverAssignments,domainDefinitions,experimentResults,practiceRepetitions,cycleNumber,cyclePhase,fitness:document.getElementById('fitnessScore').textContent,log:logEntries.slice(0,30),customItems:allItems.filter(i=>i.id.startsWith('custom_'))};
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`nexus-${new Date().toISOString().slice(0,10)}.json`;a.click();
  addLog('Session exported','success');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ORGANIZATIONAL DOMAINS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderDomainList(){
  const c=document.getElementById('domainList');
  if(!c)return;
  c.innerHTML=domainDefinitions.map(d=>`
    <div class="domain-item${selectedDomainId===d.id?' selected':''}" onclick="selectDomainForAssignment('${d.id}')">
      <div class="di-color" style="background:${d.color}"></div>
      <div class="di-name">${d.name}</div>
      <div class="di-count">${d.hexIds.length}</div>
      <button class="di-del" onclick="event.stopPropagation();deleteDomain('${d.id}')">√ó</button>
    </div>
  `).join('');
}
function selectDomainForAssignment(domId){
  if(selectedDomainId===domId){selectedDomainId=null;}
  else{selectedDomainId=domId;selectedAgent=null;selectedMarker=null;selectedDriver=null;
    document.querySelectorAll('.agent-pal,.marker-pal').forEach(e=>e.classList.remove('selected'));renderDrivers();}
  renderDomainList();
  showToast(selectedDomainId?`Click hexes to add/remove from "${domainDefinitions.find(d=>d.id===domId)?.name}"`:'Domain mode off','hint');
}
function toggleHexDomain(hexId){
  if(!selectedDomainId)return;
  const dom=domainDefinitions.find(d=>d.id===selectedDomainId);
  if(!dom)return;
  // Check if hex is already in this domain BEFORE removing
  const wasInDomain = dom.hexIds.includes(hexId);
  // Remove hex from all domains
  domainDefinitions.forEach(d=>{d.hexIds=d.hexIds.filter(h=>h!==hexId);});
  // Toggle: only add if it wasn't already in the selected domain
  if(!wasInDomain) dom.hexIds.push(hexId);
  renderBoard();renderDomainList();scheduleAutoSave();
}
function createDomain(){
  const name=document.getElementById('newDomainName').value.trim();
  if(!name){showToast('Enter a domain name','warning');return;}
  const color=selectedDomainColor||DOMAIN_COLORS[domainDefinitions.length%DOMAIN_COLORS.length];
  domainDefinitions.push({id:'dom_'+Date.now(),name,color,hexIds:[]});
  closeModal('addDomainModal');
  document.getElementById('newDomainName').value='';
  selectedDomainColor=null;
  renderDomainList();scheduleAutoSave();
  addLog(`Created domain "${name}"`,'success');
}
function deleteDomain(domId){
  domainDefinitions=domainDefinitions.filter(d=>d.id!==domId);
  if(selectedDomainId===domId)selectedDomainId=null;
  renderBoard();renderDomainList();scheduleAutoSave();
}
function initDomainColorPicker(){
  const c=document.getElementById('domainColorPicker');
  if(!c)return;
  c.innerHTML=DOMAIN_COLORS.map(color=>`<div class="color-swatch" style="background:${color}" onclick="pickDomainColor('${color}',this)"></div>`).join('');
}
function pickDomainColor(color,el){
  selectedDomainColor=color;
  document.querySelectorAll('.color-swatch').forEach(s=>s.classList.remove('selected'));
  el.classList.add('selected');
}
// Convex hull + smooth boundary rendering
function convexHull(pts){
  pts.sort((a,b)=>a.x-b.x||a.y-b.y);
  if(pts.length<=2)return pts;
  const cross=(O,A,B)=>(A.x-O.x)*(B.y-O.y)-(A.y-O.y)*(B.x-O.x);
  const lower=[];
  for(const p of pts){while(lower.length>=2&&cross(lower[lower.length-2],lower[lower.length-1],p)<=0)lower.pop();lower.push(p);}
  const upper=[];
  for(const p of[...pts].reverse()){while(upper.length>=2&&cross(upper[upper.length-2],upper[upper.length-1],p)<=0)upper.pop();upper.push(p);}
  return[...lower.slice(0,-1),...upper.slice(0,-1)];
}
function getHexVertices(cx,cy,rw,rh){
  // Flat-top hex vertices
  return[{x:cx-rw*.5,y:cy-rh},{x:cx+rw*.5,y:cy-rh},{x:cx+rw,y:cy},{x:cx+rw*.5,y:cy+rh},{x:cx-rw*.5,y:cy+rh},{x:cx-rw,y:cy}];
}
function renderDomainBoundaries(){
  const svg=document.getElementById('domainsSvg');
  if(!svg)return;
  const grid=document.getElementById('honeycombGrid');
  // Move SVG inside honeycombGrid as last child so it paints above lane labels
  if(grid && svg.parentElement!==grid) grid.appendChild(svg);
  if(grid){svg.setAttribute('width',grid.scrollWidth);svg.setAttribute('height',grid.scrollHeight);svg.style.width=grid.scrollWidth+'px';svg.style.height=grid.scrollHeight+'px';}
  svg.innerHTML='';
  domainDefinitions.forEach(dom=>{
    if(dom.hexIds.length<1)return;
    const pts=[];
    dom.hexIds.forEach(hexId=>{
      const ck=getHexCoords(hexId);
      if(!ck)return;
      const[r,c]=ck.split(',').map(Number);
      const pos=hexPixelPosition(r,c);
      const cx=pos.x+HEX_W/2,cy=pos.y+HEX_H/2;
      pts.push(...getHexVertices(cx,cy,HEX_W/2+10,HEX_H/2+10));
    });
    if(pts.length<3)return;
    const hull=convexHull(pts);
    // Smooth path
    const n=hull.length;
    let d='';
    for(let i=0;i<n;i++){
      const cur=hull[i],nxt=hull[(i+1)%n];
      const mx=(cur.x+nxt.x)/2,my=(cur.y+nxt.y)/2;
      if(i===0){const prv=hull[n-1];d+=`M${(prv.x+cur.x)/2},${(prv.y+cur.y)/2}`;}
      d+=` Q${cur.x},${cur.y} ${mx},${my}`;
    }
    d+=' Z';
    const g=document.createElementNS('http://www.w3.org/2000/svg','g');
    const path=document.createElementNS('http://www.w3.org/2000/svg','path');
    path.setAttribute('d',d);
    path.setAttribute('fill','none');
    path.setAttribute('stroke',dom.color);path.setAttribute('stroke-width','2');
    path.setAttribute('stroke-opacity','0.7');path.setAttribute('stroke-dasharray','8,4');
    g.appendChild(path);
    // Label at centroid
    const cx=pts.reduce((s,p)=>s+p.x,0)/pts.length;
    const cy=pts.reduce((s,p)=>s+p.y,0)/pts.length;
    const lbl=document.createElementNS('http://www.w3.org/2000/svg','text');
    lbl.setAttribute('x',cx);lbl.setAttribute('y',cy);
    lbl.setAttribute('text-anchor','middle');lbl.setAttribute('dominant-baseline','middle');
    lbl.setAttribute('font-size','16');lbl.setAttribute('font-weight','700');
    lbl.setAttribute('fill',dom.color);lbl.setAttribute('opacity','0.15');
    lbl.textContent=dom.name;
    g.appendChild(lbl);
    svg.appendChild(g);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODALS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showModal(id){document.getElementById(id).classList.add('show');}
function closeModal(id){document.getElementById(id).classList.remove('show');}
document.querySelectorAll('.modal-overlay').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('show');}));
initDomainColorPicker();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INTRO CANVAS ‚Äî Floating hex particles
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(function initIntroCanvas() {
  const canvas = document.getElementById('introBgCanvas');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  let w, h, particles = [];
  const COLORS = ['rgba(74,144,217,.12)','rgba(123,94,167,.1)','rgba(56,178,160,.08)','rgba(232,148,58,.06)'];

  function resize() {
    w = canvas.width = window.innerWidth;
    h = canvas.height = window.innerHeight;
  }
  window.addEventListener('resize', resize);
  resize();

  function hexPath(ctx, x, y, r) {
    ctx.beginPath();
    for (let i = 0; i < 6; i++) {
      const a = Math.PI / 3 * i - Math.PI / 6;
      const px = x + r * Math.cos(a), py = y + r * Math.sin(a);
      i === 0 ? ctx.moveTo(px, py) : ctx.lineTo(px, py);
    }
    ctx.closePath();
  }

  // Create particles
  for (let i = 0; i < 30; i++) {
    particles.push({
      x: Math.random() * w,
      y: Math.random() * h,
      r: 8 + Math.random() * 28,
      vx: (Math.random() - 0.5) * 0.3,
      vy: (Math.random() - 0.5) * 0.2 - 0.1,
      rot: Math.random() * Math.PI,
      vr: (Math.random() - 0.5) * 0.003,
      color: COLORS[Math.floor(Math.random() * COLORS.length)],
      alpha: 0.3 + Math.random() * 0.5
    });
  }

  let animId;
  function draw() {
    ctx.clearRect(0, 0, w, h);
    particles.forEach(p => {
      p.x += p.vx; p.y += p.vy; p.rot += p.vr;
      if (p.x < -50) p.x = w + 50;
      if (p.x > w + 50) p.x = -50;
      if (p.y < -50) p.y = h + 50;
      if (p.y > h + 50) p.y = -50;

      ctx.save();
      ctx.translate(p.x, p.y);
      ctx.rotate(p.rot);
      ctx.globalAlpha = p.alpha;
      hexPath(ctx, 0, 0, p.r);
      ctx.fillStyle = p.color;
      ctx.fill();
      ctx.strokeStyle = p.color.replace(/[\d.]+\)$/, (parseFloat(p.color.match(/[\d.]+\)$/)[0]) * 2) + ')');
      ctx.lineWidth = 0.5;
      ctx.stroke();
      ctx.restore();
    });

    // Draw faint connecting lines between nearby particles
    for (let i = 0; i < particles.length; i++) {
      for (let j = i + 1; j < particles.length; j++) {
        const dx = particles[i].x - particles[j].x;
        const dy = particles[i].y - particles[j].y;
        const dist = Math.sqrt(dx * dx + dy * dy);
        if (dist < 200) {
          ctx.beginPath();
          ctx.moveTo(particles[i].x, particles[i].y);
          ctx.lineTo(particles[j].x, particles[j].y);
          ctx.strokeStyle = `rgba(74,144,217,${0.04 * (1 - dist / 200)})`;
          ctx.lineWidth = 0.5;
          ctx.stroke();
        }
      }
    }
    animId = requestAnimationFrame(draw);
  }
  draw();

  // Stop animation when intro is hidden
  const obs = new MutationObserver(() => {
    if (document.getElementById('introScreen')?.classList.contains('hidden')) {
      cancelAnimationFrame(animId);
      obs.disconnect();
    }
  });
  obs.observe(document.getElementById('introScreen'), { attributes: true, attributeFilter: ['class'] });
})();

// Load saved game count for "Continue" button
(async function initContinueBtn() {
  try {
    const companies = await api('GET','/companies');
    let total = 0;
    companies.forEach(co => total += (co.game_count || 0));
    const btn = document.getElementById('btnContinue');
    if (btn && total > 0) {
      btn.querySelector('.imb-desc').textContent = `${total} saved game${total!==1?'s':''}`;
    } else if (btn && total === 0) {
      btn.style.opacity = '.4';
      btn.style.pointerEvents = 'none';
      btn.querySelector('.imb-desc').textContent = 'No saved games yet';
    }
  } catch(e) { /* offline or no backend */ }
})();
</script>
</body>
</html>
